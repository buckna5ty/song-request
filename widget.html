<script>
  const $=s=>document.querySelector(s);
  const q=$('#q'), clearBtn=$('#clearBtn'), resultsEl=$('#results'), selectedBox=$('#selected'),
        selTitle=$('#selTitle'), selArtist=$('#selArtist'); let selCoverEl=$('#selCover');
  const wrapEl=document.getElementById('wrap');

  /* -------- Height reporting (v5 style) -------- */
  let rAF=null,t1=null,t2=null;
  function measure(){ return Math.ceil(wrapEl.getBoundingClientRect().height)+2; }
  function postH(){ const h=measure(); try{ parent.postMessage({action:'resize',height:h},'*'); }catch{} try{ top.postMessage({action:'resize',height:h},'*'); }catch{} }
  function sendHeight(){ if(rAF) cancelAnimationFrame(rAF); clearTimeout(t1); clearTimeout(t2);
    rAF=requestAnimationFrame(postH); t1=setTimeout(postH,60); t2=setTimeout(postH,200); }
  new ResizeObserver(sendHeight).observe(wrapEl);

  /* -------- JSONP + fetch search (same v5 flow) -------- */
  let debounce=null,lastTerm='',lastTag=null;
  function jsonp(url, cbParam='callback'){
    return new Promise((res,rej)=>{
      const cb='cb_'+Math.random().toString(36).slice(2);
      const sep=url.includes('?')?'&':'?';
      const src=`${url}${sep}${cbParam}=${cb}`;
      if(lastTag&&lastTag.parentNode) lastTag.parentNode.removeChild(lastTag);
      const s=document.createElement('script'); lastTag=s;
      const kill=setTimeout(()=>{cleanup(); rej(new Error('timeout'));},9000);
      function cleanup(){ clearTimeout(kill); try{delete window[cb];}catch{} s.parentNode&&s.parentNode.removeChild(s); }
      window[cb]=(data)=>{ cleanup(); res(data); sendHeight(); };
      s.onerror=()=>{ cleanup(); rej(new Error('jsonp error')); };
      s.src=src; document.body.appendChild(s);
    });
  }
  async function searchITunes(term){
    const data=await jsonp(`https://itunes.apple.com/search?term=${encodeURIComponent(term)}&entity=musicTrack&limit=8`,'callback');
    return (data?.results||[]).map(t=>({title:t.trackName, artist:t.artistName, cover:t.artworkUrl100||t.artworkUrl60, link:t.trackViewUrl, isrc:t.isrc||''}));
  }
  async function searchDeezer(term){
    const data=await jsonp(`https://api.deezer.com/search?q=${encodeURIComponent(term)}&limit=8&output=jsonp`,'callback');
    return (data?.data||[]).map(d=>({title:d.title, artist:d?.artist?.name||'', cover:d?.album?.cover_medium||d?.album?.cover||'', link:d.link||'', isrc:''}));
  }
  async function searchMB(term){
    const r=await fetch(`https://musicbrainz.org/ws/2/recording/?query=${encodeURIComponent(term)}&fmt=json&limit=8`,{
      headers:{'User-Agent':'DCE-SongRequest/1.0 (https://www.davidcharlesevents.com)'}, cache:'no-store'
    });
    if(!r.ok) throw new Error('mb http '+r.status);
    const data=await r.json(); sendHeight();
    return (data.recordings||[]).map(rec=>{
      const ac=rec['artist-credit']; const artist=ac&&ac[0]&&ac[0].name?ac[0].name:'';
      return {title:rec.title, artist, cover:'', link:'', isrc:''};
    });
  }

  /* -------- Spotify-first resolver (force Spotify domain) -------- */
  // Order of operations:
  // 1) If we have a source URL (Apple/Deezer), resolve via Odesli → Spotify track URL if possible.
  // 2) If we only have title/artist, hit iTunes to grab a URL, then Odesli → Spotify.
  // 3) If still no exact track, FORCE a Spotify Search URL (guaranteed open.spotify.com).
  async function resolveSpotify({link, title, artist}){
    if (link && link.includes('open.spotify.com/track')) return link;

    async function odesliFromUrl(srcUrl){
      try{
        const r=await fetch(`https://api.song.link/v1-alpha.1/links?url=${encodeURIComponent(srcUrl)}&userCountry=US`, {cache:'no-store'});
        if(!r.ok) return null;
        const data=await r.json();
        const byId=data?.entitiesByUniqueId||{};
        const spotifyId=data?.linksByPlatform?.spotify?.entityUniqueId;
        if(spotifyId && byId[spotifyId]?.url) return byId[spotifyId].url; // exact Spotify track URL
        return null;
      }catch{ return null; }
    }

    // Try Odesli with whatever link we already have
    if (link){
      const maybe=await odesliFromUrl(link);
      if (maybe) return maybe;
    }

    // No good link yet—try iTunes, then Odesli again
    if (title){
      try{
        const it=await searchITunes(`${title} ${artist||''}`.trim());
        if (it.length && it[0].link){
          const maybe=await odesliFromUrl(it[0].link);
          if (maybe) return maybe;
        }
      }catch{}
    }

    // Guaranteed Spotify fallback
    const q = title ? `${title} ${artist||''}`.trim() : (artist||'');
    return `https://open.spotify.com/search/${encodeURIComponent(q)}`;
  }

  /* -------- UI helpers (unchanged look/feel) -------- */
  function setStatus(m='',err=false){ const s=$('#status'); if(!s) return; s.textContent=m; s.style.color=err?'#b00020':'#616161'; sendHeight(); }
  function clearResults(){ resultsEl && (resultsEl.innerHTML=''); sendHeight(); }
  function showResults(){ resultsEl && resultsEl.classList.remove('hidden'); sendHeight(); }
  function hideResults(){ resultsEl && resultsEl.classList.add('hidden'); clearResults(); }
  function hideSelected(){
    selectedBox.style.display='none'; selectedBox.classList.remove('active');
    if(selCoverEl && selCoverEl.tagName.toLowerCase()==='img'){
      selCoverEl.outerHTML=`<div id="selCover" class="sel-cover" aria-hidden="true">♪</div>`;
      selCoverEl=document.getElementById('selCover');
    }
    selTitle.textContent=''; selArtist.textContent=''; sendHeight();
  }

  function render(list){
    clearResults(); if(!list.length){ setStatus('No results'); return; } setStatus('');
    showResults();
    list.forEach(({title,artist,cover,link})=>{
      const div=document.createElement('div'); div.className='item'; div.setAttribute('role','button'); div.setAttribute('tabindex','0');
      const coverHTML=cover?`<img class="cover" src="${cover}" alt="Album cover">`:`<div class="cover" aria-hidden="true">♪</div>`;
      div.innerHTML=`${coverHTML}<div class="info"><p class="ttl">${title||'Unknown Title'}</p><p class="art">${artist||'Unknown Artist'}</p></div>`;
      const choose=()=>useSong({title,artist,cover,link}, div);
      div.onclick=choose; div.onkeyup=e=>{ if(e.key==='Enter'||e.key===' ') choose(); };
      const img=div.querySelector('img.cover'); if(img) img.addEventListener('load', sendHeight, {once:true});
      resultsEl.appendChild(div);
    });
    sendHeight();
  }

  function showSelectedCard({title,artist,cover}){
    if(cover){
      const img=document.createElement('img'); img.src=cover; img.alt='Album cover'; img.className='sel-cover';
      img.addEventListener('load', sendHeight, {once:true});
      if(selCoverEl) selCoverEl.replaceWith(img); selCoverEl=img;
    }else{
      if(!selCoverEl || selCoverEl.tagName.toLowerCase()==='img'){
        const box=document.createElement('div'); box.id='selCover'; box.className='sel-cover'; box.setAttribute('aria-hidden','true'); box.textContent='♪';
        if(selCoverEl) selCoverEl.replaceWith(box); selCoverEl=box;
      }
    }
    selTitle.textContent=title||'Unknown Title'; selArtist.textContent=artist||'Unknown Artist';
    selectedBox.style.display='block'; selectedBox.classList.add('active'); sendHeight();
  }

  async function useSong({title,artist,cover,link}, el){
    document.querySelectorAll('.item').forEach(x=>x.classList.remove('selected')); el?.classList.add('selected');
    showSelectedCard({title,artist,cover,link});
    hideResults(); sendHeight();

    setStatus('Resolving Spotify link…');
    const spotifyLink = await resolveSpotify({link, title, artist});
    setStatus('');

    // Force Spotify domain 100%
    let finalLink = spotifyLink || '';
    if (!finalLink.includes('open.spotify.com')){
      const qStr = title ? `${title} ${artist||''}`.trim() : (artist||'');
      finalLink = `https://open.spotify.com/search/${encodeURIComponent(qStr)}`;
    }

    // Push fields back to parent (index.html → Jotform)
    const payload={action:'setFields', fields:{song_title:title||'', artist:artist||'', link:finalLink}};
    try{ parent.postMessage(payload, '*'); }catch{}
    try{ top.postMessage(payload, '*'); }catch{}
  }

  async function doSearch(term){
    if(!term){ setStatus(''); hideResults(); /* keep selected card */ sendHeight(); return; }
    setStatus('Searching…');
    try{ const a=await searchITunes(term); if(a.length){ render(a); return; } }catch(e){}
    try{ const b=await searchDeezer(term); if(b.length){ render(b); return; } }catch(e){}
    try{ const c=await searchMB(term); render(c); }catch(e){ setStatus('Search failed.',true); hideResults(); }
  }

  /* -------- events -------- */
  q.addEventListener('input', ()=>{
    const raw=q.value; clearBtn.style.display = raw.length>=1 ? 'flex' : 'none';
    const t=raw.trim(); if(t===lastTerm) return; lastTerm=t;
    clearTimeout(debounce); debounce=setTimeout(()=>doSearch(t), 260); sendHeight();
  });
  q.addEventListener('keydown', e=>{ if(e.key==='Enter'){ e.preventDefault(); doSearch(q.value.trim()); }});
  clearBtn.addEventListener('click', ()=>{
    q.value=''; lastTerm=''; q.focus({preventScroll:true});
    clearBtn.style.display='none'; setStatus(''); hideResults(); hideSelected(); sendHeight();
  });

  window.addEventListener('load', ()=>{
    try{ parent.postMessage({action:'ready'},'*'); }catch{}
    try{ top.postMessage({action:'ready'},'*'); }catch{}
    sendHeight();
  });
</script>

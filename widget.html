<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>DCE • Song Search Widget</title>
<style>
  :root{
    --ink:#111; --muted:#616161; --border:#e5e7eb;
    --ring:rgba(14,165,166,.25); --radius:8px;
    --teal:#0ea5a6; --field-w:640px; --bg:#fff;
  }
  html,body{
    margin:0;padding:0;background:#fff;color:var(--ink);
    font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji",sans-serif;
    overflow:hidden; /* avoids stray scroll height while resizing */
  }
  .wrap{padding:12px 12px 6px;}
  .field{display:flex;flex-direction:column;gap:6px;max-width:var(--field-w);margin:0 auto;position:relative;}

  .input{
    width:100%; height:48px; padding:0 38px 0 14px;
    border:1px solid var(--border); border-radius:var(--radius);
    background:var(--bg); box-sizing:border-box;
    font-size:16px; line-height:1.25; outline:none;
    appearance:none; -webkit-appearance:none; box-shadow:none;
  }
  .input:hover{ border-color: var(--border); box-shadow:none; }
  .input:focus{ border-color:var(--teal); box-shadow:0 0 0 4px var(--ring); }

  .clear{
    position:absolute; right:10px; top:50%; transform:translateY(-50%);
    width:28px; height:28px; border-radius:50%;
    display:none; align-items:center; justify-content:center;
    border:1px solid var(--border); background:#fafafa; color:#555;
    cursor:pointer; user-select:none; line-height:1; font-size:16px;
  }
  .clear:hover{ background:#f5f5f5; }
  .clear:active{ transform:translateY(-50%) scale(.98); }

  .status{max-width:var(--field-w);margin:6px auto 0;font-size:13px;color:var(--muted);min-height:18px;text-align:left;}
  .status:empty{margin:0;min-height:0;}

  .selected{
    max-width:var(--field-w); margin:6px auto 0;
    border:1px solid var(--border); border-radius:var(--radius);
    background:#fff; display:none;
    transition: box-shadow .15s ease, border-color .15s ease, background .15s ease;
  }
  .selected.active{ border-color: var(--teal); box-shadow: 0 0 0 4px var(--ring); background:#fff; }
  .sel-inner{ display:grid; grid-template-columns:72px 1fr; gap:12px; align-items:center; padding:10px; }
  .sel-cover{ width:72px;height:72px;border-radius:10px;object-fit:cover;background:#e9eef0;color:#7a8a8d;display:grid;place-items:center;font-size:14px; }
  .sel-title{ margin:0 0 2px; font-weight:700; font-size:16px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
  .sel-artist{ margin:0; color:#555; font-size:13px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }

  .results{max-width:var(--field-w);margin:6px auto 0;}
  .hidden{display:none !important;}
  .item{
    display:grid; grid-template-columns:56px 1fr; align-items:center; gap:12px;
    padding:10px; border:1px solid var(--border); border-radius:var(--radius);
    background:#fafafa; transition:background .15s,transform .06s,border-color .15s;
    cursor:pointer; margin-bottom:8px;
  }
  .item:last-child{ margin-bottom:6px; }
  .item:hover{background:#f5f5f5;} .item:active{transform:scale(.996);}
  .cover{width:56px;height:56px;border-radius:8px;object-fit:cover;background:#e9eef0;
    color:#7a8a8d;display:grid;place-items:center;font-size:12px;}
  .info{min-width:0;}
  .ttl{margin:0 0 2px;font-weight:700;font-size:15px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
  .art{margin:0;color:#555;font-size:13px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
</style>
</head>
<body>
  <div class="wrap">
    <div class="field">
      <input id="q" class="input" type="text" placeholder="start typing..." autocomplete="off" inputmode="search" />
      <button id="clearBtn" class="clear" type="button" aria-label="Clear search">×</button>
    </div>

    <div id="status" class="status"></div>

    <div id="selected" class="selected" aria-live="polite" aria-atomic="true">
      <div class="sel-inner">
        <div id="selCover" class="sel-cover" aria-hidden="true">♪</div>
        <div class="sel-text">
          <p id="selTitle" class="sel-title"></p>
          <p id="selArtist" class="sel-artist"></p>
        </div>
      </div>
    </div>

    <div id="results" class="results"></div>
  </div>

<script>
  const $ = (s)=>document.querySelector(s);
  const q=$('#q'), clearBtn=$('#clearBtn'), statusEl=$('#status'),
        resultsEl=$('#results'), selectedBox=$('#selected'),
        selTitle=$('#selTitle'), selArtist=$('#selArtist');
  let selCoverEl=$('#selCover');
  let debounce=null, lastTerm='', lastTag=null;

  /* ---------- Robust iframe height reporting ---------- */
  let heightRAF=null, heightTO1=null, heightTO2=null;
  function measureHeight(){
    return Math.max(
      document.body.scrollHeight, document.documentElement.scrollHeight,
      document.body.offsetHeight, document.documentElement.offsetHeight
    );
  }
  function postHeight(){
    const h = measureHeight();
    try { window.parent.postMessage({action:'resize', height:h}, '*'); } catch(_) {}
    try { window.top.postMessage({action:'resize', height:h}, '*'); } catch(_) {}
  }
  function broadcastHeight(){
    if (heightRAF) cancelAnimationFrame(heightRAF);
    clearTimeout(heightTO1); clearTimeout(heightTO2);
    heightRAF = requestAnimationFrame(postHeight);       // next frame
    heightTO1 = setTimeout(postHeight, 50);              // after small layout work
    heightTO2 = setTimeout(postHeight, 180);             // after images/fonts settle
  }

  new ResizeObserver(broadcastHeight).observe(document.documentElement);
  new MutationObserver(broadcastHeight).observe(document.body, {subtree:true, childList:true, attributes:true, characterData:true});

  /* ---------- UI helpers ---------- */
  function setStatus(m='',err=false){
    statusEl.textContent=m;
    statusEl.style.color=err?'#b00020':'#616161';
    broadcastHeight();
  }
  function clearResults(){ resultsEl.innerHTML=''; broadcastHeight(); }
  function hideResults(){ resultsEl.classList.add('hidden'); clearResults(); }
  function showResults(){ resultsEl.classList.remove('hidden'); broadcastHeight(); }

  function hideSelected(){
    selectedBox.style.display='none';
    selectedBox.classList.remove('active');
    if (selCoverEl && selCoverEl.tagName.toLowerCase() === 'img') {
      selCoverEl.outerHTML = `<div id="selCover" class="sel-cover" aria-hidden="true">♪</div>`;
      selCoverEl = document.getElementById('selCover');
    }
    selTitle.textContent=''; selArtist.textContent='';
    broadcastHeight();
  }

  /* ---------- JSONP helpers ---------- */
  function jsonp(url, cbParam='callback'){
    return new Promise((resolve, reject) => {
      const cb='cb_'+Math.random().toString(36).slice(2);
      const sep=url.includes('?')?'&':'?';
      const src=`${url}${sep}${cbParam}=${cb}`;
      if (lastTag && lastTag.parentNode) lastTag.parentNode.removeChild(lastTag);
      const s=document.createElement('script'); lastTag=s;
      const timer=setTimeout(()=>{cleanup();reject(new Error('timeout'));},9000);
      function cleanup(){ clearTimeout(timer); try{delete window[cb];}catch{} if(s.parentNode)s.parentNode.removeChild(s); }
      window[cb]=(data)=>{ cleanup(); resolve(data); broadcastHeight(); };
      s.onerror=()=>{ cleanup(); reject(new Error('jsonp error')); };
      s.src=src; document.body.appendChild(s);
    });
  }

  async function searchITunes(term){
    const data = await jsonp(`https://itunes.apple.com/search?term=${encodeURIComponent(term)}&entity=musicTrack&limit=8`, 'callback');
    return (data?.results || []).map(t => ({
      title:t.trackName, artist:t.artistName, cover:t.artworkUrl100 || t.artworkUrl60, link:t.trackViewUrl
    }));
  }
  async function searchDeezer(term){
    const data = await jsonp(`https://api.deezer.com/search?q=${encodeURIComponent(term)}&limit=8&output=jsonp`, 'callback');
    return (data?.data || []).map(d => ({
      title:d.title, artist:d?.artist?.name||'', cover:d?.album?.cover_medium||d?.album?.cover||'', link:d.link||''
    }));
  }
  async function searchMB(term){
    const r = await fetch(`https://musicbrainz.org/ws/2/recording/?query=${encodeURIComponent(term)}&fmt=json&limit=8`, {
      headers:{'User-Agent':'DCE-SongRequest/1.0 (https://www.davidcharlesevents.com)'},
      cache:'no-store'
    });
    if (!r.ok) throw new Error('mb http '+r.status);
    const data = await r.json();
    broadcastHeight();
    return (data.recordings || []).map(rec => {
      const ac = rec['artist-credit'];
      const artist = ac && ac[0] && ac[0].name ? ac[0].name : '';
      return { title: rec.title, artist, cover:'', link:`https://musicbrainz.org/recording/${rec.id}` };
    });
  }

  /* ---------- renderers ---------- */
  function render(list){
    clearResults();
    showResults();
    list.forEach(({title, artist, cover, link})=>{
      const div=document.createElement('div');
      div.className='item'; div.setAttribute('role','button'); div.setAttribute('tabindex','0');
      const imgHTML = cover ? `<img class="cover" src="${cover}" alt="Album cover">`
                            : `<div class="cover" aria-hidden="true">♪</div>`;
      div.innerHTML = `${imgHTML}<div class="info"><p class="ttl">${title||'Unknown Title'}</p><p class="art">${artist||('Unknown Artist')}</p></div>`;
      const select=()=>useSong({title,artist,cover,link}, div);
      div.onclick=select;
      div.onkeyup=(e)=>{ if(e.key==='Enter'||e.key===' ') select(); };
      const pic = div.querySelector('img.cover');
      if (pic) pic.addEventListener('load', broadcastHeight, {once:true});
      resultsEl.appendChild(div);
    });
    broadcastHeight();
  }

  function showSelectedCard({title, artist, cover, link}){
    if (cover) {
      const img = document.createElement('img');
      img.src = cover; img.alt = 'Album cover'; img.className = 'sel-cover';
      img.addEventListener('load', broadcastHeight, {once:true});
      if (selCoverEl) selCoverEl.replaceWith(img);
      selCoverEl = img;
    } else {
      if (!selCoverEl || selCoverEl.tagName.toLowerCase()==='img') {
        const box = document.createElement('div');
        box.id='selCover'; box.className='sel-cover'; box.setAttribute('aria-hidden','true'); box.textContent='♪';
        if (selCoverEl) selCoverEl.replaceWith(box);
        selCoverEl = box;
      }
    }
    selTitle.textContent  = title || 'Unknown Title';
    selArtist.textContent = artist || 'Unknown Artist';

    selectedBox.style.display = 'block';
    selectedBox.classList.add('active');
    broadcastHeight();
  }

  function useSong({title,artist,cover,link}, el){
    document.querySelectorAll('.item').forEach(x=>x.classList.remove('selected'));
    el?.classList.add('selected');

    try { window.parent.postMessage({ action:'setFields', fields:{ song_title:title||'', artist:artist||'', link:link||'' } }, '*'); } catch(_) {}
    try { window.top.postMessage({ action:'setFields', fields:{ song_title:title||'', artist:artist||'', link:link||'' } }, '*'); } catch(_) {}

    showSelectedCard({title,artist,cover,link});
    hideResults();                // collapse list
    broadcastHeight();            // ensure parent shrinks space
  }

  /* ---------- search flow ---------- */
  async function doSearch(term){
    if(!term){
      setStatus('');
      hideResults();
      // keep card until user clears with ×
      return;
    }
    setStatus('Searching…');
    try{ const a=await searchITunes(term); if(a.length){ setStatus(''); render(a); return; } }catch(e){}
    try{ const b=await searchDeezer(term); if(b.length){ setStatus(''); render(b); return; } }catch(e){}
    try{ const c=await searchMB(term); setStatus(c.length?'':'No results'); render(c); }
    catch(e){ setStatus('Search failed.', true); hideResults(); }
  }

  /* ---------- events ---------- */
  q.addEventListener('input', ()=>{
    const raw=q.value;
    clearBtn.style.display = raw.length>=1 ? 'flex' : 'none';
    const t = raw.trim();
    if(t===lastTerm) return; lastTerm=t;
    clearTimeout(debounce); debounce=setTimeout(()=>doSearch(t), 260);
    broadcastHeight();
  });

  q.addEventListener('keydown',(e)=>{
    if(e.key==='Enter'){ e.preventDefault(); doSearch(q.value.trim()); }
  });

  clearBtn.addEventListener('click', ()=>{
    q.value=''; lastTerm=''; q.focus({preventScroll:true});
    clearBtn.style.display='none';
    setStatus('');
    hideResults();
    hideSelected();
    broadcastHeight(); // ensure parent pulls Submit back up
  });

  window.addEventListener('load', ()=>{
    try { window.parent.postMessage({action:'ready'}, '*'); } catch(_) {}
    try { window.top.postMessage({action:'ready'}, '*'); } catch(_) {}
    broadcastHeight();
  });
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Song Request • David Charles Events</title>
<style>
  :root{
    --bg:#212121; --surface:#303030; --surface-2:#343434; --surface-2-hover:#3d3d3d;
    --ink:#f2f2f2; --muted:#bdbdbd; --border:#3a3a3a;
    --accent:#1dcec9; --focus:#e6e6e6; --ring:rgba(255,255,255,.22);
    --radius:12px; --field-max:640px;
  }
  @font-face{
    font-family:"Adventor";
    src:url("texgyreadventor-regular.otf") format("opentype");
    font-weight:400; font-style:normal; font-display:swap;
  }
  *{ box-sizing:border-box; }
  html,body{
    margin:0; background:var(--bg); color:var(--ink);
    font-family:"Adventor", system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
  }
  .wrap{ width:100%; max-width:960px; margin:0 auto; padding:16px 12px 48px; }
  .dce-logo{text-align:center; margin:14px 0 6px;}
  .dce-logo img{ max-width:min(220px,60vw); height:auto; }
  .app-title{
    text-align:center; margin:0 auto 26px; font-weight:800; letter-spacing:.06em; line-height:1.05;
    font-size:clamp(22px,6vw,38px); color:#fff;
  }
  .row{ width:100%; max-width:var(--field-max); margin:0 auto; }
  label{ display:block; font-size:14px; color:var(--muted); margin:10px 0 6px; }
  .field{ position:relative; }
  .search{ width:100%; height:52px; padding:0 42px 0 14px; border:1px solid var(--border); border-radius:var(--radius); background:var(--surface); color:var(--ink); font-size:16px; transition: box-shadow .12s ease, border-color .12s ease; }
  .search::placeholder{ color:#9e9e9e; }
  .search:focus{ border-color:var(--focus); box-shadow:0 0 0 3px var(--ring); }
  .clear{
    position:absolute; right:8px; top:50%; transform:translateY(-50%); width:32px;
    height:32px; border-radius:50%; border:1px solid var(--border); background:var(--surface-2); color:#fff;
    display:grid; place-items:center; cursor:pointer; opacity:.8;
  }
  .clear.show{ opacity:1; }
  .results{ margin-top:10px; border:1px solid var(--border); border-radius:12px; overflow:hidden; background:var(--surface); }
  .result{ display:grid; grid-template-columns:72px 1fr auto; gap:10px; padding:8px; align-items:center; border-bottom:1px solid var(--border); }
  .result:last-child{ border-bottom:none; }
  .art{ width:72px; height:72px; background:#2a2a2a; border-radius:10px; display:grid; place-items:center; overflow:hidden; }
  .art img{ width:100%; height:100%; object-fit:cover; display:block; }
  .meta .t{ margin:0; font-weight:700; font-size:15px; color:#fff; line-height:1.2; }
  .meta .a{ margin:3px 0 0; color:#dcdcdc; font-size:13px; }
  .pick{ background:#2a2a2a; border:1px solid #444; color:#fff; border-radius:10px; height:36px; padding:0 12px; cursor:pointer; }
  .selected{ display:none; margin-top:12px; }
  .selected.active{ display:block; }
  .sel-inner{ display:grid; grid-template-columns:84px 1fr; gap:10px; align-items:center; border:1px solid var(--border); background:var(--surface); border-radius:12px; padding:8px; }
  .sel-cover{ width:84px; height:84px; background:#2a2a2a; border-radius:10px; display:grid; place-items:center; }
  .sel-title{ margin:0; font-size:16px; font-weight:700; }
  .sel-artist{ margin:2px 0 0; font-size:13px; color:#dcdcdc; }
  .status{ min-height:18px; margin:10px 0 0; color:var(--muted); font-size:13px; }
  .actions{ width:100%; max-width:var(--field-max); margin:16px auto 0; display:flex; justify-content:center; }
  .btn{
    display:inline-flex; align-items:center; justify-content:center; gap:10px;
    padding:0 18px; height:46px; border-radius:12px; border:1px solid transparent; cursor:pointer;
    box-shadow:0 2px 0 rgba(0,0,0,.35), 0 8px 14px rgba(0,0,0,.15);
    background:var(--accent); color:#052911; font-weight:700; letter-spacing:.04em;
  }
  .btn .spin{ width:18px; height:18px; margin-right:10px; border-radius:50%; border:2px solid rgba(6,44,42,.4); border-top-color:#062c2a; animation:spin .8s linear infinite; display:none; }
  .btn.loading .spin{ display:inline-block; }
  @keyframes spin{ to{ transform:rotate(360deg);} }

  .ty-overlay{ position:fixed; inset:0; background:rgba(33,33,33,.98); display:none; align-items:center; justify-content:center; z-index:9999; backdrop-filter:blur(2px); }
  .ty-wrap{ text-align:center; padding:24px; max-width:92vw; color:#ffffff; }
  .ty-icon{ width:96px; height:96px; margin:0 auto 22px; display:grid; place-items:center; border-radius:50%; background:#1dcec9; box-shadow:0 6px 18px rgba(29,206,201,.35); color:#052911; font-size:52px; }
  .ty-title{ font-weight:800; font-size:clamp(28px,7.8vw,56px); line-height:1.05; margin:0 0 8px; color:#ffffff; }
  .ty-sub{ font:500 16px/1.5 "Adventor",system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif; color:#ffffff; margin:0;}

  @media (max-width:480px){
    .wrap{ padding-left:10px; padding-right:10px; }
    .sel-inner{ grid-template-columns:64px 1fr; } .sel-cover{ width:64px; height:64px; }
  }

  .dbg{ display:none; width:100%; max-width:var(--field-max); margin:10px auto 0; color:#a7f3d0; background:rgba(45,212,191,.12); border:1px solid rgba(45,212,191,.35); border-radius:999px; padding:6px 12px; font-size:12px; }
  .dbg.show{ display:block; }
</style>
</head>
<body>
<div class="wrap">
  <div class="dce-logo"><img src="assets/dce-logo.png" alt="David Charles Events" onerror="this.style.display='none'"></div>
  <div class="app-title">SONG REQUEST</div>
  <div id="debugPill" class="dbg"></div>

  <div class="row">
    <label for="yourName">What's your name?</label>
    <input type="text" id="yourName" autocomplete="name" placeholder="Your name" />
  </div>

  <div class="row" style="margin-top:20px;">
    <label for="q">Search Song, Artist or Lyrics</label>
    <div class="field">
      <input id="q" class="search" type="text" placeholder="Start typing…" autocomplete="off" inputmode="search" />
      <button id="clearBtn" class="clear" type="button" aria-label="Clear search">×</button>
    </div>
    <div id="results" class="results"></div>
    <div id="selected" class="selected" aria-live="polite" aria-atomic="true">
      <div class="sel-inner">
        <div id="selCover" class="sel-cover" aria-hidden="true">♪</div>
        <div class="sel-text">
          <p id="selTitle" class="sel-title"></p>
          <p id="selArtist" class="sel-artist"></p>
        </div>
      </div>
    </div>
    <div id="status" class="status"></div>
  </div>

  <input type="hidden" id="songTitle" />
  <input type="hidden" id="artist" />
  <input type="hidden" id="link" />

  <div class="actions">
    <button id="submitBtn" class="btn"><span class="spin" aria-hidden="true"></span><span class="btntxt">SUBMIT</span></button>
  </div>
</div>

<div class="ty-overlay" id="tyOverlay" role="dialog" aria-live="polite" aria-modal="true">
  <div class="ty-wrap">
    <div class="ty-icon">✓</div>
    <h1 class="ty-title">Got it!</h1>
    <p class="ty-sub">If it fits the flow, we’ll get it on. Let’s party.</p>
  </div>
</div>

<script>
const ENDPOINT_URL = 'https://script.google.com/macros/s/AKfycbxaN-0GQmvwy3G9GKD4hqZ1D6mjrIbBNDZZW-uGbuHIpiVTQ0BtOkmlQzSqjU6yjkmJ-g/exec';
const SPOTIFY_HELPER_URL = ''; // set later
const REDIRECT_DELAY_MS = 2200;

const urlp = new URLSearchParams(location.search);
const DEBUG = urlp.get('debug') === '1';
function saveEventCode(code){ try{ localStorage.setItem('dce_event', code); }catch{} }
function loadEventCode(){ try{ return localStorage.getItem('dce_event') || ''; }catch{ return ''; } }

let EVENT_CODE = (urlp.get('event') || '').trim();
if (!EVENT_CODE && document.referrer) {
  try{ const ref=new URL(document.referrer); const refEvent=ref.searchParams.get('event'); if(refEvent) EVENT_CODE=refEvent.trim(); }catch{}
}
if (!EVENT_CODE) { EVENT_CODE = loadEventCode(); }
if (EVENT_CODE) { saveEventCode(EVENT_CODE); }

const $=s=>document.querySelector(s);
const nameInput=$('#yourName'), q=$('#q'), clearBtn=$('#clearBtn'), resultsEl=$('#results'), selectedBox=$('#selected'), statusEl=$('#status'), submitBtn=$('#submitBtn'), selTitle=$('#selTitle'), selArtist=$('#selArtist'); let selCoverEl=$('#selCover');
const titleInput=$('#songTitle'), artistInput=$('#artist'), linkInput=$('#link');
const tyOverlay=$('#tyOverlay'); const btnTxt=document.querySelector('.btntxt'); const btnSpin=document.querySelector('.spin');

function showDebug(msg){
  const pill=document.getElementById('debugPill');
  if (!DEBUG) return;
  pill.classList.add('show');
  pill.textContent = msg || (EVENT_CODE ? `Event: ${EVENT_CODE}` : 'No event detected');
}
if (DEBUG) showDebug();

function setStatus(m='',err=false){ statusEl.textContent=m; statusEl.style.color=err?'#ffb4b4':'var(--muted)'; }
function clearResults(){ resultsEl.innerHTML=''; }
function showResults(){ resultsEl.style.display='block'; }
function hideResults(){ resultsEl.style.display='none'; clearResults(); }
function hideSelected(){
  selectedBox.style.display='none'; selectedBox.classList.remove('active');
  if(selCoverEl && selCoverEl.tagName.toLowerCase()==='img'){ selCoverEl.outerHTML=`<div id="selCover" class="sel-cover" aria-hidden="true">♪</div>`; selCoverEl=document.getElementById('selCover'); }
  selTitle.textContent=''; selArtist.textContent='';
}

/* JSONP */
function jsonp(url, params = {}){
  const qs=new URLSearchParams(params); const cb='cb_'+Math.random().toString(36).slice(2);
  qs.set('callback',cb); qs.set('t',Date.now());
  return new Promise((res,rej)=>{
    const s=document.createElement('script'); s.src=url+(url.includes('?')?'&':'?')+qs.toString();
    const kill=setTimeout(()=>{cleanup(); rej(new Error('timeout'));},9000);
    function cleanup(){clearTimeout(kill); try{delete window[cb];}catch{} s.remove();}
    window[cb]=(d)=>{cleanup(); res(d);}; s.onerror=()=>{cleanup(); rej(new Error('jsonp'));}; document.body.appendChild(s);
  });
}

/* Event config */
let EVENT_PROVIDER = 'apple';
let EVENT_MARKET = 'US';
let EXPLICIT_ALLOWED = true;

async function loadConfig(){
  if(!EVENT_CODE) return;
  try{
    const r = await jsonp(ENDPOINT_URL, {mode:'getEventConfig', event:EVENT_CODE});
    if(r && r.ok && r.config){
      EVENT_PROVIDER = (r.config.provider||'apple').toLowerCase();
      EVENT_MARKET = (r.config.market||'US').toUpperCase();
      EXPLICIT_ALLOWED = !!r.config.explicitAllowed;
      if (DEBUG) showDebug(`Event: ${EVENT_CODE} • ${EVENT_PROVIDER.toUpperCase()} • ${EVENT_MARKET} • Explicit ${EXPLICIT_ALLOWED?'ON':'OFF'}`);
      if (EVENT_PROVIDER==='spotify' && !SPOTIFY_HELPER_URL){
        setStatus('Admin note: Spotify helper not configured yet. We will add it next.', true);
      }
    }
  }catch{
    // leave defaults
  }
}

/* Apple Search */
async function searchITunes(term){
  try{
    const data = await jsonp('https://itunes.apple.com/search', {term, entity:'musicTrack', country:EVENT_MARKET, limit:12});
    let results = Array.isArray(data?.results) ? data.results : [];
    if(!EXPLICIT_ALLOWED){
      results = results.filter(x => String(x.trackExplicitness||'').toLowerCase()!=='explicit');
    }
    return results.map(x=>({
      provider:'apple',
      trackId: x.trackId,
      title: x.trackName,
      artist: x.artistName,
      album: x.collectionName || '',
      artwork: x.artworkUrl100 || x.artworkUrl60 || '',
      url: x.trackViewUrl,
      albumUrl: x.collectionViewUrl || '',
      artistUrl: x.artistViewUrl || ''
    }));
  }catch{ return []; }
}

/* Spotify Search (via helper) */
async function searchSpotify(term){
  if(!SPOTIFY_HELPER_URL) return [];
  try{
    const u = new URL(SPOTIFY_HELPER_URL);
    u.searchParams.set('q', term);
    u.searchParams.set('market', EVENT_MARKET);
    u.searchParams.set('limit', '12');
    const res = await fetch(u.toString(), {mode:'cors'});
    if(!res.ok) return [];
    const data = await res.json();
    let items = Array.isArray(data?.items) ? data.items : [];
    if(!EXPLICIT_ALLOWED){
      items = items.filter(x => !x.explicit);
    }
    return items.map(x=>({
      provider:'spotify',
      trackId: x.trackId,
      title: x.title,
      artist: x.artist,
      album: x.album,
      artwork: x.artwork || '',
      url: `https://open.spotify.com/track/${x.trackId}`,
      albumUrl: `https://open.spotify.com/album/${x.albumId}`,
      artistUrl: `https://open.spotify.com/artist/${x.artistId}`,
      uri: `spotify:track:${x.trackId}`
    }));
  }catch{ return []; }
}

/* Rendering */
function resultRow(item){
  const row=document.createElement('div'); row.className='result';
  const art=document.createElement('div'); art.className='art';
  if(item.artwork){ const img=new Image(); img.src=item.artwork; img.alt=''; art.appendChild(img); } else { art.textContent='♪'; }
  const meta=document.createElement('div'); meta.className='meta';
  const t=document.createElement('p'); t.className='t'; t.textContent=item.title||'';
  const a=document.createElement('p'); a.className='a'; a.textContent=item.artist||'';
  meta.append(t,a);
  const btn=document.createElement('button'); btn.className='pick'; btn.textContent='Select';
  btn.onclick=()=>{
    titleInput.value=item.title||'';
    artistInput.value=item.artist||'';
    linkInput.value=item.url||'';
    selTitle.textContent=item.title||''; selArtist.textContent=item.artist||'';
    selectedBox.style.display='block'; selectedBox.classList.add('active');
    if(item.artwork){
      const img=new Image(); img.src=item.artwork; img.alt=''; img.style.width='100%'; img.style.height='100%'; img.style.objectFit='cover';
      document.getElementById('selCover').replaceWith(img); img.id='selCover'; selCoverEl=img;
    }else{
      if(selCoverEl && selCoverEl.tagName.toLowerCase()==='img'){ selCoverEl.outerHTML=`<div id="selCover" class="sel-cover" aria-hidden="true">♪</div>`; selCoverEl=document.getElementById('selCover'); }
    }
    setStatus('Ready to submit.');
  };
  row.append(art, meta, btn);
  return row;
}

function render(list){
  clearResults();
  for(const item of list){ resultsEl.appendChild(resultRow(item)); }
  showResults();
}

/* Search handlers */
let lastTerm='';
q.addEventListener('input', ()=>{
  const t=q.value.trim();
  clearBtn.classList.toggle('show', !!t);
  if(!t){ setStatus(''); hideResults(); hideSelected(); return; }
  if(t===lastTerm) return;
  lastTerm=t;
  setStatus('Searching…');
  window.clearTimeout(q._timer);
  q._timer=setTimeout(async ()=>{
    let list=[];
    if (EVENT_PROVIDER==='apple'){
      list = await searchITunes(t);
    } else if (EVENT_PROVIDER==='spotify'){
      list = await searchSpotify(t);
      if (!SPOTIFY_HELPER_URL && list.length===0){
        setStatus('Spotify not configured yet — we’ll add your helper next.', true);
      }
    } else {
      list = [];
    }
    if(list.length) render(list); else { setStatus('No results'); hideResults(); }
  }, 240);
});

q.addEventListener('keydown', e=>{
  if(e.key==='Enter'){
    e.preventDefault();
    const t=q.value.trim(); if(!t) return;
    setStatus('Searching…');
    (async()=>{
      let list=[];
      if (EVENT_PROVIDER==='apple'){
        list = await searchITunes(t);
      } else if (EVENT_PROVIDER==='spotify'){
        list = await searchSpotify(t);
        if (!SPOTIFY_HELPER_URL && list.length===0){
          setStatus('Spotify not configured yet — we’ll add your helper next.', true);
        }
      }
      if(list.length) render(list); else { setStatus('No results'); hideResults(); }
    })();
  }
});

clearBtn.addEventListener('click', ()=>{
  q.value=''; lastTerm=''; clearBtn.classList.remove('show'); setStatus(''); hideResults(); hideSelected();
  titleInput.value=''; artistInput.value=''; linkInput.value=''; q.focus({preventScroll:true});
});

/* Submit */
function openThankYou(){ tyOverlay.style.display='flex'; }
function setBtnLoading(on){
  if(on){ submitBtn.classList.add('loading'); submitBtn.setAttribute('disabled','disabled'); btnTxt.textContent='SUBMITTING…'; }
  else{ submitBtn.classList.remove('loading'); submitBtn.removeAttribute('disabled'); btnTxt.textContent='SUBMIT'; }
}
function redirectBack(){
  const base=location.origin+location.pathname; const params=new URLSearchParams(); if (EVENT_CODE) params.set('event',EVENT_CODE);
  const next=params.toString()?`${base}?${params.toString()}`:base; location.replace(next);
}
function writeRequest(){
  const nameVal=(nameInput.value||'').trim(), titleVal=(titleInput.value||'').trim(), artistVal=(artistInput.value||'').trim(), linkVal=(linkInput.value||'').trim();
  if (!titleVal && !artistVal){ setStatus('Pick a song first.'); q.focus(); return; }
  if (!EVENT_CODE){ setStatus('No event selected. Re-scan the QR and try again.', true); return; }
  saveEventCode(EVENT_CODE);
  setBtnLoading(true); openThankYou();
  const qs=new URLSearchParams({ mode:'write', event:EVENT_CODE, name:nameVal, song_title:titleVal, artist:artistVal, link:linkVal, ua:navigator.userAgent, referer:document.referrer||location.href });
  const cb='cb_'+Math.random().toString(36).slice(2); window[cb]=(data)=>{ try{ delete window[cb]; }catch{} };
  const s=document.createElement('script'); s.src=ENDPOINT_URL+'?'+qs.toString()+'&callback='+cb+'&t='+Date.now(); s.onerror=()=>{ try{ delete window_

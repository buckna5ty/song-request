<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Song Request • David Charles Events</title>
<style>
  :root{ --field-w:640px; --teal:#0ea5a6; --ring:rgba(14,165,166,.25); --border:#e5e7eb; --radius:8px; --bg:#fff; --ink:#111; }
  @font-face{ font-family:"TexGyreAdventorBold"; src:url("texgyreadventor-bold.otf") format("opentype"); font-weight:700; font-style:normal; font-display:swap; }
  html,body{ margin:0; background:#f3f2ff; color:var(--ink); font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif; }
  .wrap{ max-width:960px; margin:0 auto; padding:16px 12px 48px; }
  .dce-logo{text-align:center; margin:18px 0 4px;}
  .dce-logo img{ max-width:220px; height:auto; }
  .app-title{ text-align:center; margin:0 auto 12px; font-family:"TexGyreAdventorBold", Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; letter-spacing:.06em; line-height:1.05; font-size:clamp(22px,6vw,38px); color:#111; }
  label{ display:block; font-size:14px; color:#475569; margin:10px 0 6px; }
  input[type="text"]{
    width:100%; height:48px; padding:0 14px; border:1px solid var(--border); border-radius:var(--radius); background:var(--bg);
    font-size:16px; outline:none;
  }
  input[type="text"]:focus{ border-color:var(--teal); box-shadow:0 0 0 4px var(--ring); }
  .row{ max-width:var(--field-w); margin:0 auto; }
  #searchWidget{ width:100%; border:0; height:70px; display:block; transition:height .2s ease; }
  .btn{ height:46px; padding:0 20px; border:1px solid #111; background:#111; color:#fff; border-radius:10px; cursor:pointer; font-weight:700; letter-spacing:.03em; }
  .btn:hover{ filter:brightness(.95); }
  .ty-overlay{ position:fixed; inset:0; background:#fff; display:none; align-items:center; justify-content:center; z-index:9999; }
  .ty-wrap{ text-align:center; padding:24px; max-width:92vw; }
  .ty-icon{ width:96px; height:96px; margin:0 auto 22px; display:grid; place-items:center; border-radius:50%; background:#22c55e; box-shadow:0 6px 18px rgba(34,197,94,.35); color:#fff; font-size:48px; }
  .ty-title{ font-family:"TexGyreAdventorBold", Inter, system-ui; font-size:clamp(28px,7.8vw,56px); line-height:1.05; margin:0 0 8px; color:#0f172a;}
  .ty-sub{ font:500 16px/1.5 Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif; color:#64748b; margin:0;}
</style>
</head>
<body>
<div class="wrap">
  <div class="dce-logo"><img src="assets/client-logo.png" alt="David Charles Events" onerror="this.style.display='none'"></div>
  <div class="app-title">SONG REQUEST</div>

  <div class="row">
    <label for="yourName">What's your name?</label>
    <input type="text" id="yourName" autocomplete="name" />
  </div>

  <div class="row" style="margin-top:8px;">
    <label for="searchWidget">Search Song, Artist or Lyrics</label>
    <iframe id="searchWidget" src="widget.html?v=7" title="Song Search"></iframe>
  </div>

  <!-- Hidden fields that the widget fills via postMessage -->
  <input type="hidden" id="songTitle" />
  <input type="hidden" id="artist" />
  <input type="hidden" id="link" />

  <div class="row" style="margin-top:10px;">
    <button id="submitBtn" class="btn">Submit</button>
  </div>
</div>

<!-- Thank You -->
<div class="ty-overlay" id="tyOverlay" role="dialog" aria-live="polite" aria-modal="true">
  <div class="ty-wrap">
    <div class="ty-icon">✓</div>
    <h1 class="ty-title">Got it!</h1>
    <p class="ty-sub">If it fits the flow, we’ll get it on. Let’s party.</p>
  </div>
</div>

<script>
/* ---------------- Config ---------------- */
const ENDPOINT_URL = 'https://script.google.com/macros/s/AKfycbxZ9ylpDohWZnp1Krsn9THEPEciFv68uBB5unr0a41qNTesaOBkCWsQOeiucY4asIYH5A/exec';

/* ---------------- Event code capture ----------------
   We prefer ?event= from our own URL. If missing (e.g., page is embedded at
   https://www.davidcharlesevents.com/song-request?event=CODE and THEY iframe us
   without forwarding the query), we fall back to parsing document.referrer. */
const urlp = new URLSearchParams(location.search);
let EVENT_CODE = (urlp.get('event') || '').trim();

if (!EVENT_CODE && document.referrer) {
  try {
    const ref = new URL(document.referrer);
    const refEvent = ref.searchParams.get('event');
    if (refEvent) EVENT_CODE = refEvent.trim();
  } catch {}
}

/* ---------------- DOM ---------------- */
const byId = id => document.getElementById(id);
const nameInput  = byId('yourName');
const titleInput = byId('songTitle');
const artistInput= byId('artist');
const linkInput  = byId('link');
const submitBtn  = byId('submitBtn');
const searchWidget = byId('searchWidget');
const tyOverlay  = byId('tyOverlay');

/* ---------------- Widget messaging ---------------- */
function setHiddenField(key, val){
  if (key==='song_title') titleInput.value = val || '';
  if (key==='artist')     artistInput.value = val || '';
  if (key==='link')       linkInput.value = val || '';
}
function clearHiddenFields(){
  titleInput.value = '';
  artistInput.value = '';
  linkInput.value = '';
}
window.addEventListener('message', (e)=>{
  const msg = e.data; if (!msg || !msg.action) return;
  if (msg.action === 'setFields' && msg.fields) {
    const {song_title, artist, link} = msg.fields;
    if (song_title !== undefined) setHiddenField('song_title', song_title);
    if (artist     !== undefined) setHiddenField('artist', artist);
    if (link       !== undefined) setHiddenField('link', link);
  }
  if (msg.action === 'clearSelected') {
    clearHiddenFields();
  }
  if (msg.action === 'resize' && typeof msg.height === 'number') {
    const h = Math.max(60, Math.ceil(msg.height+2));
    searchWidget.style.height = h + 'px';
  }
});

/* ---------------- Submit ---------------- */
function openThankYou(){ tyOverlay.style.display='flex'; }
function writeRequest(){
  const nameVal = (nameInput.value || '').trim();
  const titleVal= (titleInput.value || '').trim();
  const artistVal=(artistInput.value || '').trim();
  const linkVal = (linkInput.value || '').trim();

  // Require a title + artist (prevents blank submits when the widget wasn't used)
  if (!titleVal && !artistVal) { nameInput.focus(); return; }

  const qs = new URLSearchParams({
    mode: 'write',
    event: EVENT_CODE || '',   // may be empty if truly no event param
    name: nameVal,
    song_title: titleVal,
    artist: artistVal,
    link: linkVal,
    ua: navigator.userAgent,
    referer: document.referrer || location.href
  });

  // JSONP submit - create script tag
  const cb = 'cb_' + Math.random().toString(36).slice(2);
  window[cb] = (data)=>{ try{ delete window[cb]; }catch{} openThankYou(); };
  const s = document.createElement('script');
  s.src = ENDPOINT_URL + '?' + qs.toString() + '&callback=' + cb;
  s.onerror = ()=>{ try{ delete window[cb]; }catch{} openThankYou(); };
  document.body.appendChild(s);
}
submitBtn.addEventListener('click', writeRequest);

/* Focus on load (optional) */
window.addEventListener('load', ()=>{ nameInput.focus({preventScroll:true}); });
</script>
</body>
</html>

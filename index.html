<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SONG REQUEST</title>
  <style>
    :root {
      --bg: #0f1115;
      --card: #161a22;
      --muted: #7e8aa3;
      --text: #e7ecf7;
      --accent: #e869ff;
      --accent-2: #38d6c6;
      --border: #242b38;
      --ok: #39d98a;
      --warn: #ffb020;
      --err: #ff6b6b;
      --shadow: 0 10px 30px rgba(0,0,0,.35), 0 2px 6px rgba(0,0,0,.25);
      --radius: 18px;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji";
      background: radial-gradient(1200px 1200px at 20% -10%, rgba(232,105,255,.15), transparent 60%),
                  radial-gradient(1200px 1200px at 120% 10%, rgba(56,214,198,.12), transparent 60%),
                  var(--bg);
      color: var(--text);
      min-height: 100svh;
      display: grid; place-items: start center;
      padding: 28px 16px 80px;
    }
    .wrap { width: 100%; max-width: 980px; }
    header {
      display: flex; align-items: center; justify-content: space-between; gap: 12px;
      margin-bottom: 18px;
    }
    h1 {
      margin: 0; font-size: clamp(24px, 4vw, 36px); letter-spacing: .05em;
      background: linear-gradient(90deg, var(--accent), var(--accent-2));
      -webkit-background-clip: text; background-clip: text; color: transparent;
      font-weight: 800;
    }
    .card {
      background: linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,0)) , var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 18px;
    }
    .grid {
      display: grid; gap: 16px;
      grid-template-columns: 1fr;
    }
    @media (min-width: 880px) {
      .grid { grid-template-columns: 1.1fr 1.4fr; }
    }
    label { display: block; font-size: 13px; color: var(--muted); margin: 10px 0 6px; }
    input[type="text"] {
      width: 100%; padding: 12px 14px; border-radius: 12px;
      background: #0e1117; border: 1px solid var(--border); color: var(--text);
      outline: none; transition: border .15s ease, box-shadow .15s ease;
    }
    input[type="text"]:focus {
      border-color: #3a4358; box-shadow: 0 0 0 3px rgba(232,105,255,.15);
    }
    .btn {
      display: inline-flex; align-items: center; justify-content: center; gap: 8px;
      padding: 12px 16px; border-radius: 12px; font-weight: 700; letter-spacing: .02em;
      border: 1px solid var(--border); background: #11151d; color: var(--text);
      cursor: pointer; transition: transform .06s ease, opacity .2s ease, border .15s ease;
      user-select: none; text-decoration: none;
    }
    .btn:hover { border-color: #3a4358; }
    .btn:active { transform: translateY(1px); }
    .btn.primary { background: linear-gradient(90deg, var(--accent), var(--accent-2)); color: #0b0d12; border: none; }
    .btn.ghost { background: transparent; }
    .btn.small { padding: 8px 10px; font-size: 13px; border-radius: 10px; }
    .btn[disabled] { opacity: .5; cursor: not-allowed; }
    .row { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
    .results {
      display: grid; grid-template-columns: 1fr; gap: 10px; max-height: 480px; overflow: auto; padding-right: 2px;
    }
    @media (min-width: 560px) {
      .results { grid-template-columns: 1fr 1fr; }
    }
    .result {
      display: grid; grid-template-columns: 64px 1fr; gap: 12px; align-items: center;
      padding: 10px; border: 1px solid var(--border); border-radius: 12px; background: #0d1117;
    }
    .result img { width: 64px; height: 64px; border-radius: 10px; object-fit: cover; }
    .result h4 { margin: 0 0 4px; font-size: 14px; }
    .result p { margin: 0; font-size: 12px; color: var(--muted); }
    .pill { font-size: 12px; padding: 3px 8px; border-radius: 999px; border: 1px dashed #2a3344; color: var(--muted); }
    .selected {
      padding: 12px; border: 1px dashed #2d3546; border-radius: 12px; background: #0d1117;
      display: grid; grid-template-columns: auto 1fr; gap: 12px; align-items: center;
    }
    .selected img { width: 56px; height: 56px; border-radius: 10px; object-fit: cover; }
    .muted { color: var(--muted); }
    .list { display: grid; gap: 10px; max-height: 360px; overflow: auto; }
    .list-item {
      padding: 10px 12px; border: 1px solid var(--border); border-radius: 12px; background: #0d1117;
      display: grid; grid-template-columns: 1fr auto; align-items: center; gap: 12px;
    }
    .list-item small { color: var(--muted); }
    .empty {
      padding: 20px; text-align: center; border: 1px dashed #2d3546; border-radius: 12px; color: var(--muted);
    }
    .divider { height: 1px; background: var(--border); margin: 10px 0; }
    .badge { display: inline-flex; gap: 6px; align-items: center; padding: 6px 10px; border-radius: 999px; background: #101520; border: 1px solid var(--border); color: var(--muted); font-size: 12px; }
    .toast {
      position: fixed; inset: auto 16px 16px auto; background: #101520; color: var(--text);
      border: 1px solid var(--border); border-left: 6px solid var(--ok); padding: 12px 14px; border-radius: 14px;
      box-shadow: var(--shadow); display: none; z-index: 20;
    }
    .sr-only { position: absolute; left: -9999px; top: auto; width: 1px; height: 1px; overflow: hidden; }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>SONG REQUEST</h1>
      <div class="row">
        <button id="toggleViewBtn" class="btn ghost small" title="Switch between Requester / DJ views">Toggle DJ View</button>
        <a id="exportCsvBtn" class="btn ghost small" download="song-requests.csv" href="#">Export CSV</a>
      </div>
    </header>

    <div class="grid">
      <!-- Left: Request form -->
      <section class="card" aria-labelledby="requestFormTitle">
        <div class="row" style="justify-content: space-between;">
          <div class="badge"><span>Powered by Apple Music Search API</span></div>
          <span id="webhookBadge" class="pill" title="Optional webhook is off">Webhook: OFF</span>
        </div>

        <h2 id="requestFormTitle" class="sr-only">Request a Song</h2>

        <label for="nameInput">Your name</label>
        <input id="nameInput" type="text" placeholder="e.g., Jamie / Wedding Couple / Table 12" autocomplete="name" />

        <label for="searchInput">Find your song</label>
        <input id="searchInput" type="text" placeholder="Type song title or artist…" autocomplete="off" />
        <div class="muted" style="margin-top:6px;font-size:12px;">
          Tip: try “Artist – Song Title” for laser-accurate matches.
        </div>

        <div id="results" class="results" style="margin-top:12px;" aria-live="polite"></div>

        <div id="selectedBox" class="selected" style="margin-top:12px; display:none;">
          <img id="selectedArt" alt="">
          <div>
            <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap;">
              <strong id="selectedTitle"></strong>
              <span class="pill" id="selectedArtist"></span>
            </div>
            <div class="row" style="margin-top:8px;">
              <a id="appleLink" class="btn small" target="_blank" rel="noopener">Apple Music</a>
              <audio id="preview" controls preload="none" style="height:28px;"></audio>
              <button id="clearSelectionBtn" class="btn small">Clear</button>
            </div>
          </div>
        </div>

        <div class="divider"></div>

        <div class="row" style="justify-content: space-between;">
          <span class="muted" style="font-size:12px;">We’ll do our best to play it!</span>
          <button id="submitBtn" class="btn primary" disabled>Submit Request</button>
        </div>
      </section>

      <!-- Right: Requests / DJ View -->
      <section class="card" aria-labelledby="djListTitle">
        <h3 id="djListTitle" style="margin:0 0 10px;font-size:16px;">Requests</h3>
        <div class="row" style="gap:8px; flex-wrap: wrap; margin-bottom: 6px;">
          <span class="pill" id="countPill">0 total</span>
          <button id="clearAllBtn" class="btn small" title="Clears local list only">Clear Local</button>
        </div>
        <div id="requestList" class="list"></div>
        <div id="emptyState" class="empty">No requests yet.</div>
      </section>
    </div>
  </div>

  <div id="toast" class="toast" role="status" aria-live="polite">Request received—thank you!</div>

  <script>
  ;(() => {
    // =========================
    // CONFIG
    // =========================
    // Optional webhook (POST JSON) for persistence beyond localStorage.
    // Example target: a Google Apps Script Web App, Supabase, tiny Node endpoint, etc.
    // Leave empty "" to disable.
    const WEBHOOK_URL = ""; // e.g., "https://script.google.com/macros/s/XXXX/exec"
    const WEBHOOK_METHOD = "POST";
    const WEBHOOK_BADGE = document.getElementById("webhookBadge");

    // UI refs
    const nameInput = document.getElementById("nameInput");
    const searchInput = document.getElementById("searchInput");
    const resultsEl = document.getElementById("results");
    const selectedBox = document.getElementById("selectedBox");
    const selectedArt = document.getElementById("selectedArt");
    const selectedTitle = document.getElementById("selectedTitle");
    const selectedArtist = document.getElementById("selectedArtist");
    const appleLink = document.getElementById("appleLink");
    const preview = document.getElementById("preview");
    const clearSelectionBtn = document.getElementById("clearSelectionBtn");
    const submitBtn = document.getElementById("submitBtn");
    const requestList = document.getElementById("requestList");
    const emptyState = document.getElementById("emptyState");
    const toggleViewBtn = document.getElementById("toggleViewBtn");
    const exportCsvBtn = document.getElementById("exportCsvBtn");
    const clearAllBtn = document.getElementById("clearAllBtn");
    const countPill = document.getElementById("countPill");
    const toast = document.getElementById("toast");

    // State
    let state = {
      selected: null, // currently selected track from search results
      view: "guest",  // "guest" or "dj" (just affects list sorting/filtering)
      requests: loadRequests()
    };

    // Show webhook badge
    WEBHOOK_BADGE.textContent = `Webhook: ${WEBHOOK_URL ? "ON" : "OFF"}`;
    WEBHOOK_BADGE.style.borderColor = WEBHOOK_URL ? "rgba(56,214,198,.65)" : "#2a3344";
    WEBHOOK_BADGE.style.color = WEBHOOK_URL ? "var(--accent-2)" : "var(--muted)";

    // =========================
    // Helpers
    // =========================
    function saveRequests() {
      try { localStorage.setItem("song_requests_v1", JSON.stringify(state.requests)); }
      catch(e) { console.warn("localStorage save failed", e); }
      renderList();
    }
    function loadRequests() {
      try {
        const raw = localStorage.getItem("song_requests_v1");
        return raw ? JSON.parse(raw) : [];
      } catch(e) {
        console.warn("localStorage parse failed", e);
        return [];
      }
    }
    function uid() {
      return Math.random().toString(36).slice(2) + Date.now().toString(36);
    }
    function fmtTime(ts) {
      const d = new Date(ts);
      return d.toLocaleString();
    }
    function showToast(msg = "Saved!") {
      toast.textContent = msg;
      toast.style.display = "block";
      clearTimeout(showToast._t);
      showToast._t = setTimeout(() => toast.style.display = "none", 2300);
    }
    function debounce(fn, ms=350) {
      let t; return (...args) => { clearTimeout(t); t = setTimeout(() => fn(...args), ms); };
    }
    function toCsv(rows) {
      const header = ["timestamp","name","title","artist","apple_link","preview_url","artwork","track_id"];
      const lines = [header.join(",")];
      for (const r of rows) {
        const vals = [
          JSON.stringify(new Date(r.timestamp).toISOString()),
          JSON.stringify(r.name),
          JSON.stringify(r.title),
          JSON.stringify(r.artist),
          JSON.stringify(r.apple_link || ""),
          JSON.stringify(r.preview_url || ""),
          JSON.stringify(r.artwork || ""),
          JSON.stringify(r.track_id || "")
        ];
        lines.push(vals.join(","));
      }
      return lines.join("\r\n");
    }

    // =========================
    // Apple Music (iTunes) Search
    // =========================
    async function searchApple(term) {
      if (!term || term.trim().length < 2) { resultsEl.innerHTML = ""; return; }
      const url = new URL("https://itunes.apple.com/search");
      url.searchParams.set("term", term);
      url.searchParams.set("entity", "song");
      url.searchParams.set("limit", "24");

      resultsEl.innerHTML = `<div class="muted">Searching…</div>`;
      try {
        const res = await fetch(url.toString());
        if (!res.ok) throw new Error("Search failed");
        const data = await res.json();
        renderResults(data.results || []);
      } catch (e) {
        resultsEl.innerHTML = `<div class="muted">Error searching Apple Music.</div>`;
        console.error(e);
      }
    }

    function renderResults(items) {
      if (!items.length) {
        resultsEl.innerHTML = `<div class="muted">No matches found. Try another search.</div>`;
        return;
      }
      resultsEl.innerHTML = "";
      for (const it of items) {
        const art = it.artworkUrl100?.replace("100x100bb", "200x200bb") || "";
        const el = document.createElement("div");
        el.className = "result";
        el.innerHTML = `
          <img src="${art}" alt="">
          <div>
            <h4>${it.trackName || "Unknown Title"}</h4>
            <p>${it.artistName || "Unknown Artist"}</p>
            <div class="row" style="margin-top:8px;">
              <button class="btn small selectBtn">Select</button>
              ${it.previewUrl ? `<audio controls preload="none" style="height:28px;"><source src="${it.previewUrl}"></audio>` : ""}
              ${it.trackViewUrl ? `<a class="btn small" href="${it.trackViewUrl}" target="_blank" rel="noopener">Apple Music</a>` : ""}
            </div>
          </div>
        `;
        el.querySelector(".selectBtn").addEventListener("click", () => {
          state.selected = {
            track_id: it.trackId,
            title: it.trackName,
            artist: it.artistName,
            apple_link: it.trackViewUrl || "",
            preview_url: it.previewUrl || "",
            artwork: art
          };
          updateSelectedBox();
        });
        resultsEl.appendChild(el);
      }
    }

    function updateSelectedBox() {
      if (!state.selected) { selectedBox.style.display = "none"; submitBtn.disabled = true; return; }
      selectedArt.src = state.selected.artwork || "";
      selectedArt.alt = `${state.selected.title} cover`;
      selectedTitle.textContent = state.selected.title;
      selectedArtist.textContent = state.selected.artist;
      appleLink.href = state.selected.apple_link || "#";
      appleLink.setAttribute("aria-disabled", state.selected.apple_link ? "false" : "true");
      preview.src = state.selected.preview_url || "";
      selectedBox.style.display = "grid";
      validateSubmit();
    }

    // =========================
    // Submit
    // =========================
    function validateSubmit() {
      const ok = !!(nameInput.value.trim() && state.selected);
      submitBtn.disabled = !ok;
    }

    async function submitRequest() {
      const name = nameInput.value.trim();
      if (!name || !state.selected) return;
      const payload = {
        id: uid(),
        timestamp: Date.now(),
        name,
        ...state.selected
      };

      // Add locally
      state.requests.unshift(payload);
      saveRequests();
      showToast("Request received—thank you!");

      // Attempt webhook
      if (WEBHOOK_URL) {
        try {
          await fetch(WEBHOOK_URL, {
            method: WEBHOOK_METHOD,
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload)
          });
        } catch (e) {
          console.warn("Webhook failed (local saved ok):", e);
          showToast("Saved locally. (Webhook offline)");
        }
      }

      // Reset selection but keep the name for multiple requests
      state.selected = null;
      updateSelectedBox();
    }

    // =========================
    // DJ View / List
    // =========================
    function renderList() {
      const rows = state.requests.slice(); // copy
      countPill.textContent = `${rows.length} total`;
      if (!rows.length) {
        requestList.innerHTML = "";
        emptyState.style.display = "block";
        return;
      }
      emptyState.style.display = "none";
      requestList.innerHTML = "";
      for (const r of rows) {
        const item = document.createElement("div");
        item.className = "list-item";
        item.innerHTML = `
          <div>
            <div style="display:flex; align-items:center; gap:10px; flex-wrap:wrap;">
              <strong>${r.title}</strong>
              <span class="pill">${r.artist}</span>
            </div>
            <small>Requested by <strong>${r.name}</strong> • ${fmtTime(r.timestamp)}</small>
          </div>
          <div class="row">
            ${r.apple_link ? `<a class="btn small" href="${r.apple_link}" target="_blank" rel="noopener">Apple</a>` : ""}
            ${r.preview_url ? `<audio controls preload="none" style="height:28px;"><source src="${r.preview_url}"></audio>` : ""}
            <button class="btn small" data-id="${r.id}" data-action="remove">✕</button>
          </div>
        `;
        requestList.appendChild(item);
      }
    }

    function removeRequest(id) {
      state.requests = state.requests.filter(r => r.id !== id);
      saveRequests();
    }

    function clearLocal() {
      if (!confirm("Clear local requests? This does not affect any remote sheet/webhook.")) return;
      state.requests = [];
      saveRequests();
    }

    function exportCsv() {
      const csv = toCsv(state.requests);
      const blob = new Blob([csv], { type: "text/csv;charset=utf-8" });
      const url = URL.createObjectURL(blob);
      exportCsvBtn.href = url;
      // filename already set via download attribute
    }

    function toggleView() {
      state.view = state.view === "guest" ? "dj" : "guest";
      toggleViewBtn.textContent = state.view === "guest" ? "Toggle DJ View" : "Toggle Guest View";
      // Future hook: add filters or sorting per view. For now we just keep it simple.
    }

    // =========================
    // Events
    // =========================
    searchInput.addEventListener("input", debounce(() => searchApple(searchInput.value), 350));
    nameInput.addEventListener("input", validateSubmit);
    clearSelectionBtn.addEventListener("click", () => { state.selected = null; updateSelectedBox(); });
    submitBtn.addEventListener("click", submitRequest);
    toggleViewBtn.addEventListener("click", toggleView);
    exportCsvBtn.addEventListener("click", exportCsv);
    clearAllBtn.addEventListener("click", clearLocal);
    requestList.addEventListener("click", (e) => {
      const btn = e.target.closest("button[data-action='remove']");
      if (!btn) return;
      removeRequest(btn.getAttribute("data-id"));
    });

    // Init
    renderList();
    updateSelectedBox();
  })();
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Song Request • David Charles Events</title>

<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400&display=swap" rel="stylesheet">

<style>
  :root{
    --bg:#212121;
    --ink:#ffffff;
    --muted:#d9d9d9;
    --border:#3a3a3a;
    --field:#303030;
    --card:#3a3a3a;
    --ring:rgba(255,255,255,.18);
    --accent:#1dcec9;
    --r-lg:14px; --r-md:12px; --w:880px;
  }

  @font-face{
    font-family:"Adventor";
    src:url("texgyreadventor-regular.otf") format("opentype");
    font-weight:400; font-style:normal; font-display:swap;
  }

  *{ box-sizing:border-box; }
  html,body{
    margin:0; background:var(--bg); color:var(--ink);
    font-family:Roboto, system-ui, -apple-system, Segoe UI, Helvetica, Arial, sans-serif; font-weight:300;
  }

  .wrap{ max-width:var(--w); margin:0 auto; padding:18px 14px 80px; }

  .logo{ text-align:center; margin:10px 0 8px; }
  .logo img{ width:min(540px, 80vw); height:auto; display:inline-block; }

  .title{
    text-align:center; margin:4px 0 18px;
    font-family:Adventor, Roboto, sans-serif; font-weight:400; letter-spacing:.06em;
    font-size:clamp(22px, 6vw, 36px);
  }

  label{ display:block; font-size:14px; color:var(--muted); margin:0 0 6px; }
  .field{ margin-bottom:12px; }
  .sp20{ margin-top:20px; }

  .input{
    width:100%; height:52px; padding:0 14px; border:1px solid var(--border);
    background:var(--field); color:var(--ink); border-radius:12px; font-size:16px; outline:none;
    transition:border-color .12s ease, box-shadow .12s ease, background .12s ease;
  }
  .input:focus{ border-color:#e9e9e9; box-shadow:0 0 0 3px var(--ring); }

  .search-row{ position:relative; }
  .clear{
    position:absolute; right:10px; top:50%; transform:translateY(-50%);
    width:30px; height:30px; border-radius:50%;
    display:none; align-items:center; justify-content:center;
    border:1px solid var(--border); background:#2a2a2a; color:#cfcfcf;
    cursor:pointer; user-select:none; font-size:18px; line-height:1;
  }
  .clear:hover{ background:#262626; }

  .results{ margin-top:8px; }
  .item{
    display:grid; grid-template-columns:56px 1fr; align-items:center; gap:12px;
    padding:10px; margin-bottom:8px; cursor:pointer;
    border:1px solid var(--border); border-radius:12px; background:var(--card);
    transition:transform .06s ease, filter .12s ease, background .12s ease;
  }
  .item:hover{ filter:brightness(1.05); }
  .item:active{ transform:scale(.996); }
  .cover{ width:56px;height:56px;border-radius:10px;object-fit:cover;background:#2d2d2d; display:block; }
  .ttl{ margin:0 0 2px; font-weight:400; color:#fff; font-size:15px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
  .art{ margin:0; color:#ebebeb; font-size:13px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }

  .selected{ margin-top:8px; padding:12px; border:1px solid var(--border); border-radius:12px; background:#2a2a2a; display:none; }
  .sel-inner{ display:grid; grid-template-columns:72px 1fr; gap:12px; align-items:center; }
  .sel-cover{ width:72px;height:72px;border-radius:12px;object-fit:cover;background:#2d2d2d; display:block; }
  .sel-title{ margin:0 0 2px; font-size:16px; font-weight:400; }
  .sel-artist{ margin:0; color:#e9e9e9; font-size:13px; }

  .status{ margin-top:6px; font-size:13px; color:var(--muted); min-height:0; }

  .actions{ margin-top:14px; }
  .btn{
    height:48px; padding:0 16px; border-radius:12px; border:1px solid var(--accent);
    background:var(--accent); color:#000; text-transform:uppercase; letter-spacing:.05em;
    font-family:Roboto, sans-serif; font-weight:400; font-size:15px;
    display:inline-flex; align-items:center; justify-content:center; cursor:pointer; user-select:none;
    box-shadow:0 2px 0 rgba(0,0,0,.35), 0 10px 18px rgba(0,0,0,.15);
    transition:transform .06s ease, filter .15s ease, box-shadow .06s ease;
  }
  .btn:hover{ filter:brightness(1.05); }
  .btn:active{ transform:translateY(1px); box-shadow:inset 0 2px 0 rgba(0,0,0,.25); }
  .btn.block{ width:220px; max-width:100%; display:block; margin:0 auto; }

  .ty-overlay{ position:fixed; inset:0; background:#111; display:none; align-items:center; justify-content:center; z-index:9999; }
  .ty-wrap{ text-align:center; padding:24px; max-width:92vw; color:#fff; }
  .ty-icon{
    width:96px; height:96px; margin:0 auto 18px; display:grid; place-items:center;
    border-radius:50%; background:var(--accent); box-shadow:0 8px 22px rgba(29,206,201,.35);
  }
  .ty-icon svg{ width:52px; height:52px; color:#fff; }
  .ty-title{
    font-family:Adventor, Roboto, sans-serif; font-weight:400;
    font-size:clamp(28px,7.5vw,54px); line-height:1.05; margin:0 0 8px; color:#fff;
  }
  .ty-sub{ font:400 16px/1.5 Roboto, system-ui, -apple-system, Segoe UI, Helvetica, Arial, sans-serif; color:#fff; margin:0; }

  @media (max-width:520px){ .btn.block{ width:100%; } }
</style>
</head>
<body>
  <div class="wrap">
    <div class="logo">
      <!-- UPDATED to use the correct current logo filename -->
      <img src="./dce-logo.png" alt="David Charles Events" onerror="this.onerror=null; this.src='assets/client-logo.png';" />
    </div>
    <div class="title">SONG REQUEST</div>

    <div class="field">
      <label for="nameInput">What’s your name?</label>
      <input id="nameInput" class="input" type="text" autocomplete="name" />
    </div>

    <div class="field sp20">
      <label for="q">Search Song, Artist or Lyrics</label>
      <div class="search-row">
        <input id="q" class="input" type="search" placeholder="start typing..." inputmode="search" />
        <button id="clearBtn" class="clear" type="button" aria-label="Clear search">×</button>
      </div>
      <div id="results" class="results"></div>

      <div id="selected" class="selected" aria-live="polite" aria-atomic="true">
        <div class="sel-inner">
          <img id="selCover" class="sel-cover" alt="" />
          <div>
            <p id="selTitle" class="sel-title"></p>
            <p id="selArtist" class="sel-artist"></p>
          </div>
        </div>
      </div>

      <div id="status" class="status"></div>
    </div>

    <div class="actions">
      <button id="submitBtn" class="btn block">SUBMIT</button>
    </div>
  </div>

  <div class="ty-overlay" id="tyOverlay" role="dialog" aria-live="polite" aria-modal="true">
    <div class="ty-wrap">
      <div class="ty-icon" aria-hidden="true">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M20 6L9 17l-5-5"></path></svg>
      </div>
      <h1 class="ty-title">Got it!</h1>
      <p class="ty-sub">If it fits the flow, we’ll get it on. Let’s party.</p>
    </div>
  </div>

<script>
const ENDPOINT_URL = 'https://script.google.com/macros/s/AKfycbxkSPUc2VWQYkhJ_af7CShegZLAMmVgUsTp2nMeVwkkhdFbdQT8wk2s6xBAAynjtLDT/exec';

const $ = s=>document.querySelector(s);
const q = $('#q'), clearBtn = $('#clearBtn'), resultsEl = $('#results'),
      selBox = $('#selected'), selCover = $('#selCover'),
      selTitle = $('#selTitle'), selArtist = $('#selArtist'),
      statusEl = $('#status'), nameInput = $('#nameInput'),
      submitBtn = $('#submitBtn'), ty = $('#tyOverlay');

const urlp = new URLSearchParams(location.search);
const EVENT_CODE = (urlp.get('event') || '').trim();

function setStatus(msg='', isErr=false){ statusEl.textContent = msg; statusEl.style.color = isErr ? '#ffb4b4' : 'var(--muted)'; }
function clearResults(){ resultsEl.innerHTML=''; }
function showSelectedCard(data){
  selCover.src = data.cover || '';
  selCover.alt = data.title ? `${data.title} cover` : '';
  selTitle.textContent = data.title || 'Unknown Title';
  selArtist.textContent = data.artist || 'Unknown Artist';
  selBox.style.display = 'block';
}
function hideSelectedCard(){
  selCover.removeAttribute('src'); selCover.removeAttribute('alt');
  selTitle.textContent=''; selArtist.textContent='';
  selBox.style.display='none';
}

let debounce=null, lastTerm='', lastScript=null, chosen=null;

function jsonp(url, cbParam='callback'){
  return new Promise((res,rej)=>{
    const cb='cb_'+Math.random().toString(36).slice(2);
    const s=document.createElement('script');
    s.src = url + (url.includes('?')?'&':'?') + cbParam + '=' + cb;
    if (lastScript) lastScript.remove();
    lastScript = s;
    const kill=setTimeout(()=>{ cleanup(); rej(new Error('timeout')); }, 9000);
    function cleanup(){ clearTimeout(kill); try{ delete window[cb]; }catch{} s.remove(); }
    window[cb]=(data)=>{ cleanup(); res(data); };
    s.onerror=()=>{ cleanup(); rej(new Error('jsonp error')); };
    document.body.appendChild(s);
  });
}

async function searchITunes(term){
  const data = await jsonp(`https://itunes.apple.com/search?term=${encodeURIComponent(term)}&entity=musicTrack&limit=8`, 'callback');
  return (data?.results||[]).map(t=>({
    title:t.trackName, artist:t.artistName,
    cover:t.artworkUrl100||t.artworkUrl60||'',
    link:t.trackViewUrl||''
  }));
}

function render(list){
  clearResults();
  if (!list.length){ setStatus('No results.'); return; }
  setStatus('');
  list.forEach(item=>{
    const el=document.createElement('div');
    el.className='item';
    el.innerHTML = `
      <img class="cover" src="${item.cover||''}" alt="" />
      <div>
        <p class="ttl">${item.title||'Unknown Title'}</p>
        <p class="art">${item.artist||'Unknown Artist'}</p>
      </div>
    `;
    el.onclick=()=>{ chosen=item; showSelectedCard(item); clearResults(); };
    resultsEl.appendChild(el);
  });
}

async function doSearch(term){
  if (!term){ setStatus(''); clearResults(); return; }
  try{ setStatus('Searching…'); const rows = await searchITunes(term); render(rows); }
  catch(e){ setStatus('Search failed.', true); }
}

q.addEventListener('input', ()=>{
  const raw=q.value; clearBtn.style.display = raw.length>=1 ? 'flex' : 'none';
  const t=raw.trim(); if (t===lastTerm) return; lastTerm=t;
  clearTimeout(debounce); debounce=setTimeout(()=>doSearch(t), 260);
});
q.addEventListener('keydown', e=>{ if(e.key==='Enter'){ e.preventDefault(); doSearch(q.value.trim()); }});
clearBtn.addEventListener('click', ()=>{
  q.value=''; lastTerm=''; chosen=null; hideSelectedCard(); clearBtn.style.display='none'; setStatus(''); clearResults();
});

function thankThenReturn(){
  ty.style.display='flex';
  setTimeout(()=>{
    const sp=new URLSearchParams(location.search);
    if (EVENT_CODE) sp.set('event', EVENT_CODE);
    location.href = location.pathname + (sp.toString()?('?'+sp.toString()):'');
  }, 2200);
}

function jsonpPost(url, params){
  const qs = new URLSearchParams(params).toString();
  return jsonp(url + (url.includes('?')?'&':'?') + qs, 'callback');
}

submitBtn.addEventListener('click', async ()=>{
  const name = (nameInput.value||'').trim();
  const song = chosen?.title || '';
  const artist = chosen?.artist || '';
  const link = chosen?.link || '';

  if (!EVENT_CODE){ setStatus('No event detected on this page. Add ?event=CODE to the URL.', true); return; }
  if (!song && !artist){ setStatus('Pick a song from the search results first.', true); return; }

  submitBtn.setAttribute('disabled','disabled');
  try{
    const payload = {
      mode:'write',
      name, song_title:song, artist, link,
      event: EVENT_CODE,  // code only
      ua: navigator.userAgent || '',
      ref: location.href || ''
    };
    await jsonpPost(ENDPOINT_URL, payload);
    thankThenReturn();
  }catch(e){
    setStatus('Could not send. Please try again.', true);
  }finally{
    submitBtn.removeAttribute('disabled');
  }
});

window.addEventListener('load', ()=>{ try{ nameInput.focus({preventScroll:true}); }catch{} });
</script>
</body>
</html>

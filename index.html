<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Song Request • David Charles Events</title>
<style>
  :root{
    /* Dark theme tokens */
    --bg:#212121;           /* page background */
    --surface:#303030;      /* inputs & cards */
    --surface-2:#343434;    /* results items/secondary surface (lightened) */
    --surface-2-hover:#3d3d3d;
    --ink:#f2f2f2;          /* primary text */
    --muted:#bdbdbd;        /* secondary text */
    --border:#3a3a3a;       /* strokes */
    --accent:#14b8a6;       /* button background */
    --focus:#e6e6e6;        /* focus border for inputs */
    --ring:rgba(255,255,255,.22); /* subtle white glow */
    --radius:12px;
    --field-max:640px;
  }
  @font-face{
    font-family:"TexGyreAdventorBold";
    src:url("texgyreadventor-bold.otf") format("opentype");
    font-weight:700; font-style:normal; font-display:swap;
  }
  *{ box-sizing:border-box; }
  html,body{ margin:0; background:var(--bg); color:var(--ink); font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif; }
  .wrap{ width:100%; max-width:960px; margin:0 auto; padding:16px 12px 48px; }
  .dce-logo{text-align:center; margin:14px 0 6px;}
  .dce-logo img{ max-width:min(220px,60vw); height:auto; }

  .app-title{
    text-align:center; margin:0 auto 26px;
    font-family:"TexGyreAdventorBold", Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
    letter-spacing:.06em; line-height:1.05; font-size:clamp(22px,6vw,38px); color:#fff;
  }

  /* form rows */
  .row{ width:100%; max-width:var(--field-max); margin:0 auto; }
  label{ display:block; font-size:14px; color:var(--muted); margin:10px 0 6px; }

  input[type="text"]{
    width:100%; height:52px; padding:0 14px;
    border:1px solid var(--border); border-radius:var(--radius);
    background:var(--surface); color:var(--ink);
    font-size:16px; outline:none;
    transition: box-shadow .12s ease, border-color .12s ease;
  }
  input[type="text"]::placeholder{ color:#9e9e9e; }
  input[type="text"]:focus{
    border-color:var(--focus);
    box-shadow:0 0 0 3px var(--ring);
  }

  /* search field + clear button */
  .field{ position:relative; }
  .search{
    width:100%; height:52px; padding:0 42px 0 14px;
    border:1px solid var(--border); border-radius:var(--radius);
    background:var(--surface); color:var(--ink); font-size:16px;
    transition: box-shadow .12s ease, border-color .12s ease;
  }
  .search::placeholder{ color:#9e9e9e; }
  .search:focus{
    border-color:var(--focus);
    box-shadow:0 0 0 3px var(--ring);
  }
  .clear{
    position:absolute; right:8px; top:50%; transform:translateY(-50%);
    width:32px; height:32px; border-radius:50%; display:none; align-items:center; justify-content:center;
    border:1px solid var(--border); background:#2b2b2b; color:#e0e0e0; cursor:pointer; user-select:none; line-height:1; font-size:18px;
  }
  .clear.show{ display:flex; }
  .clear:active{ transform:translateY(-50%) scale(0.98); }

  /* results */
  .results{ margin-top:6px; }
  .hidden{ display:none !important; }
  .item{
    display:grid; grid-template-columns:56px 1fr; align-items:center; gap:12px;
    padding:10px; border:1px solid var(--border); border-radius:12px;
    background:var(--surface-2); transition:background .15s,transform .06s,border-color .15s; cursor:pointer; margin-bottom:8px;
  }
  .item:hover{ background:var(--surface-2-hover); } .item:active{ transform:scale(.995); }
  .cover{ width:56px;height:56px;border-radius:10px;object-fit:cover;background:#1f1f1f; color:#9aa6b2; display:grid; place-items:center; font-size:12px; }
  .info{ min-width:0; }
  .ttl{ margin:0 0 2px; font-weight:700; font-size:15px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; color:#fff; }
  .art{ margin:0; color:#cfcfcf; font-size:13px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }

  /* selected card */
  .selected{ margin-top:6px; border:1px solid var(--border); border-radius:12px; background:var(--surface); display:none; transition: box-shadow .12s ease, border-color .12s ease; }
  .selected.active{ border-color:var(--focus); box-shadow:0 0 0 3px var(--ring); }
  .sel-inner{ display:grid; grid-template-columns:72px 1fr; gap:12px; align-items:center; padding:10px; }
  .sel-cover{ width:72px;height:72px;border-radius:12px;object-fit:cover;background:#1f1f1f;color:#9aa6b2;display:grid;place-items:center;font-size:14px; }
  .sel-text{ min-width:0; }
  .sel-title{ margin:0 0 2px; font-weight:700; font-size:16px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; color:#fff; }
  .sel-artist{ margin:0; color:#cfcfcf; font-size:13px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }

  .status{ margin-top:6px; font-size:13px; color:var(--muted); min-height:0; }
  .status:empty{ margin-top:0; }

  /* submit */
  .actions{ width:100%; max-width:var(--field-max); margin:12px auto 0; }
  .btn{
    width:100%; height:54px; border:1px solid var(--accent); background:var(--accent); color:#000000; /* black text */
    border-radius:14px; cursor:pointer; font-weight:800; letter-spacing:.03em; font-size:16px;
    display:inline-flex; align-items:center; justify-content:center;
    transform:translateZ(0); transition:transform .06s, filter .15s, opacity .15s, background .15s;
  }
  .btn:hover{ filter:brightness(1.05); }
  .btn:active{ transform:scale(0.985); }
  .btn[disabled]{ opacity:.75; cursor:not-allowed; }
  .btn .spin{ width:18px; height:18px; margin-right:10px; border-radius:50%; border:2px solid rgba(6,44,42,.4); border-top-color:#062c2a; animation:spin .8s linear infinite; display:none; }
  .btn.loading .spin{ display:inline-block; }
  @keyframes spin{ to{ transform:rotate(360deg);} }

  /* thank-you overlay (dark) */
  .ty-overlay{ position:fixed; inset:0; background:rgba(33,33,33,.98); display:none; align-items:center; justify-content:center; z-index:9999; backdrop-filter:blur(2px); }
  .ty-wrap{ text-align:center; padding:24px; max-width:92vw; color:#e6ffe6; }
  .ty-icon{ width:96px; height:96px; margin:0 auto 22px; display:grid; place-items:center; border-radius:50%; background:#22c55e; box-shadow:0 6px 18px rgba(34,197,94,.35); color:#052911; font-size:52px; }
  .ty-title{ font-family:"TexGyreAdventorBold", Inter, system-ui; font-size:clamp(28px,7.8vw,56px); line-height:1.05; margin:0 0 8px; color:#d1fae5;}
  .ty-sub{ font:500 16px/1.5 Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif; color:#b7f7d9; margin:0;}

  /* mobile tweaks */
  @media (max-width:480px){
    .wrap{ padding-left:10px; padding-right:10px; }
    .sel-inner{ grid-template-columns:64px 1fr; }
    .sel-cover{ width:64px; height:64px; }
  }

  /* optional: debug pill (shown with ?debug=1) */
  .dbg{ display:none; width:100%; max-width:var(--field-max); margin:10px auto 0;
        color:#a7f3d0; background:rgba(45,212,191,.12); border:1px solid rgba(45,212,191,.35);
        border-radius:999px; padding:6px 12px; font-size:12px; }
  .dbg.show{ display:block; }
</style>
</head>
<body>
<div class="wrap">
  <div class="dce-logo">
    <img src="assets/dce-logo.png" alt="David Charles Events" onerror="this.style.display='none'">
  </div>
  <div class="app-title">SONG REQUEST</div>

  <div id="debugPill" class="dbg"></div>

  <div class="row">
    <label for="yourName">What's your name?</label>
    <input type="text" id="yourName" autocomplete="name" placeholder="Your name" />
  </div>

  <div class="row" style="margin-top:20px;">
    <label for="q">Search Song, Artist or Lyrics</label>
    <div class="field">
      <input id="q" class="search" type="text" placeholder="Start typing…" autocomplete="off" inputmode="search" />
      <button id="clearBtn" class="clear" type="button" aria-label="Clear search">×</button>
    </div>

    <div id="results" class="results"></div>

    <div id="selected" class="selected" aria-live="polite" aria-atomic="true">
      <div class="sel-inner">
        <div id="selCover" class="sel-cover" aria-hidden="true">♪</div>
        <div class="sel-text">
          <p id="selTitle" class="sel-title"></p>
          <p id="selArtist" class="sel-artist"></p>
        </div>
      </div>
    </div>

    <div id="status" class="status"></div>
  </div>

  <!-- hidden fields for selected track -->
  <input type="hidden" id="songTitle" />
  <input type="hidden" id="artist" />
  <input type="hidden" id="link" />

  <div class="actions">
    <button id="submitBtn" class="btn"><span class="spin" aria-hidden="true"></span><span class="btntxt">SUBMIT</span></button>
  </div>
</div>

<!-- Thank you -->
<div class="ty-overlay" id="tyOverlay" role="dialog" aria-live="polite" aria-modal="true">
  <div class="ty-wrap">
    <div class="ty-icon">✓</div>
    <h1 class="ty-title">Got it!</h1>
    <p class="ty-sub">If it fits the flow, we’ll get it on. Let’s party.</p>
  </div>
</div>

<script>
/* ===================== CONFIG ===================== */
const ENDPOINT_URL = 'https://script.google.com/macros/s/AKfycbxZ9ylpDohWZnp1Krsn9THEPEciFv68uBB5unr0a41qNTesaOBkCWsQOeiucY4asIYH5A/exec';
const REDIRECT_DELAY_MS = 2200; // after thank-you, go back to the same page with ?event=...
/* ================================================== */

/* Event code: URL (?event=) → referrer (if any) → (optional) postMessage */
const urlp = new URLSearchParams(location.search);
const DEBUG = urlp.get('debug') === '1';
let EVENT_CODE = (urlp.get('event') || '').trim();

if (!EVENT_CODE && document.referrer) {
  try { const ref = new URL(document.referrer); const refEvent = ref.searchParams.get('event'); if (refEvent) EVENT_CODE = refEvent.trim(); } catch {}
}

function dlog(...args){ if(DEBUG) try{ console.log('[DCE]',...args); }catch{} }

function setEventCode(code){
  if (!code) return;
  EVENT_CODE = String(code).trim();
  if (DEBUG) showDebug();
}
// Parent can override
window.addEventListener('message', (e)=>{
  const msg = e.data || {};
  if (msg && msg.action === 'setEvent' && msg.event) setEventCode(msg.event);
});
window.addEventListener('load', ()=>{
  if (!EVENT_CODE) { try{ parent.postMessage({action:'needEvent'}, '*'); }catch{} }
});

/* DOM refs */
const $=(s)=>document.querySelector(s);
const nameInput=$('#yourName'), q=$('#q'), clearBtn=$('#clearBtn'), resultsEl=$('#results'),
      selectedBox=$('#selected'), statusEl=$('#status'), submitBtn=$('#submitBtn'),
      selTitle=$('#selTitle'), selArtist=$('#selArtist'); let selCoverEl=$('#selCover');
const titleInput=$('#songTitle'), artistInput=$('#artist'), linkInput=$('#link');
const tyOverlay=$('#tyOverlay'); const btnTxt=document.querySelector('.btntxt'); const btnSpin=document.querySelector('.spin');

function showDebug(){
  const pill=document.getElementById('debugPill');
  pill.classList.add('show');
  pill.textContent = EVENT_CODE ? `Event detected: ${EVENT_CODE}` : 'No event detected (writes may not appear in DJ view)';
}
if (DEBUG) showDebug();

function setStatus(m='',err=false){ statusEl.textContent=m; statusEl.style.color=err?'#ffb4b4':'var(--muted)'; }
function clearResults(){ resultsEl.innerHTML=''; }
function showResults(){ resultsEl.classList.remove('hidden'); }
function hideResults(){ resultsEl.classList.add('hidden'); clearResults(); }
function hideSelected(){
  selectedBox.style.display='none'; selectedBox.classList.remove('active');
  if(selCoverEl && selCoverEl.tagName.toLowerCase()==='img'){ selCoverEl.outerHTML=`<div id="selCover" class="sel-cover" aria-hidden="true">♪</div>`; selCoverEl=document.getElementById('selCover'); }
  selTitle.textContent=''; selArtist.textContent='';
}

/* JSONP helper */
function jsonp(url, cbParam='callback'){
  return new Promise((res,rej)=>{
    const cb='cb_'+Math.random().toString(36).slice(2);
    const s=document.createElement('script');
    s.src = url + (url.includes('?')?'&':'?') + cbParam + '=' + cb + '&t=' + Date.now();
    const kill=setTimeout(()=>{ cleanup(); rej(new Error('timeout')); }, 9000);
    function cleanup(){ clearTimeout(kill); try{ delete window[cb]; }catch{} s.remove(); }
    window[cb] = (data)=>{ cleanup(); res(data); };
    s.onerror  = ()=>{ cleanup(); rej(new Error('jsonp error')); };
    document.body.appendChild(s);
  });
}

/* Search providers
   Prefer iTunes JSONP first (CORS-proof), then Deezer JSONP, then MusicBrainz fetch. */
async function searchITunes(term){
  try{
    const data = await jsonp(`https://itunes.apple.com/search?term=${encodeURIComponent(term)}&entity=musicTrack&limit=8`, 'callback');
    dlog('iTunes JSONP ok', data?.results?.length||0);
    return (data?.results||[]).map(t=>({title:t.trackName, artist:t.artistName, cover:t.artworkUrl100||t.artworkUrl60, link:t.trackViewUrl}));
  }catch(e){
    dlog('iTunes JSONP failed, trying fetch', e);
    try{
      const r = await fetch(`https://itunes.apple.com/search?term=${encodeURIComponent(term)}&entity=musicTrack&limit=8`, {mode:'cors', cache:'no-store'});
      if (r.ok) {
        const data = await r.json();
        dlog('iTunes fetch ok', data?.results?.length||0);
        return (data?.results||[]).map(t=>({title:t.trackName, artist:t.artistName, cover:t.artworkUrl100||t.artworkUrl60, link:t.trackViewUrl}));
      }
    }catch(e2){ dlog('iTunes fetch failed', e2); }
  }
  return [];
}
async function searchDeezer(term){
  try{
    const data=await jsonp(`https://api.deezer.com/search?q=${encodeURIComponent(term)}&limit=8&output=jsonp`,'callback');
    dlog('Deezer JSONP ok', data?.data?.length||0);
    return (data?.data||[]).map(d=>({title:d.title, artist:d?.artist?.name||'', cover:d?.album?.cover_medium||d?.album?.cover||'', link:d.link||''}));
  }catch(e){ dlog('Deezer JSONP failed', e); return []; }
}
async function searchMB(term){
  try{
    const r=await fetch(`https://musicbrainz.org/ws/2/recording/?query=${encodeURIComponent(term)}&fmt=json&limit=8`,{
      headers:{'User-Agent':'DCE-SongRequest/1.0 (https://www.davidcharlesevents.com)'}, cache:'no-store'
    });
    if(!r.ok) return [];
    const data=await r.json();
    dlog('MB fetch ok', data?.recordings?.length||0);
    return (data.recordings||[]).map(rec=>{
      const ac=rec['artist-credit']; const artist=ac && ac[0] && ac[0].name ? ac[0].name : '';
      return {title:rec.title, artist, cover:'', link:`https://musicbrainz.org/recording/${rec.id}`};
    });
  }catch(e){ dlog('MB fetch failed', e); return []; }
}

/* Render helpers */
function render(list){
  clearResults(); if(!list.length){ setStatus('No results'); return; } setStatus('');
  showResults();
  list.forEach(({title,artist,cover,link})=>{
    const div=document.createElement('div'); div.className='item'; div.setAttribute('role','button'); div.setAttribute('tabindex','0');
    const coverHTML=cover?`<img class="cover" src="${cover}" alt="Album cover" loading="lazy" decoding="async" width="56" height="56">`:`<div class="cover" aria-hidden="true">♪</div>`;
    div.innerHTML=`${coverHTML}<div class="info"><p class="ttl">${title||'Unknown Title'}</p><p class="art">${artist||'Unknown Artist'}</p></div>`;
    const choose=()=>useSong({title,artist,cover,link}, div);
    div.onclick=choose; div.onkeyup=e=>{ if(e.key==='Enter'||e.key===' ') choose(); };
    resultsEl.appendChild(div);
  });
}

function showSelectedCard({title,artist,cover}){
  if(cover){
    const img=document.createElement('img'); img.src=cover; img.alt='Album cover'; img.className='sel-cover'; img.loading='lazy'; img.decoding='async';
    if(selCoverEl) selCoverEl.replaceWith(img); selCoverEl=img;
  }else{
    if(!selCoverEl || selCoverEl.tagName.toLowerCase()==='img'){
      const box=document.createElement('div'); box.id='selCover'; box.className='sel-cover'; box.setAttribute('aria-hidden','true'); box.textContent='♪';
      if(selCoverEl) selCoverEl.replaceWith(box); selCoverEl=box;
    }
  }
  selTitle.textContent=title||'Unknown Title';
  selArtist.textContent=artist||'Unknown Artist';
  selectedBox.style.display='block'; selectedBox.classList.add('active');
}

function useSong({title,artist,cover,link}, el){
  document.querySelectorAll('.item').forEach(x=>x.classList.remove('selected')); el?.classList.add('selected');
  titleInput.value = title || '';
  artistInput.value = artist || '';
  linkInput.value   = link || '';
  showSelectedCard({title,artist,cover,link}); hideResults();
}

/* search events */
let debounce=null,lastTerm='';
q.addEventListener('input', ()=>{
  const raw=q.value; if(raw.length>=1) clearBtn.classList.add('show'); else clearBtn.classList.remove('show');
  const t=raw.trim(); if(t===lastTerm) return; lastTerm=t;
  clearTimeout(debounce);
  debounce=setTimeout(async()=>{
    if(!t){ setStatus(''); hideResults(); return; }
    setStatus('Searching…');
    let list=await searchITunes(t);
    if(!list.length) list=await searchDeezer(t);
    if(!list.length) list=await searchMB(t);
    if(list.length) render(list); else { setStatus('No results'); hideResults(); }
  }, 240);
});
q.addEventListener('keydown', e=>{
  if(e.key==='Enter'){
    e.preventDefault();
    const t=q.value.trim(); if(!t) return;
    setStatus('Searching…');
    (async()=>{
      let list=await searchITunes(t);
      if(!list.length) list=await searchDeezer(t);
      if(!list.length) list=await searchMB(t);
      if(list.length) render(list); else { setStatus('No results'); hideResults(); }
    })();
  }
});
clearBtn.addEventListener('click', ()=>{
  q.value=''; lastTerm=''; clearBtn.classList.remove('show'); setStatus(''); hideResults(); hideSelected();
  titleInput.value=''; artistInput.value=''; linkInput.value='';
  q.focus({preventScroll:true});
});

/* submit UX */
function openThankYou(){ tyOverlay.style.display='flex'; }
function setBtnLoading(on){
  if(on){ submitBtn.classList.add('loading'); submitBtn.setAttribute('disabled','disabled'); btnTxt.textContent='Sending…'; }
  else{ submitBtn.classList.remove('loading'); submitBtn.removeAttribute('disabled'); btnTxt.textContent='Submit'; }
}
function redirectBack(){
  const base = location.origin + location.pathname;
  const params = new URLSearchParams();
  if (EVENT_CODE) params.set('event', EVENT_CODE);
  const next = params.toString() ? `${base}?${params.toString()}` : base;
  location.replace(next);
}

function writeRequest(){
  const nameVal = (nameInput.value || '').trim();
  const titleVal= (titleInput.value || '').trim();
  const artistVal=(artistInput.value || '').trim();
  const linkVal = (linkInput.value || '').trim();

  if (!titleVal && !artistVal) { setStatus('Pick a song first.'); q.focus(); return; }
  if (!EVENT_CODE) { setStatus('No event detected on this page. Add ?event=CODE to the URL.', true); if (DEBUG) showDebug(); }

  // Optimistic UX: show feedback immediately
  setBtnLoading(true);
  openThankYou();

  const qs = new URLSearchParams({
    mode: 'write',
    event: EVENT_CODE || '',
    name: nameVal,
    song_title: titleVal,
    artist: artistVal,
    link: linkVal,
    ua: navigator.userAgent,
    referer: document.referrer || location.href
  });

  // Fire-and-forget JSONP; we do not block UX on response
  const cb = 'cb_' + Math.random().toString(36).slice(2);
  window[cb] = (data)=>{ try{ delete window[cb]; }catch{} };
  const s = document.createElement('script');
  s.src = ENDPOINT_URL + '?' + qs.toString() + '&callback=' + cb + '&t=' + Date.now();
  s.onerror = ()=>{ try{ delete window[cb]; }catch{} };
  document.body.appendChild(s);

  // Reset and redirect back to same page (keeping ?event=)
  setTimeout(()=>{
    setBtnLoading(false);
    nameInput.value='';
    q.value=''; lastTerm=''; clearBtn.classList.remove('show'); setStatus('');
    hideResults(); hideSelected();
    redirectBack();
  }, REDIRECT_DELAY_MS);
}

submitBtn.addEventListener('click', writeRequest);

/* Init */
window.addEventListener('load', ()=>{
  if (DEBUG) showDebug();
  nameInput.focus({preventScroll:true});
});
</script>
</body>
</html>

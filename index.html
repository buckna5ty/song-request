<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Song Request • David Charles Events</title>
<style>
  :root{ --field-w:640px; --teal:#0ea5a6; --ring:rgba(14,165,166,.25); --border:#e5e7eb; --radius:8px; --bg:#fff; --ink:#111; }
  @font-face{ font-family:"TexGyreAdventorBold"; src:url("texgyreadventor-bold.otf") format("opentype"); font-weight:700; font-style:normal; font-display:swap; }

  html,body{ margin:0; background:#f3f2ff; color:var(--ink); font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif; }
  .wrap{ max-width:960px; margin:0 auto; padding:16px 12px 48px; }
  .dce-logo{text-align:center; margin:18px 0 4px;}
  .dce-logo img{ max-width:220px; height:auto; }
  .app-title{ text-align:center; margin:0 auto 12px; font-family:"TexGyreAdventorBold", Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; letter-spacing:.06em; line-height:1.05; font-size:clamp(22px,6vw,38px); color:#111; }
  label{ display:block; font-size:14px; color:#475569; margin:10px 0 6px; }
  .row{ max-width:var(--field-w); margin:0 auto; }

  /* Inputs */
  input[type="text"]{
    width:100%; height:48px; padding:0 14px; border:1px solid var(--border); border-radius:var(--radius); background:var(--bg);
    font-size:16px; outline:none;
  }
  input[type="text"]:focus{ border-color:var(--teal); box-shadow:0 0 0 4px var(--ring); }

  /* Search field with clear button */
  .field{ position:relative; }
  .search{ width:100%; height:48px; padding:0 38px 0 14px; border:1px solid var(--border); border-radius:var(--radius); background:var(--bg); font-size:16px; }
  .search:focus{ border-color:var(--teal); box-shadow:0 0 0 4px var(--ring); }
  .clear{ position:absolute; right:10px; top:50%; transform:translateY(-50%); width:28px; height:28px; border-radius:50%;
    display:none; align-items:center; justify-content:center; border:1px solid var(--border); background:#fafafa; color:#555; cursor:pointer; user-select:none; line-height:1; font-size:16px;}
  .clear.show{ display:flex; }

  /* Results list */
  .results{ margin-top:6px; }
  .hidden{ display:none !important; }
  .item{ display:grid; grid-template-columns:56px 1fr; align-items:center; gap:12px;
    padding:10px; border:1px solid var(--border); border-radius:var(--radius);
    background:#fafafa; transition:background .15s,transform .06s,border-color .15s; cursor:pointer; margin-bottom:8px; }
  .item:hover{ background:#f5f5f5; } .item:active{ transform:scale(.996); }
  .cover{ width:56px;height:56px;border-radius:8px;object-fit:cover;background:#e9eef0; color:#7a8a8d; display:grid; place-items:center; font-size:12px; }
  .info{ min-width:0; }
  .ttl{ margin:0 0 2px; font-weight:700; font-size:15px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
  .art{ margin:0; color:#555; font-size:13px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }

  /* Selected card */
  .selected{ margin-top:6px; border:1px solid var(--border); border-radius:var(--radius); background:#fff; display:none; }
  .selected.active{ border-color:var(--teal); box-shadow:0 0 0 4px var(--ring); }
  .sel-inner{ display:grid; grid-template-columns:72px 1fr; gap:12px; align-items:center; padding:10px; }
  .sel-cover{ width:72px;height:72px;border-radius:10px;object-fit:cover;background:#e9eef0;color:#7a8a8d;display:grid;place-items:center;font-size:14px; }
  .sel-text{ min-width:0; }
  .sel-title{ margin:0 0 2px; font-weight:700; font-size:16px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
  .sel-artist{ margin:0; color:#555; font-size:13px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }

  .status{ margin-top:6px; font-size:13px; color:#616161; min-height:0; }
  .status:empty{ margin-top:0; }

  /* Submit */
  .btn{ height:46px; padding:0 20px; border:1px solid #111; background:#111; color:#fff; border-radius:10px; cursor:pointer; font-weight:700; letter-spacing:.03em; }
  .btn:hover{ filter:brightness(.95); }

  /* Thank you overlay */
  .ty-overlay{ position:fixed; inset:0; background:#fff; display:none; align-items:center; justify-content:center; z-index:9999; }
  .ty-wrap{ text-align:center; padding:24px; max-width:92vw; }
  .ty-icon{ width:96px; height:96px; margin:0 auto 22px; display:grid; place-items:center; border-radius:50%; background:#22c55e; box-shadow:0 6px 18px rgba(34,197,94,.35); color:#fff; font-size:48px; }
  .ty-title{ font-family:"TexGyreAdventorBold", Inter, system-ui; font-size:clamp(28px,7.8vw,56px); line-height:1.05; margin:0 0 8px; color:#0f172a;}
  .ty-sub{ font:500 16px/1.5 Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif; color:#64748b; margin:0;}
</style>
</head>
<body>
<div class="wrap">
  <div class="dce-logo"><img src="assets/client-logo.png" alt="David Charles Events" onerror="this.style.display='none'"></div>
  <div class="app-title">SONG REQUEST</div>

  <div class="row">
    <label for="yourName">What's your name?</label>
    <input type="text" id="yourName" autocomplete="name" />
  </div>

  <div class="row" style="margin-top:8px;">
    <label for="q">Search Song, Artist or Lyrics</label>
    <div class="field">
      <input id="q" class="search" type="text" placeholder="start typing..." autocomplete="off" inputmode="search" />
      <button id="clearBtn" class="clear" type="button" aria-label="Clear search">×</button>
    </div>

    <div id="results" class="results"></div>

    <div id="selected" class="selected" aria-live="polite" aria-atomic="true">
      <div class="sel-inner">
        <div id="selCover" class="sel-cover" aria-hidden="true">♪</div>
        <div class="sel-text">
          <p id="selTitle" class="sel-title"></p>
          <p id="selArtist" class="sel-artist"></p>
        </div>
      </div>
    </div>

    <div id="status" class="status"></div>
  </div>

  <!-- Hidden fields to store chosen song -->
  <input type="hidden" id="songTitle" />
  <input type="hidden" id="artist" />
  <input type="hidden" id="link" />

  <div class="row" style="margin-top:10px;">
    <button id="submitBtn" class="btn">Submit</button>
  </div>
</div>

<!-- Thank You -->
<div class="ty-overlay" id="tyOverlay" role="dialog" aria-live="polite" aria-modal="true">
  <div class="ty-wrap">
    <div class="ty-icon">✓</div>
    <h1 class="ty-title">Got it!</h1>
    <p class="ty-sub">If it fits the flow, we’ll get it on. Let’s party.</p>
  </div>
</div>

<script>
/* ===================== CONFIG ===================== */
/* Your Google Apps Script deployment URL (JSONP endpoint) */
const ENDPOINT_URL = 'https://script.google.com/macros/s/AKfycbxZ9ylpDohWZnp1Krsn9THEPEciFv68uBB5unr0a41qNTesaOBkCWsQOeiucY4asIYH5A/exec';
/* ================================================== */

/* Event code: prefer ?event= on this page; else try referrer (for iframe embeds) */
const urlp = new URLSearchParams(location.search);
let EVENT_CODE = (urlp.get('event') || '').trim();
if (!EVENT_CODE && document.referrer) {
  try { const ref = new URL(document.referrer); const refEvent = ref.searchParams.get('event'); if (refEvent) EVENT_CODE = refEvent.trim(); } catch {}
}

/* DOM */
const $ = (s)=>document.querySelector(s);
const nameInput  = $('#yourName');
const q          = $('#q');
const clearBtn   = $('#clearBtn');
const resultsEl  = $('#results');
const selectedBox= $('#selected');
let   selCoverEl = $('#selCover');
const selTitle   = $('#selTitle');
const selArtist  = $('#selArtist');
const statusEl   = $('#status');
const titleInput = $('#songTitle');
const artistInput= $('#artist');
const linkInput  = $('#link');
const submitBtn  = $('#submitBtn');
const tyOverlay  = $('#tyOverlay');

/* Helpers */
function setStatus(m='',err=false){ statusEl.textContent=m; statusEl.style.color=err?'#b00020':'#616161'; }
function clearResults(){ resultsEl.innerHTML=''; }
function showResults(){ resultsEl.classList.remove('hidden'); }
function hideResults(){ resultsEl.classList.add('hidden'); clearResults(); }
function hideSelected(){
  selectedBox.style.display='none'; selectedBox.classList.remove('active');
  if(selCoverEl && selCoverEl.tagName.toLowerCase()==='img'){ selCoverEl.outerHTML=`<div id="selCover" class="sel-cover" aria-hidden="true">♪</div>`; selCoverEl=document.getElementById('selCover'); }
  selTitle.textContent=''; selArtist.textContent='';
}

/* Search (fetch-first with JSONP fallback) */
let debounce=null,lastTerm='';

function jsonp(url, cbParam='callback'){
  return new Promise((res,rej)=>{
    const cb='cb_'+Math.random().toString(36).slice(2);
    const s=document.createElement('script');
    s.src = url + (url.includes('?')?'&':'?') + cbParam + '=' + cb;
    const kill=setTimeout(()=>{ cleanup(); rej(new Error('timeout')); }, 9000);
    function cleanup(){ clearTimeout(kill); try{ delete window[cb]; }catch{} s.remove(); }
    window[cb] = (data)=>{ cleanup(); res(data); };
    s.onerror  = ()=>{ cleanup(); rej(new Error('jsonp error')); };
    document.body.appendChild(s);
  });
}

async function searchITunes(term){
  try{
    const r = await fetch(`https://itunes.apple.com/search?term=${encodeURIComponent(term)}&entity=musicTrack&limit=8`, {mode:'cors', cache:'no-store'});
    if (r.ok) {
      const data = await r.json();
      return (data?.results||[]).map(t=>({title:t.trackName, artist:t.artistName, cover:t.artworkUrl100||t.artworkUrl60, link:t.trackViewUrl}));
    }
  }catch(_e){}
  try{
    const data = await jsonp(`https://itunes.apple.com/search?term=${encodeURIComponent(term)}&entity=musicTrack&limit=8`, 'callback');
    return (data?.results||[]).map(t=>({title:t.trackName, artist:t.artistName, cover:t.artworkUrl100||t.artworkUrl60, link:t.trackViewUrl}));
  }catch(_e){}
  return [];
}
async function searchDeezer(term){
  try{
    const data=await jsonp(`https://api.deezer.com/search?q=${encodeURIComponent(term)}&limit=8&output=jsonp`,'callback');
    return (data?.data||[]).map(d=>({title:d.title, artist:d?.artist?.name||'', cover:d?.album?.cover_medium||d?.album?.cover||'', link:d.link||''}));
  }catch(_e){ return []; }
}
async function searchMB(term){
  try{
    const r=await fetch(`https://musicbrainz.org/ws/2/recording/?query=${encodeURIComponent(term)}&fmt=json&limit=8`,{
      headers:{'User-Agent':'DCE-SongRequest/1.0 (https://www.davidcharlesevents.com)'}, cache:'no-store'
    });
    if(!r.ok) return [];
    const data=await r.json();
    return (data.recordings||[]).map(rec=>{
      const ac=rec['artist-credit']; const artist=ac&&ac[0]&&ac[0].name?ac[0].name:'';
      return {title:rec.title, artist, cover:'', link:`https://musicbrainz.org/recording/${rec.id}`};
    });
  }catch(_e){ return []; }
}

function render(list){
  clearResults(); if(!list.length){ setStatus('No results'); return; } setStatus('');
  showResults();
  list.forEach(({title,artist,cover,link})=>{
    const div=document.createElement('div'); div.className='item'; div.setAttribute('role','button'); div.setAttribute('tabindex','0');
    const coverHTML=cover?`<img class="cover" src="${cover}" alt="Album cover">`:`<div class="cover" aria-hidden="true">♪</div>`;
    div.innerHTML=`${coverHTML}<div class="info"><p class="ttl">${title||'Unknown Title'}</p><p class="art">${artist||'Unknown Artist'}</p></div>`;
    const choose=()=>useSong({title,artist,cover,link}, div);
    div.onclick=choose; div.onkeyup=e=>{ if(e.key==='Enter'||e.key===' ') choose(); };
    resultsEl.appendChild(div);
  });
}

function showSelectedCard({title,artist,cover}){
  if(cover){
    const img=document.createElement('img'); img.src=cover; img.alt='Album cover'; img.className='sel-cover';
    if(selCoverEl) selCoverEl.replaceWith(img); selCoverEl=img;
  }else{
    if(!selCoverEl || selCoverEl.tagName.toLowerCase()==='img'){
      const box=document.createElement('div'); box.id='selCover'; box.className='sel-cover'; box.setAttribute('aria-hidden','true'); box.textContent='♪';
      if(selCoverEl) selCoverEl.replaceWith(box); selCoverEl=box;
    }
  }
  selTitle.textContent=title||'Unknown Title';
  selArtist.textContent=artist||'Unknown Artist';
  selectedBox.style.display='block'; selectedBox.classList.add('active');
}

function useSong({title,artist,cover,link}, el){
  document.querySelectorAll('.item').forEach(x=>x.classList.remove('selected')); el?.classList.add('selected');
  titleInput.value = title || '';
  artistInput.value = artist || '';
  linkInput.value = link || '';
  showSelectedCard({title,artist,cover,link}); hideResults();
}

async function doSearch(term){
  if(!term){ setStatus(''); hideResults(); return; }
  setStatus('Searching…');
  let list = await searchITunes(term);
  if (!list.length) list = await searchDeezer(term);
  if (!list.length) list = await searchMB(term);
  if (list.length) render(list); else { setStatus('No results', false); hideResults(); }
}

/* Search events */
q.addEventListener('focus', ()=>{ clearBtn.classList.add('show'); });
q.addEventListener('input', ()=>{
  const raw=q.value; if (raw.length>=1) clearBtn.classList.add('show'); else clearBtn.classList.remove('show');
  const t=raw.trim(); if(t===lastTerm) return; lastTerm=t;
  clearTimeout(debounce); debounce=setTimeout(()=>doSearch(t), 260);
});
q.addEventListener('keydown', e=>{ if(e.key==='Enter'){ e.preventDefault(); doSearch(q.value.trim()); }});
clearBtn.addEventListener('click', ()=>{
  q.value=''; lastTerm=''; clearBtn.classList.remove('show'); setStatus(''); hideResults(); hideSelected();
  titleInput.value=''; artistInput.value=''; linkInput.value='';
  q.focus({preventScroll:true});
});

/* Submit */
function openThankYou(){ tyOverlay.style.display='flex'; }
function writeRequest(){
  const nameVal = (nameInput.value || '').trim();
  const titleVal= (titleInput.value || '').trim();
  const artistVal=(artistInput.value || '').trim();
  const linkVal = (linkInput.value || '').trim();

  if (!titleVal && !artistVal) { nameInput.focus(); return; }

  const qs = new URLSearchParams({
    mode: 'write',
    event: EVENT_CODE || '',
    name: nameVal,
    song_title: titleVal,
    artist: artistVal,
    link: linkVal,
    ua: navigator.userAgent,
    referer: document.referrer || location.href
  });

  const cb = 'cb_' + Math.random().toString(36).slice(2);
  window[cb] = (data)=>{ try{ delete window[cb]; }catch{} openThankYou(); };
  const s = document.createElement('script');
  s.src = ENDPOINT_URL + '?' + qs.toString() + '&callback=' + cb;
  s.onerror = ()=>{ try{ delete window[cb]; }catch{} openThankYou(); };
  document.body.appendChild(s);
}
submitBtn.addEventListener('click', writeRequest);

/* Init */
window.addEventListener('load', ()=>{ nameInput.focus({preventScroll:true}); });
</script>
</body>
</html>

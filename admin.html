<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>DCE • Events Admin + QR</title>
<style>
  :root{ --ink:#0f172a; --sub:#475569; --border:#e2e8f0; --bg:#f8fafc; --card:#ffffff; --accent:#111; --radius:14px; }
  *{ box-sizing:border-box; }
  body{ margin:0; font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif; background:var(--bg); color:var(--ink); }
  .wrap{ max-width:1100px; margin:0 auto; padding:22px 14px 44px; }
  h1{ margin:0 0 10px; font-size:28px; line-height:1.1; }
  h2{ margin:18px 0 10px; font-size:18px; }
  .sub{ color:var(--sub); margin:2px 0 16px; }
  .card{ background:var(--card); border:1px solid var(--border); border-radius:var(--radius); padding:16px; }
  label{ display:block; font-size:13px; color:var(--sub); margin:12px 0 6px; }
  input[type="text"], input[type="date"], input[type="password"], select{
    width:100%; height:44px; border:1px solid var(--border); border-radius:10px; padding:0 12px; font-size:15px;
  }
  .row{ display:flex; gap:10px; flex-wrap:wrap; }
  .half{ flex:1 1 260px; }
  .btn{ height:44px; padding:0 16px; border:1px solid var(--border); background:var(--accent); color:#fff; border-radius:10px; cursor:pointer; }
  .btn.secondary{ background:#fff; color:#111; }
  .muted{ color:#64748b; font-size:12px; }
  .mono{ font-family:ui-monospace, Menlo, Consolas, monospace; }
  table{ width:100%; border-collapse:collapse; }
  th, td{ border-bottom:1px solid var(--border); text-align:left; padding:10px 8px; font-size:14px; }
  th{ color:#475569; font-size:12px; text-transform:uppercase; letter-spacing:.02em; }
  .tag{ display:inline-block; padding:3px 8px; border-radius:999px; border:1px solid var(--border); font-size:12px; }
  .qr-grid{ display:grid; gap:14px; grid-template-columns:repeat(auto-fit, minmax(240px, 1fr)); margin-top:10px; }
  .qr-card{ background:#fff; border:1px solid var(--border); border-radius:12px; padding:12px; display:flex; flex-direction:column; align-items:center; }
  .qr-box{ width:220px; height:220px; display:grid; place-items:center; background:#fff; }
  .qr-title{ font-weight:600; margin:6px 0 2px; text-align:center; }
  .qr-url{ font-size:11px; color:#64748b; text-align:center; word-break:break-all; }
</style>
</head>
<body>
<div class="wrap">
  <h1>Events Admin</h1>
  <p class="sub">Create events, toggle <strong>Active</strong>, and generate per-event QR codes for Guests and DJ View.</p>

  <div class="card">
    <h2>Create / Update Event</h2>
    <div class="row">
      <div class="half">
        <label for="eventDate">Event date</label>
        <input type="date" id="eventDate" />
      </div>
      <div class="half">
        <label for="eventName">Event name</label>
        <input type="text" id="eventName" placeholder="e.g., Lake House Wedding" />
      </div>
    </div>
    <label for="eventCode">Event code (auto or edit)</label>
    <input type="text" id="eventCode" placeholder="Will auto-generate from date + name" />
    <div class="row" style="align-items:center;">
      <div class="half">
        <label><input type="checkbox" id="eventActive" /> Active</label>
      </div>
      <div class="half" style="display:flex; gap:10px; justify-content:flex-end;">
        <input type="password" id="adminKey" placeholder="Admin Key (from Code.gs)" />
        <button class="btn secondary" id="btnPreview">Preview code</button>
        <button class="btn" id="btnSave">Save Event</button>
      </div>
    </div>
    <div class="muted" id="status"></div>
  </div>

  <div class="card" style="margin-top:16px;">
    <h2>Active Events (what DJ sees)</h2>
    <table>
      <thead><tr><th>Code</th><th>Name</th><th>Date</th><th>Status</th><th>Actions</th></tr></thead>
      <tbody id="eventsTbody"></tbody>
    </table>
  </div>

  <div class="card" style="margin-top:16px;">
    <h2>QR Codes</h2>
    <div class="row">
      <div class="half">
        <label for="baseUrl">Base URL</label>
        <select id="baseUrl">
          <option value="https://www.davidcharlesevents.com/song-request">davidcharlesevents.com/song-request (iframe)</option>
          <option value="https://buckna5ty.github.io/song-request/">buckna5ty.github.io/song-request (direct)</option>
        </select>
      </div>
      <div class="half" style="display:flex; gap:10px; align-items:flex-end; justify-content:flex-end;">
        <button class="btn secondary" id="btnQrPreview">Preview for current code</button>
        <button class="btn" id="btnQrDownloadAll">Download both PNGs</button>
      </div>
    </div>
    <div class="qr-grid" id="qrGrid"></div>
  </div>
</div>

<script>
/* ------------ Config ------------ */
const ENDPOINT_URL = 'https://script.google.com/macros/s/AKfycbzRjQFNePsGmd5c-edTvgrzfLrtn21b1ZZBZKcKQ0OeIEwo1jeIpRCMAjxP6zHtJ1u9rg/exec';

/* ------------ DOM ------------ */
const $ = s => document.querySelector(s);
const eventDate = $('#eventDate');
const eventName = $('#eventName');
const eventCode = $('#eventCode');
const eventActive = $('#eventActive');
const adminKey = $('#adminKey');
const statusEl = $('#status');
const eventsTbody = $('#eventsTbody');

const baseUrlSel = $('#baseUrl');
const qrGrid = $('#qrGrid');
const btnPreview = $('#btnPreview');
const btnSave = $('#btnSave');
const btnQrPreview = $('#btnQrPreview');
const btnQrDownloadAll = $('#btnQrDownloadAll');

/* ------------ Helpers ------------ */
function setStatus(msg){ statusEl.textContent = msg || ''; }
function slugify(str){
  return (str || '')
    .normalize('NFKD').replace(/[\u0300-\u036f]/g,'')
    .replace(/[^a-zA-Z0-9]+/g,'_').replace(/^_+|_+$/g,'').replace(/_{2,}/g,'_');
}
function makeCode(){
  const d = eventDate.value; // yyyy-mm-dd
  const n = eventName.value;
  if(!d && !n) return '';
  let ymd = '';
  if(d && /^\d{4}-\d{2}-\d{2}$/.test(d)){ ymd = d.replaceAll('-',''); }
  const slug = slugify(n);
  return [slug, ymd].filter(Boolean).join('_');
}
function jsonp(url, cbParam='callback'){
  return new Promise((resolve, reject)=>{
    const cb='cb_'+Math.random().toString(36).slice(2);
    const sep = url.includes('?') ? '&' : '?';
    const src=`${url}${sep}${cbParam}=${cb}`;
    const s=document.createElement('script');
    const kill=setTimeout(()=>{cleanup(); reject(new Error('timeout'));},9000);
    function cleanup(){ clearTimeout(kill); try{delete window[cb];}catch{} s.parentNode&&s.parentNode.removeChild(s); }
    window[cb]=(data)=>{ cleanup(); resolve(data); };
    s.onerror=()=>{ cleanup(); reject(new Error('jsonp error')); };
    s.src=src; document.body.appendChild(s);
  });
}

/* ------------ Events table ------------ */
async function loadEvents(){
  eventsTbody.innerHTML = '<tr><td colspan="5">Loading…</td></tr>';
  try{
    const data = await jsonp(`${ENDPOINT_URL}?mode=events_list&active=0`, 'callback'); // all
    const list = (data && data.ok && Array.isArray(data.events)) ? data.events : [];
    if(!list.length){ eventsTbody.innerHTML = '<tr><td colspan="5">No events yet.</td></tr>'; return; }
    eventsTbody.innerHTML = '';
    list.forEach(ev=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td class="mono">${ev.code}</td>
        <td>${ev.name || ''}</td>
        <td>${ev.date || ''}</td>
        <td>${ev.active ? '<span class="tag">Active</span>' : '<span class="tag" style="opacity:.6;">Inactive</span>'}</td>
        <td>
          <button class="btn secondary" data-act="toggle" data-code="${ev.code}" data-active="${ev.active ? 0 : 1}">${ev.active ? 'Set Inactive' : 'Set Active'}</button>
        </td>
      `;
      eventsTbody.appendChild(tr);
    });
    // bind toggle buttons
    eventsTbody.querySelectorAll('button[data-act="toggle"]').forEach(btn=>{
      btn.addEventListener('click', async ()=>{
        const code = btn.getAttribute('data-code');
        const active = btn.getAttribute('data-active');
        const adm = (adminKey.value || '').trim();
        if(!adm){ alert('Enter your Admin Key (top section)'); return; }
        try{
          const qs = new URLSearchParams({ mode:'events_set_active', code, active, admin:adm });
          const res = await jsonp(`${ENDPOINT_URL}?${qs.toString()}`, 'callback');
          if(res && res.ok){ loadEvents(); }
          else{ alert('Unauthorized or server error. Check Admin Key.'); }
        }catch{ alert('Failed to reach server.'); }
      });
    });
  }catch{
    eventsTbody.innerHTML = '<tr><td colspan="5">Failed to load.</td></tr>';
  }
}

/* ------------ Create/Update ------------ */
btnPreview.addEventListener('click', (e)=>{ e.preventDefault(); if(!eventCode.value) eventCode.value = makeCode(); setStatus('Generated code; you can edit before saving.'); });
btnSave.addEventListener('click', async (e)=>{
  e.preventDefault();
  let code = (eventCode.value || makeCode() || '').trim();
  const name = (eventName.value || '').trim();
  const date = (eventDate.value || '').trim();
  const active = eventActive.checked ? '1' : '0';
  const adm = (adminKey.value || '').trim();
  if(!code){ setStatus('Please provide date/name to generate a code, or type a code.'); return; }
  if(!adm){ setStatus('Please enter your Admin Key.'); return; }
  setStatus('Saving…');
  try{
    const qs = new URLSearchParams({ mode:'events_add', code, name, date, active, admin:adm });
    const res = await jsonp(`${ENDPOINT_URL}?${qs.toString()}`, 'callback');
    if(res && res.ok){ setStatus('Saved.'); loadEvents(); buildQrFor(code); }
    else{ setStatus('Unauthorized or server error.'); }
  }catch{ setStatus('Failed to reach server.'); }
});

/* ------------ QR Generation ------------ */
// For simplicity and reliability we use Google Chart image API to render QR into canvas
function makeQrToCanvas(text, size, canvas) {
  const url = 'https://chart.googleapis.com/chart?cht=qr&chs=' + size + 'x' + size + '&chl=' + encodeURIComponent(text);
  const ctx = canvas.getContext('2d');
  const img = new Image(); img.crossOrigin='anonymous';
  img.onload = function(){ canvas.width=size; canvas.height=size; ctx.fillStyle='#fff'; ctx.fillRect(0,0,size,size); ctx.drawImage(img,0,0,size,size); };
  img.src = url;
}
function buildQrCards(code) {
  const grid = qrGrid; grid.innerHTML = '';
  if(!code){ const d=document.createElement('div'); d.className='muted'; d.textContent='Save or select an event to preview QR.'; grid.appendChild(d); return; }
  const base = baseUrlSel.value.replace(/\/+$/,'') + '/';
  const items = [
    { title:'Guest (event param)', url: `${base}?event=${encodeURIComponent(code)}` },
    { title:'DJ View (event param)', url: `${base}dj.html?event=${encodeURIComponent(code)}` }
  ];
  for(const it of items){
    const card=document.createElement('div'); card.className='qr-card';
    const box=document.createElement('div'); box.className='qr-box';
    const canvas=document.createElement('canvas'); box.appendChild(canvas);
    const ttl=document.createElement('div'); ttl.className='qr-title'; ttl.textContent=it.title;
    const url=document.createElement('div'); url.className='qr-url'; url.textContent=it.url;
    const dl=document.createElement('button'); dl.className='btn secondary'; dl.textContent='Download PNG';
    dl.addEventListener('click', ()=>{
      makeQrToCanvas(it.url, 1024, canvas);
      setTimeout(()=>{
        const a=document.createElement('a'); a.href=canvas.toDataURL('image/png');
        const safe = (code + '-' + it.title).toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/^-+|-+$/g,'');
        a.download = `${safe}.png`; a.click();
      },300);
    });
    makeQrToCanvas(it.url, 220, canvas);
    card.appendChild(box); card.appendChild(ttl); card.appendChild(url); card.appendChild(dl);
    grid.appendChild(card);
  }
}
function buildQrFor(code){ buildQrCards(code); }
btnQrPreview.addEventListener('click', (e)=>{ e.preventDefault(); const code=(eventCode.value||'').trim(); buildQrFor(code); });
btnQrDownloadAll.addEventListener('click', (e)=>{ e.preventDefault(); qrGrid.querySelectorAll('button').forEach(b=>b.click()); });

/* ------------ Init ------------ */
window.addEventListener('load', ()=>{ loadEvents(); });
</script>
</body>
</html>

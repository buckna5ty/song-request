<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>DCE • Admin</title>
<style>
  :root{ --ink:#0f172a; --sub:#475569; --muted:#64748b; --border:#e2e8f0; --bg:#f8fafc; --card:#ffffff; --accent:#0ea5a6; --danger:#b91c1c; }
  *{ box-sizing:border-box; } body{ margin:0; font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif; background:var(--bg); color:var(--ink); }
  .wrap{ max-width:1100px; margin:0 auto; padding:18px 14px 40px; }
  h1{ margin:0 0 14px; font-size:28px; }
  h2{ margin:16px 0 10px; font-size:18px; color:var(--sub); }
  .row{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
  .card{ background:var(--card); border:1px solid var(--border); border-radius:14px; padding:14px; }
  .grid{ display:grid; gap:14px; grid-template-columns:1fr; }
  @media (min-width:980px){ .grid{ grid-template-columns:1fr 1fr; } }

  label{ display:block; font-size:13px; color:var(--sub); margin:6px 0 4px; }
  input[type="text"], input[type="date"]{ width:100%; height:42px; padding:0 12px; border:1px solid var(--border); border-radius:10px; background:#fff; font-size:15px; }
  .btn{ height:40px; padding:0 14px; border:1px solid #111; background:#111; color:#fff; border-radius:10px; cursor:pointer; font-weight:600; }
  .btn.secondary{ background:#fff; color:#111; border-color:var(--border); }
  .btn.accent{ background:var(--accent); border-color:var(--accent); }
  .btn.danger{ background:var(--danger); border-color:var(--danger); }
  .btn.small{ height:34px; padding:0 10px; font-size:13px; }

  .event{ border:1px solid var(--border); border-radius:12px; padding:12px; margin-bottom:10px; background:#fff; }
  .event .title{ font-weight:700; margin:0 0 6px; }
  .event .muted{ color:var(--muted); font-size:12px; }
  .stack{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
  .qr-wrap{ display:flex; gap:10px; align-items:center; margin-top:8px; }
  .qr-img{ width:160px; height:160px; border:1px solid var(--border); border-radius:10px; background:#fff; object-fit:contain; }

  .pill{ display:inline-block; padding:6px 10px; border:1px solid var(--border); border-radius:999px; font-size:12px; background:#fff; color:#0f766e; }
  .status{ color:var(--muted); font-size:12px; margin-left:auto; }
  .sep{ height:10px; }
</style>
</head>
<body>
<div class="wrap">
  <h1>Admin</h1>
  <div class="row">
    <span class="pill" id="envPill">Guest base: requests.davidcharlesevents.com</span>
    <span class="status" id="status"></span>
  </div>

  <div class="grid" style="margin-top:8px;">
    <!-- Create Event -->
    <div class="card">
      <h2>Create Event</h2>
      <label for="evDate">Event date</label>
      <input type="date" id="evDate" />
      <label for="evName">Event name</label>
      <input type="text" id="evName" placeholder="e.g., Holbert & Scally Wedding" />
      <label for="evCode">Event code (auto, editable)</label>
      <input type="text" id="evCode" placeholder="holbert_scally_wedding_20251101" />
      <div class="row" style="margin-top:10px;">
        <button id="btnPreviewCode" class="btn secondary">Preview for current code</button>
        <button id="btnCreate" class="btn accent">Add To Active Events</button>
      </div>
      <div id="createMsg" class="muted" style="margin-top:8px;"></div>
    </div>

    <!-- Active Events -->
    <div class="card">
      <h2>Active Events</h2>
      <div id="eventsBox" class="muted">Loading…</div>
    </div>
  </div>
</div>

<script>
/* ---------- CONFIG ---------- */
const ENDPOINT_URL   = 'https://script.google.com/macros/s/AKfycbxZ9ylpDohWZnp1Krsn9THEPEciFv68uBB5unr0a41qNTesaOBkCWsQOeiucY4asIYH5A/exec';
const BASE_GUEST_URL = 'https://requests.davidcharlesevents.com/';
/* --------------------------- */

const $ = s => document.querySelector(s);
const statusEl = $('#status'), eventsBox = $('#eventsBox');
const evDate = $('#evDate'), evName = $('#evName'), evCode = $('#evCode');
const btnCreate = $('#btnCreate'), btnPreviewCode = $('#btnPreviewCode'), createMsg = $('#createMsg');

function setStatus(m){ statusEl.textContent = m || ''; }
function eventUrl(code){ return `${BASE_GUEST_URL}?event=${encodeURIComponent(code)}`; }

function slugify(s){
  return String(s||'').trim()
    .toLowerCase()
    .replace(/&/g,' and ')
    .replace(/[^a-z0-9]+/g,'_')
    .replace(/_+/g,'_')
    .replace(/^_|_$/g,'');
}
function yyyymmddFromInput(d){
  if(!d) return '';
  const dt = new Date(d);
  if (isNaN(dt)) return '';
  const y=dt.getFullYear(), m=String(dt.getMonth()+1).padStart(2,'0'), day=String(dt.getDate()).padStart(2,'0');
  return `${y}${m}${day}`;
}
function autoCode(){
  const name = slugify(evName.value);
  const d    = yyyymmddFromInput(evDate.value);
  let code = name;
  if (d) code = code ? `${code}_${d}` : d;
  evCode.value = code;
}
evName.addEventListener('input', autoCode);
evDate.addEventListener('change', autoCode);

/* ---- JSONP helper ---- */
function jsonp(url){
  return new Promise((resolve,reject)=>{
    const cb='cb_'+Math.random().toString(36).slice(2);
    const s=document.createElement('script');
    s.src = url + (url.includes('?')?'&':'?') + 'callback=' + cb;
    const kill=setTimeout(()=>{ cleanup(); reject(new Error('timeout')); }, 9000);
    function cleanup(){ clearTimeout(kill); try{ delete window[cb]; }catch{} s.remove(); }
    window[cb]=(data)=>{ cleanup(); resolve(data); };
    s.onerror=()=>{ cleanup(); reject(new Error('jsonp error')); };
    document.body.appendChild(s);
  });
}

/* ---- API wrappers ---- */
async function listEvents(){
  try{
    const r = await jsonp(`${ENDPOINT_URL}?mode=events_list&active=1`);
    if(r && r.ok) return r.events || [];
  }catch(e){}
  return [];
}
async function addEvent(code, name, dateISO){
  const qs = new URLSearchParams({ mode:'events_add', code, name, date: dateISO, active:'1' });
  try{
    const r = await jsonp(`${ENDPOINT_URL}?${qs.toString()}`);
    return !!(r && r.ok);
  }catch(e){ return false; }
}
async function deleteEventAndData(code){
  // Try common backends; succeed if any returns ok:true
  const tries = [
    `${ENDPOINT_URL}?mode=events_delete&code=${encodeURIComponent(code)}&purge=1`,
    `${ENDPOINT_URL}?mode=delete_event_and_data&code=${encodeURIComponent(code)}`,
    `${ENDPOINT_URL}?mode=events_delete&code=${encodeURIComponent(code)}`
  ];
  for (const u of tries){
    try { const r = await jsonp(u); if (r && r.ok) return true; } catch(e){}
  }
  return false;
}
async function readAllRows(code, limit=5000){
  try{
    const r = await jsonp(`${ENDPOINT_URL}?mode=read&event=${encodeURIComponent(code)}&limit=${limit}`);
    if (r && r.ok && Array.isArray(r.rows)) return r.rows;
  }catch(e){}
  return [];
}

/* ---- CSV exporter ---- */
function toCSV(rows){
  const headers = ['Timestamp','Name','Song Title','Artist','Link','Event','ID','Played'];
  const esc = v => {
    const s = (v==null?'':String(v));
    if (/[",\n]/.test(s)) return `"${s.replace(/"/g,'""')}"`;
    return s;
  };
  const lines = [headers.join(',')];
  rows.forEach(r=>{
    lines.push([
      r.timestamp||'',
      r.name||'',
      r.song_title||'',
      r.artist||'',
      r.link||'',
      r.event||'',
      r.id||'',
      r.played?1:0
    ].map(esc).join(','));
  });
  return lines.join('\n');
}
async function downloadCSV(code){
  setStatus(`Exporting CSV for ${code}…`);
  const rows = await readAllRows(code);
  const csv  = toCSV(rows);
  const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
  const url  = URL.createObjectURL(blob);
  const a    = document.createElement('a');
  a.href = url; a.download = `${code}_requests.csv`;
  document.body.appendChild(a); a.click(); a.remove();
  URL.revokeObjectURL(url);
  setStatus(`Exported ${rows.length} rows for ${code}.`);
}

/* ---- QR helpers (api.qrserver.com) ---- */
function qrUrl(data, size=512){ return `https://api.qrserver.com/v1/create-qr-code/?size=${size}x${size}&format=png&data=${encodeURIComponent(data)}`; }
async function downloadQR(data, filename='qr.png'){
  const url = qrUrl(data, 1024);
  try{
    const r = await fetch(url, {mode:'cors'});
    const blob = await r.blob();
    const obj  = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href=obj; a.download=filename; document.body.appendChild(a); a.click(); a.remove();
    URL.revokeObjectURL(obj);
  }catch(e){
    // Fallback: open in new tab
    window.open(url, '_blank');
  }
}

/* ---- UI: render active events ---- */
function eventRow(ev){
  const div = document.createElement('div'); div.className='event';
  const code = ev.code; const name = ev.name || code; const date = ev.date || '';
  const link = eventUrl(code);

  div.innerHTML = `
    <div class="title">${name}</div>
    <div class="muted">${code}${date ? ' • ' + date : ''}</div>
    <div class="sep"></div>
    <div class="stack">
      <button class="btn small secondary" data-act="copy">Copy link</button>
      <button class="btn small secondary" data-act="preview">Preview</button>
      <button class="btn small secondary" data-act="showqr">Show QR</button>
      <button class="btn small secondary" data-act="dlqr">Download QR PNG</button>
      <button class="btn small secondary" data-act="csv">Download CSV</button>
      <button class="btn small danger"    data-act="delete">Delete Event</button>
      <span class="status" data-role="status"></span>
    </div>
    <div class="qr-wrap" data-role="qrwrap" style="display:none;">
      <img class="qr-img" data-role="qrimg" alt="QR code" />
      <div class="muted">This QR opens:<br><a href="${link}" target="_blank" rel="noopener">${link}</a></div>
    </div>
  `;

  const st = div.querySelector('[data-role="status"]');
  function setRowStatus(m){ st.textContent = m || ''; }

  div.addEventListener('click', async (e)=>{
    const b = e.target.closest('button'); if(!b) return;
    const act = b.getAttribute('data-act');
    if (act==='copy'){
      try{ await navigator.clipboard.writeText(link); setRowStatus('Copied!'); setTimeout(()=>setRowStatus(''),1200);}catch{ setRowStatus('Copy failed'); }
    }
    if (act==='preview'){ window.open(link,'_blank','noopener'); }
    if (act==='showqr'){
      const img = div.querySelector('[data-role="qrimg"]');
      const wrap= div.querySelector('[data-role="qrwrap"]');
      img.src = qrUrl(link, 512);
      wrap.style.display = 'flex';
    }
    if (act==='dlqr'){
      setRowStatus('Downloading QR…');
      await downloadQR(link, `${code}_qr.png`);
      setRowStatus('');
    }
    if (act==='csv'){ await downloadCSV(code); }
    if (act==='delete'){
      if (!confirm(`Delete event "${name}" and its data? This cannot be undone.`)) return;
      setRowStatus('Deleting…');
      const ok = await deleteEventAndData(code);
      if (ok){ setRowStatus('Deleted'); await refreshEvents(); }
      else { setRowStatus('Delete failed'); }
    }
  });

  return div;
}

async function refreshEvents(){
  setStatus('Loading active events…');
  const list = await listEvents();
  eventsBox.innerHTML = '';
  if (!list.length){ eventsBox.textContent = 'No Active Events.'; setStatus(''); return; }
  list.forEach(ev=> eventsBox.appendChild(eventRow(ev)));
  setStatus('');
}

/* ---- Create flow ---- */
btnCreate.addEventListener('click', async ()=>{
  const name = (evName.value||'').trim();
  const date = evDate.value || '';
  autoCode(); const code = (evCode.value||'').trim();

  if (!code){ createMsg.textContent='Please enter a valid event code.'; return; }
  createMsg.textContent='Saving…';
  const ok = await addEvent(code, name, date);
  if (ok){
    createMsg.textContent='Added to Active Events.';
    evName.value=''; evDate.value=''; evCode.value='';
    await refreshEvents();
  }else{
    createMsg.textContent='Save failed.';
  }
});

btnPreviewCode.addEventListener('click', ()=>{
  autoCode();
  const code = (evCode.value||'').trim(); if(!code) return;
  window.open(eventUrl(code), '_blank', 'noopener');
});

/* ---- Start ---- */
window.addEventListener('load', ()=>{
  autoCode();
  refreshEvents();
  // periodic refresh of active events list
  setInterval(refreshEvents, 30000);
});
</script>
</body>
</html>


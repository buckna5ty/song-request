<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>DCE • EVENT SETUP</title>

<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#212121;
    --section:#363636;     /* section background */
    --surface:#424242;     /* not used much here, but matches DJ */
    --border:#3a3a3a;
    --ink:#f2f2f2;
    --muted:#e6e6e6;
    --accent:#1dcec9;
    --ring:rgba(255,255,255,.22);

    --r-lg:16px; --r-md:12px; --w:980px;

    --font-head:"Adventor", "Roboto", system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
    --font-ui:"Roboto", system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
  }

  @font-face{
    font-family:"Adventor";
    src:url("texgyreadventor-regular.otf") format("opentype");
    font-weight:400; font-style:normal; font-display:swap;
  }

  *{ box-sizing:border-box; }
  html,body{ margin:0; background:var(--bg); color:var(--ink); font-family:var(--font-ui); font-weight:300; }

  .wrap{ max-width:var(--w); margin:0 auto; padding:18px 12px 64px; }
  .title{
    text-align:center; margin:8px 0 18px; letter-spacing:.04em;
    font-family:var(--font-head); font-weight:400; font-size:clamp(22px,5.4vw,36px);
  }

  .grid{ display:grid; grid-template-columns:1fr; gap:16px; }
  @media(min-width:900px){ .grid{ grid-template-columns:1fr 1fr; } }

  .card{
    background:var(--section); border:1px solid var(--border); border-radius:var(--r-lg); padding:16px;
    box-shadow:0 4px 14px rgba(0,0,0,.25);
  }
  .card h2{ margin:0 0 12px; font-size:18px; font-weight:400; }

  .field{ margin-bottom:10px; }
  .label{ display:block; font-size:13px; color:var(--muted); margin:0 0 6px; font-weight:300; }
  .input, .date, .select, .market{
    width:100%; height:46px; padding:0 14px; border:1px solid var(--border); border-radius:12px;
    background:#2b2b2b; color:#fff; outline:none; font-size:16px; transition: box-shadow .12s ease, border-color .12s ease;
  }
  .input:focus, .date:focus, .select:focus, .market:focus{ border-color:#e6e6e6; box-shadow:0 0 0 3px var(--ring); }
  .row{ display:flex; gap:10px; } .row > *{ flex:1; }

  .btn{
    height:44px; padding:0 14px; border:1px solid var(--accent); background:var(--accent); color:#000;
    border-radius:12px; cursor:pointer; user-select:none; display:inline-flex; align-items:center; justify-content:center; gap:8px;
    transition:transform .06s ease, filter .15s ease, box-shadow .06s ease;
    box-shadow:0 2px 0 rgba(0,0,0,.35), 0 10px 18px rgba(0,0,0,.15);
    font-weight:400; letter-spacing:.02em;
  }
  .btn:hover{ filter:brightness(1.05); }
  .btn:active{ transform:translateY(1px); box-shadow:inset 0 2px 0 rgba(0,0,0,.25); }
  .btn.secondary{ background:#4f4f4f; color:#fff; border-color:#4a4a4a; }
  .btn.warn{ background:#ef4444; border-color:#ef4444; color:#fff; }
  .small{ height:38px; padding:0 12px; border-radius:10px; }

  .events{ display:flex; flex-direction:column; gap:12px; }
  .event{ border:1px solid var(--border); border-radius:12px; background:#4a4a4a; padding:12px; }
  .event-h{ display:flex; align-items:baseline; justify-content:space-between; gap:10px; flex-wrap:wrap; }
  .event-title{ margin:0; font-weight:400; color:#fff; font-size:16px; }
  .event-actions{ display:flex; flex-wrap:wrap; gap:8px; margin-top:10px; align-items:center; }

  .qr-wrap{ margin-top:10px; display:none; }
  .qr-wrap.show{ display:block; }
  .qr{ background:#fff; border-radius:12px; padding:8px; display:inline-block; }

  .help{ font-size:12px; color:#f0f0f0; margin-top:6px; font-weight:300; }
  .status{ font-size:13px; color:#f0f0f0; min-height:18px; margin-top:8px; font-weight:300; }

  .gate{ position:fixed; inset:0; background:rgba(33,33,33,.98); display:flex; align-items:center; justify-content:center; z-index:9999; backdrop-filter:blur(2px); }
  .gate-card{ width:min(420px,90vw); background:var(--section); border:1px solid var(--border); border-radius:16px; padding:18px; text-align:center; box-shadow:0 12px 32px rgba(0,0,0,.35); }
  .gate-card h1{ margin:6px 0 12px; font-size:20px; font-weight:400; }
  .pin-input{ width:100%; letter-spacing:0.35em; text-align:center; font-weight:400; font-size:20px; }
  .err{ color:#ffb4b4; font-size:13px; min-height:16px; margin-top:6px; }
  .flex{ display:flex; gap:8px; flex-wrap:wrap; }
  .right{ margin-left:auto; }

  .kv{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin-top:8px; }
  .kv label{ font-size:12px; color:#f0f0f0; }
  .switch{ display:flex; align-items:center; gap:8px; }
  .switch input{ width:20px; height:20px; }
  .pill{ display:inline-block; padding:2px 8px; background:#2b2b2b; border-radius:999px; font-size:12px; }
</style>
</head>
<body>
<div class="gate" id="gate">
  <div class="gate-card">
    <h1>Enter Admin PIN</h1>
    <input id="pin" class="input pin-input" type="password" inputmode="numeric" placeholder="••••" maxlength="8" />
    <div class="flex" style="margin-top:12px; justify-content:center;">
      <button class="btn small" id="pinGo">Unlock</button>
    </div>
    <div id="pinErr" class="err"></div>
    <div class="help">Tip: PIN is saved on this device so you won’t be asked again.</div>
  </div>
</div>

<div class="wrap">
  <div class="title">EVENT SETUP</div>

  <div class="grid">
    <section class="card">
      <h2>Create Event</h2>
      <div class="field">
        <label class="label" for="evtDate">Event Date</label>
        <input id="evtDate" class="date" type="date" />
      </div>
      <div class="field">
        <label class="label" for="evtName">Event Name</label>
        <input id="evtName" class="input" type="text" placeholder="e.g. Holbert / Scally Wedding" />
      </div>
      <div class="row">
        <div class="field">
          <label class="label" for="evtProvider">Provider</label>
          <select id="evtProvider" class="select">
            <option value="apple">Apple Music</option>
            <option value="spotify">Spotify</option>
          </select>
        </div>
        <div class="field">
          <label class="label" for="evtMarket">Market (Country)</label>
          <input id="evtMarket" class="market" type="text" placeholder="US" value="US" />
        </div>
      </div>
      <div class="field switch">
        <input id="evtExplicit" type="checkbox" checked />
        <label for="evtExplicit">Allow Explicit</label>
      </div>
      <div class="row" style="margin-top:8px;">
        <button id="btnCreate" class="btn">Create Event</button>
        <button id="btnClear" class="btn secondary">Clear</button>
      </div>
      <div class="help">Provider controls which catalog guests search. Explicit OFF hides explicit tracks in live search.</div>
    </section>

    <section class="card">
      <h2>Active Events</h2>
      <div id="events" class="events"><div class="status">Loading…</div></div>
      <div class="row" style="margin-top:10px;">
        <button id="btnRefresh" class="btn secondary">Refresh</button>
      </div>
      <div class="help">Pills show Provider / Market / Explicit. Use “Save Settings” to update.</div>
    </section>
  </div>
</div>

<script>
const ENDPOINT_URL = 'https://script.google.com/macros/s/AKfycbxaN-0GQmvwy3G9GKD4hqZ1D6mjrIbBNDZZW-uGbuHIpiVTQ0BtOkmlQzSqjU6yjkmJ-g/exec';

/* FIXED: build guest link to /index.html?event=CODE (explicit, bulletproof) */
const GUEST_BASE = 'https://requests.davidcharlesevents.com/index.html';

const ADMIN_PIN = '9453';

/* ===== PIN gate ===== */
const gate = document.getElementById('gate');
const pinInput = document.getElementById('pin');
const pinGo = document.getElementById('pinGo');
const pinErr = document.getElementById('pinErr');
function unlockIfValid(pin){
  if (String(pin).trim() === ADMIN_PIN) { try{ localStorage.setItem('dce_admin_ok','1'); }catch{} gate.style.display='none'; }
  else { pinErr.textContent = 'Incorrect PIN.'; }
}
pinGo.addEventListener('click', ()=> unlockIfValid(pinInput.value));
pinInput.addEventListener('keydown', e=>{ if(e.key==='Enter') unlockIfValid(pinInput.value); });
window.addEventListener('load', ()=>{ try{ if(localStorage.getItem('dce_admin_ok')==='1') gate.style.display='none'; else pinInput.focus({preventScroll:true}); }catch{} });

/* ===== Mini JSONP helper ===== */
function jsonp(url, params = {}){
  const qs = new URLSearchParams(params);
  const cb = 'cb_'+Math.random().toString(36).slice(2);
  qs.set('callback', cb); qs.set('t', Date.now());
  return new Promise((res, rej)=>{
    const s=document.createElement('script');
    s.src = url + (url.includes('?') ? '&' : '?') + qs.toString();
    const kill = setTimeout(()=>{ cleanup(); rej(new Error('timeout')); }, 9000);
    function cleanup(){ clearTimeout(kill); try{ delete window[cb]; }catch{} s.remove(); }
    window[cb] = (d)=>{ cleanup(); res(d); };
    s.onerror = ()=>{ cleanup(); rej(new Error('jsonp')); };
    document.body.appendChild(s);
  });
}

const eventsEl = document.getElementById('events');
const evtName = document.getElementById('evtName');
const evtDate = document.getElementById('evtDate');
const evtProvider = document.getElementById('evtProvider');
const evtMarket = document.getElementById('evtMarket');
const evtExplicit = document.getElementById('evtExplicit');
const btnCreate = document.getElementById('btnCreate');
const btnClear = document.getElementById('btnClear');
const btnRefresh = document.getElementById('btnRefresh');

function slugify(name, date){
  const d = new Date(date);
  const y = String(d.getFullYear()).slice(-2);
  const m = String(d.getMonth()+1).padStart(2,'0');
  const day = String(d.getDate()).padStart(2,'0');
  const base = (name||'').toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/^-+|-+$/g,'').slice(0,24);
  return `${y}${m}${day}-${base||'event'}`;
}

/* now always builds https://requests.davidcharlesevents.com/index.html?event=CODE */
function guestUrlFor(code){
  const u = new URL(GUEST_BASE);
  u.searchParams.set('event', code);
  return u.toString();
}

function pill(text){ const s=document.createElement('span'); s.className='pill'; s.textContent=text; return s; }

async function refresh(){
  eventsEl.innerHTML = '<div class="status">Loading…</div>';
  try{
    const r = await jsonp(ENDPOINT_URL, {mode:'listActive'});
    const list = Array.isArray(r?.events) ? r.events : [];
    renderEvents(list);
  }catch{
    eventsEl.innerHTML = '<div class="status">Could not load events.</div>';
  }
}

function renderEvents(list){
  eventsEl.innerHTML = '';
  if(!list.length){ eventsEl.innerHTML = '<div class="status">No active events</div>'; return; }
  list.sort((a,b)=> new Date(b.date) - new Date(a.date));
  for(const ev of list){
    const card = document.createElement('div'); card.className='event';

    const h = document.createElement('div'); h.className='event-h';
    const title = document.createElement('h3'); title.className='event-title';
    const d = new Date(ev.date); const dstr = isNaN(d)?'':`${d.getMonth()+1}/${d.getDate()}/${d.getFullYear()}`;
    title.textContent = `${dstr} — ${ev.name}`;
    const pills = document.createElement('div');
    pills.append(
      pill((ev.provider||'apple').toUpperCase()),
      pill(ev.market||'US'),
      pill((ev.explicitAllowed?'Explicit ON':'Explicit OFF'))
    );
    h.append(title,pills);

    const kv = document.createElement('div'); kv.className='kv';
    // provider select
    const provL = document.createElement('label'); provL.textContent='Provider';
    const prov = document.createElement('select'); prov.className='select';
    prov.innerHTML = `<option value="apple">Apple Music</option><option value="spotify">Spotify</option>`;
    prov.value = (ev.provider||'apple');
    // market
    const mkL = document.createElement('label'); mkL.textContent='Market';
    const mk = document.createElement('input'); mk.className='market'; mk.value = (ev.market||'US');
    // explicit
    const exWrap = document.createElement('label'); exWrap.className='switch';
    const ex = document.createElement('input'); ex.type='checkbox'; ex.checked = !!ev.explicitAllowed;
    const exT = document.createElement('span'); exT.textContent='Allow Explicit';
    exWrap.append(ex, exT);

    // Save + Quick Links
    const actions = document.createElement('div'); actions.className='event-actions';
    const btnSave = document.createElement('button'); btnSave.className='btn small'; btnSave.textContent='Save Settings';
    const btnPrev = document.createElement('a'); btnPrev.className='btn secondary small'; btnPrev.textContent='Open Guest Page'; btnPrev.href=guestUrlFor(ev.code); btnPrev.target='_blank';
    const btnCopy = document.createElement('button'); btnCopy.className='btn secondary small'; btnCopy.textContent='Copy Link';
    btnCopy.onclick = ()=>{ navigator.clipboard.writeText(guestUrlFor(ev.code)); btnCopy.textContent='Copied'; setTimeout(()=>btnCopy.textContent='Copy Link', 1200); };

    // QR
    const btnQR=document.createElement('button'); btnQR.className='btn secondary small'; btnQR.textContent='QR';
    const qrC=document.createElement('div'); qrC.className='qr-wrap';
    const qrInner=document.createElement('div'); qrInner.className='qr';
    const qrImg=new Image(); qrImg.width=240; qrImg.height=240; qrInner.appendChild(qrImg); qrC.appendChild(qrInner);
    const helper=document.createElement('div'); helper.className='help'; helper.textContent='Scan to open guest page'; qrC.appendChild(helper);
    btnQR.onclick=()=>{
      qrC.classList.toggle('show');
      if(qrC.classList.contains('show')){
        const url = encodeURIComponent(guestUrlFor(ev.code));
        qrImg.src = `https://api.qrserver.com/v1/create-qr-code/?size=240x240&data=${url}`;
        qrImg.alt = `QR for ${ev.name}`;
      }
    };

    // Delete
    const btnDel=document.createElement('button'); btnDel.className='btn warn small'; btnDel.textContent='Delete Event';
    btnDel.onclick=()=> deleteEvent(ev.code, card);

    btnSave.onclick = async ()=>{
      btnSave.disabled = true; btnSave.textContent='Saving…';
      try{
        const r = await jsonp(ENDPOINT_URL, {
          mode:'setEventConfig',
          event: ev.code,
          provider: prov.value,
          market: mk.value.trim().toUpperCase(),
          explicitAllowed: ex.checked ? '1' : '0'
        });
        if(r && r.ok){
          await refresh();
        }
      }finally{
        btnSave.disabled = false; btnSave.textContent='Save Settings';
      }
    };

    // compose rows
    card.appendChild(h);
    const row1 = document.createElement('div'); row1.className='row';
    const c1 = document.createElement('div'); const c2=document.createElement('div'); const c3=document.createElement('div');
    const provLbl = document.createElement('div'); provLbl.className='label'; provLbl.textContent='Provider';
    const mkLbl = document.createElement('div'); mkLbl.className='label'; mkLbl.textContent='Market';
    const exLbl = document.createElement('div'); exLbl.className='label'; exLbl.textContent='Explicit';
    c1.append(provLbl, prov); c2.append(mkLbl, mk); c3.append(exLbl, exWrap);
    row1.append(c1,c2,c3);
    card.appendChild(row1);

    const row2 = document.createElement('div'); row2.className='event-actions';
    row2.append(btnSave, btnPrev, btnCopy, btnQR, btnDel);
    card.appendChild(row2);

    eventsEl.appendChild(card);
  }
}

async function createEvent(){
  const name=(evtName.value||'').trim(); const date=(evtDate.value||'').trim();
  if (!name || !date){ return; }
  const code=slugify(name,date);
  btnCreate.setAttribute('disabled','disabled');
  try{
    const r = await jsonp(ENDPOINT_URL,{
      mode:'createEvent', name, date, code, active:'1',
      provider: evtProvider.value,
      market: (evtMarket.value||'US').trim().toUpperCase(),
      explicitAllowed: evtExplicit.checked ? '1' : '0'
    });
    if (r && r.ok){
      evtName.value=''; evtDate.value=''; evtMarket.value='US'; evtProvider.value='apple'; evtExplicit.checked=true;
      await refresh();
    }
  }finally{
    btnCreate.removeAttribute('disabled');
  }
}
function clearFields(){ evtName.value=''; evtDate.value=''; }

async function deleteEvent(code, card){
  if(!confirm('Delete this event? (Requests can be wiped from the DJ page if needed)')) return;
  card.style.opacity='.6';
  try{ await jsonp(ENDPOINT_URL,{ mode:'deleteEvent', event:code, wipe:'0' }); }
  finally{ await refresh(); }
}

btnCreate.addEventListener('click', createEvent);
btnClear.addEventListener('click', clearFields);
btnRefresh.addEventListener('click', refresh);
window.addEventListener('load', refresh);
</script>
</body>
</html>

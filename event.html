<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#009ca6" />
  <title>Song Requests • David Charles Events</title>
  <link rel="preconnect" href="https://form.jotform.com">

  <!-- ===== Brand System ===== -->
  <style>
    :root{
      --bg: #f6fafb;         /* page background */
      --card: #ffffff;       /* card background */
      --ink: #0e1a1b;        /* primary text */
      --muted: #5a6b6d;      /* secondary text */
      --ring: rgba(0,0,0,.08);
      --shadow: 0 8px 28px rgba(0,0,0,.08);
      --accent: #009ca6;     /* DCE teal */
      --accent-10: rgba(0,156,166,.10);
      --accent-15: rgba(0,156,166,.15);
      --accent-20: rgba(0,156,166,.20);
      --success: #10b981;
      --radius-lg: 18px;
      --radius-sm: 12px;
      --gap: 16px;
      --px: 16px;            /* page side padding */
      --maxw: 920px;
    }

    /* Page */
    html, body { height:100%; }
    body {
      margin:0;
      background: radial-gradient(1000px 600px at 80% -10%, #e8fbff 0%, transparent 60%) var(--bg);
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji", sans-serif;
      color: var(--ink);
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }
    .wrap {
      max-width: var(--maxw);
      margin: 0 auto;
      padding: 20px var(--px) 32px;
    }

    /* Header */
    .header {
      display: grid;
      grid-template-columns: auto 1fr;
      gap: 14px;
      align-items: center;
      margin-bottom: 16px;
    }
    .logo {
      width: 160px; height:auto;
      border-radius: 10px;
    }
    .event-meta {
      display: flex;
      flex-direction: column;
      gap: 2px;
      min-width: 0;
    }
    .event-title {
      font-weight: 800;
      font-size: clamp(20px, 3.8vw, 28px);
      letter-spacing: -0.02em;
      margin: 0;
    }
    .event-sub {
      margin: 0;
      color: var(--muted);
      font-size: 14px;
    }

    /* Section cards */
    .card {
      background: var(--card);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow);
      padding: 16px;
      margin-top: 14px;
      border: 1px solid rgba(0,0,0,.03);
    }
    .card h2 {
      margin: 6px 0 12px;
      text-align: center;
      font-weight: 800;
      letter-spacing: -0.02em;
      font-size: clamp(18px, 3.4vw, 22px);
    }

    /* Search UI */
    .search-row { display:flex; flex-direction:column; align-items:center; }
    .search-box {
      width: 100%;
      max-width: 620px;
      margin: 0 auto 10px;
      padding: 14px 18px;
      border: 2px solid var(--ring);
      border-radius: 999px;
      font-size: 16px;
      outline: none;
      box-sizing: border-box;
      background:#fff;
      transition: box-shadow .18s ease, border-color .18s ease, transform .06s ease;
    }
    .search-box:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 4px var(--accent-15);
    }

    .status {
      max-width: 620px;
      width: 100%;
      margin: 2px auto 0;
      font-size: 13px;
      color: var(--muted);
      min-height: 18px;
      text-align: center;
    }

    .results {
      max-width: 620px;
      margin: 10px auto 0;
    }
    .result-item {
      display: grid;
      grid-template-columns: 56px 1fr;
      align-items:center;
      gap: 12px;
      padding: 12px;
      margin-bottom: 10px;
      border-radius: var(--radius-sm);
      background: #f8fbfb;
      cursor: pointer;
      transition: background .18s ease, transform .06s ease, border-color .18s ease;
      border: 1px solid rgba(0,0,0,.04);
    }
    .result-item:active { transform: scale(.996); }
    .result-item:hover { background: #f3fafa; }
    .result-item.selected {
      border: 2px solid var(--accent);
      background: #f2feff;
      box-shadow: 0 6px 18px var(--accent-10);
    }

    .cover {
      width: 56px; height:56px;
      border-radius: 10px; object-fit: cover;
      background: #e9eff0; color:#738487;
      display: grid; place-items:center; font-size: 12px;
    }
    .song-info { min-width: 0; }
    .song-title {
      font-weight: 700; font-size: 15px; margin:0 0 2px;
      white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
    }
    .artist-name {
      font-size: 13px; color: var(--muted); margin:0;
      white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
    }

    /* Selected pill */
    #selected {
      max-width: var(--maxw);
      margin: 10px auto 8px;
      text-align: center;
      font-size: 14px;
      color: var(--ink);
    }
    #selected .pill {
      display: inline-flex; gap:6px; align-items:center;
      background: var(--accent-10);
      color: var(--ink);
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid var(--accent-20);
      box-shadow: inset 0 1px 0 rgba(255,255,255,.5);
    }
    #selected .dot {
      width:8px; height:8px; border-radius:999px; background: var(--accent);
      box-shadow: 0 0 0 2px rgba(0,156,166,.22);
    }

    /* Iframes */
    iframe { width:100%; border:0; display:block; }
    .spacer { height: 12px; }

    /* Full-page thank-you overlay */
    #thanksOverlay {
      position: fixed; inset: 0; display: none;
      background: rgba(246,250,251,.98);
      backdrop-filter: blur(2px);
      align-items: center; justify-content: center;
      z-index: 9999; padding: 24px;
      opacity: 0; transition: opacity .22s ease;
    }
    #thanksOverlay.show { display:flex; opacity: 1; }

    #thanksCard {
      background: var(--card);
      border-radius: 22px;
      box-shadow: var(--shadow);
      padding: 32px 28px;
      max-width: 740px; width: 100%;
      text-align: center;
      border: 1px solid rgba(0,0,0,.04);
      transform: translateY(8px);
      animation: pop .24s ease forwards;
    }
    @keyframes pop { to { transform: translateY(0) } }

    #thanksLogo { margin-bottom: 10px; }
    #thanksLogo img { max-width: 200px; height: auto; }
    .check {
      width: 64px; height: 64px; border-radius: 50%;
      margin: 10px auto 16px; display:grid; place-items:center;
      background: var(--accent-10); color: var(--accent);
      font-size: 34px; line-height: 1; border: 2px solid var(--accent-20);
    }
    #thanksCard h1 { margin: 8px 0 6px; font-size: clamp(22px, 4vw, 28px); }
    #thanksCard p  { margin: 0 0 18px; color:#3b4a4c; }
    .btns { display:flex; gap:10px; justify-content:center; flex-wrap:wrap; }
    .btn {
      appearance: none; text-decoration: none; cursor: pointer;
      background: var(--accent); color: #fff; border: 0;
      padding: 12px 18px; border-radius: 999px; font-weight: 700;
      box-shadow: 0 8px 22px var(--accent-15);
      transition: transform .06s ease, filter .12s ease;
    }
    .btn:hover { filter: brightness(1.06); }
    .btn:active { transform: translateY(1px); }
    .btn.secondary { background:#0e1a1b; box-shadow: 0 8px 22px rgba(0,0,0,.12); }

    /* Small screens */
    @media (max-width: 480px){
      .wrap { padding: 16px var(--px) 28px; }
      .header { grid-template-columns: 1fr; text-align:center; }
      .event-meta { align-items:center; }
    }
  </style>
</head>
<body>
  <div class="wrap" id="app">

    <!-- Header: logo + event meta (edit text below per event) -->
    <div class="header">
      <img class="logo" src="assets/client-logo.png" alt="Client Logo" onerror="this.style.display='none'">
      <div class="event-meta">
        <h1 class="event-title">Song Requests</h1>
        <p class="event-sub">Powered by David Charles Events</p>
      </div>
    </div>

    <!-- Search card -->
    <div class="card">
      <h2>Find Your Song</h2>
      <div class="search-row">
        <input id="search" class="search-box" type="text" placeholder="Type a song or artist…" inputmode="search" autocomplete="off" />
        <div id="status" class="status"></div>
      </div>
      <div id="results" class="results"></div>
    </div>

    <!-- Selection confirmation -->
    <div id="selected"></div>

    <div class="spacer"></div>

    <!-- Jotform card -->
    <div class="card">
      <iframe id="jotFrame" title="Song Request Form" loading="lazy" style="height:1400px" src=""></iframe>
    </div>
  </div>

  <!-- Full-page Thank You Overlay -->
  <div id="thanksOverlay" role="dialog" aria-labelledby="thanksTitle" aria-modal="true">
    <div id="thanksCard">
      <div id="thanksLogo"><img src="assets/client-logo.png" alt="David Charles Events" onerror="this.style.display='none'"></div>
      <div class="check">✓</div>
      <h1 id="thanksTitle">Thank you!</h1>
      <p>Your request has been received.</p>
      <div class="btns">
        <button class="btn" id="againBtn">Submit another request</button>
        <a class="btn secondary" href="https://www.davidcharlesevents.com/">Back to DCE</a>
      </div>
    </div>
  </div>

  <!-- ===== Logic ===== -->
  <script>
    /* -------- Config -------- */
    const JOT_ID   = '252746100648052'; // change if you clone the form
    const JOT_BASE = `https://form.jotform.com/${JOT_ID}`;

    /* -------- Init: blank, fresh form -------- */
    (function initForm() { setFormSrc({}); })();

    function setFormSrc(prefill) {
      const params = new URLSearchParams(prefill || {});
      params.set('ts', Date.now().toString()); // cache-buster prevents stale Thank-You
      document.getElementById('jotFrame').src = `${JOT_BASE}?${params.toString()}`;
    }

    /* -------- Search (inline) -------- */
    const $ = (sel) => document.querySelector(sel);
    const searchInput = $('#search');
    const statusEl = $('#status');
    const resultsEl = $('#results');
    const selectedEl = $('#selected');

    let debounce = null, lastTerm = '', lastTag = null;

    const setStatus = (msg='', err=false) => {
      statusEl.textContent = msg;
      statusEl.style.color = err ? '#b00020' : 'var(--muted)';
    };
    const clearResults = () => { resultsEl.innerHTML = ''; };

    // JSONP helper (for iTunes & Deezer)
    function jsonp(url, cbParam='callback'){
      return new Promise((resolve, reject) => {
        const cb = 'cb_' + Math.random().toString(36).slice(2);
        const sep = url.includes('?') ? '&' : '?';
        const src = `${url}${sep}${cbParam}=${cb}`;
        if (lastTag && lastTag.parentNode) lastTag.parentNode.removeChild(lastTag);
        const s = document.createElement('script');
        lastTag = s;
        const timer = setTimeout(() => { cleanup(); reject(new Error('timeout')); }, 9000);
        function cleanup(){ clearTimeout(timer); try{delete window[cb];}catch{} if (s.parentNode) s.parentNode.removeChild(s); }
        window[cb] = (data) => { cleanup(); resolve(data); };
        s.onerror = () => { cleanup(); reject(new Error('jsonp error')); };
        s.src = src;
        document.body.appendChild(s);
      });
    }

    async function searchITunes(term){
      const data = await jsonp(`https://itunes.apple.com/search?term=${encodeURIComponent(term)}&entity=musicTrack&limit=8`, 'callback');
      return (data?.results || []).map(t => ({
        title: t.trackName, artist: t.artistName,
        cover: t.artworkUrl60, link: t.trackViewUrl
      }));
    }
    async function searchDeezer(term){
      const data = await jsonp(`https://api.deezer.com/search?q=${encodeURIComponent(term)}&limit=8&output=jsonp`, 'callback');
      return (data?.data || []).map(d => ({
        title: d.title, artist: d?.artist?.name || '',
        cover: d?.album?.cover_medium || d?.album?.cover || '',
        link: d.link || ''
      }));
    }
    async function searchMB(term){
      const r = await fetch(`https://musicbrainz.org/ws/2/recording/?query=${encodeURIComponent(term)}&fmt=json&limit=8`, {
        headers: {'User-Agent':'DCE-SongRequest/1.0 (https://www.davidcharlesevents.com)'}, cache:'no-store'
      });
      if (!r.ok) throw new Error('mb http '+r.status);
      const data = await r.json();
      return (data.recordings || []).map(rec => {
        const ac = rec['artist-credit']; const artist = ac && ac[0] && ac[0].name ? ac[0].name : '';
        return { title: rec.title, artist, cover:'', link:`https://musicbrainz.org/recording/${rec.id}` };
      });
    }

    function render(list){
      clearResults();
      list.forEach(({title, artist, cover, link}) => {
        const item = document.createElement('div');
        item.className = 'result-item';
        item.setAttribute('role', 'button');
        item.setAttribute('tabindex', '0');

        const img = cover
          ? `<img class="cover" src="${cover}" alt="Album cover">`
          : `<div class="cover" aria-hidden="true">♪</div>`;

        item.innerHTML = `${img}
          <div class="song-info">
            <p class="song-title">${title || 'Unknown Title'}</p>
            <p class="artist-name">${artist || 'Unknown Artist'}</p>
          </div>`;

        // click or Enter to select
        const select = () => selectTrack({title, artist, link}, item);
        item.onclick = select;
        item.onkeyup = (e) => { if (e.key === 'Enter' || e.key === ' ') select(); };

        resultsEl.appendChild(item);
      });
    }

    async function doSearch(term){
      if (!term) { setStatus(''); clearResults(); return; }
      setStatus('Searching…');
      try {
        const a = await searchITunes(term);
        if (a.length) { setStatus(''); render(a); return; }
      } catch(e){}
      try {
        const b = await searchDeezer(term);
        if (b.length) { setStatus(''); render(b); return; }
      } catch(e){}
      try {
        const c = await searchMB(term);
        setStatus(c.length ? '' : 'No results');
        render(c);
      } catch(e){
        setStatus('Search failed.', true);
        clearResults();
      }
    }

    function selectTrack({title, artist, link}, itemEl){
      document.querySelectorAll('.result-item').forEach(x => x.classList.remove('selected'));
      if (itemEl) itemEl.classList.add('selected');

      selectedEl.innerHTML =
        `<span class="pill"><span class="dot"></span><strong>${title || 'Unknown Title'}</strong> — ${artist || 'Unknown Artist'}</span>`;

      // Prefill Jotform using your unique names + cache-buster
      setFormSrc({
        song_title: title || '',
        artist: artist || '',
        link: link || ''
      });
    }

    // type-to-search
    searchInput.addEventListener('input', () => {
      const t = searchInput.value.trim();
      if (t === lastTerm) return;
      lastTerm = t;
      clearTimeout(debounce);
      debounce = setTimeout(() => doSearch(t), 260);
    });
    searchInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') { e.preventDefault(); doSearch(searchInput.value.trim()); }
    });

    /* -------- Full-page Thank You overlay trigger -------- */
    const JF_ORIGINS = [
      'https://form.jotform.com','https://www.jotform.com',
      'https://submit.jotform.com','https://eu.jotform.com','https://www.jotformeu.com'
    ];

    function isSubmissionCompleteMessage(data) {
      try {
        if (!data) return false;
        if (typeof data === 'string') {
          const s = data.toLowerCase();
          return s.includes('thankyou') || s.includes('thank you') ||
                 (s.includes('submission') && (s.includes('complete') || s.includes('success')));
        }
        if (typeof data === 'object') {
          const values = ['type','event','name','message','status','action','customEvent']
            .map(k => (data[k] || '').toString().toLowerCase())
            .join(' | ');
          return values.includes('thankyou') || values.includes('thank you') ||
                 values.includes('submission-complete') || values.includes('form-submit-successful') ||
                 values.includes('submit-success') || values.includes('cards:submit:success') ||
                 values.includes('redirected to thank you');
        }
      } catch (_) {}
      return false;
    }

    let lastHeights = [];
    function heightSuggestsThankYou(h) {
      lastHeights.push(h);
      if (lastHeights.length > 6) lastHeights.shift();
      const avg = lastHeights.reduce((a,b)=>a+b,0)/lastHeights.length;
      return avg > 0 && avg < 600; // thank-you pages are short
    }

    window.addEventListener('message', (e) => {
      if (!JF_ORIGINS.includes(e.origin)) return;
      const d = e.data;

      if (isSubmissionCompleteMessage(d)) {
        showThanksOverlay();
        return;
      }

      if (d && typeof d === 'object') {
        const t = (d.type || d.event || '').toString().toLowerCase();
        const h = Number(d.height || d.newHeight || d.h || 0);
        if (t.includes('height') && h && heightSuggestsThankYou(h)) {
          showThanksOverlay();
        }
      }
    });

    function showThanksOverlay(){
      const ov = document.getElementById('thanksOverlay');
      if (ov.classList.contains('show')) return;
      ov.classList.add('show');
      document.documentElement.style.overflow = 'hidden';
      document.body.style.overflow = 'hidden';
    }

    // Submit another request
    document.getElementById('againBtn').addEventListener('click', () => {
      document.getElementById('thanksOverlay').classList.remove('show');
      document.documentElement.style.overflow = '';
      document.body.style.overflow = '';
      selectedEl.innerHTML = '';
      setFormSrc({});
      searchInput.value = '';
      clearResults();
      searchInput.focus({ preventScroll: true });
    });
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#009ca6" />
  <title>Song Requests • David Charles Events</title>
  <link rel="preconnect" href="https://form.jotform.com">

  <style>
    :root{
      --ink:#111; --muted:#616161; --bg:#ffffff;
      --card:#fff; --border:#e5e7eb; --ring:rgba(33,150,243,.25);
      --accent:#009ca6; --radius:10px; --radius-sm:8px; --maxw:920px; --pad:16px;
    }
    html, body { height:100%; }
    body{ margin:0; background:var(--bg); font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji", sans-serif; color:var(--ink); }
    .wrap{ max-width:var(--maxw); margin:0 auto; padding: 18px var(--pad) 28px; }
    .header{ display:flex; align-items:center; gap:12px; margin-bottom:10px; }
    .logo{ width:160px; height:auto; border-radius:8px; }
    .title{ font-weight:800; font-size:clamp(20px,3.4vw,28px); margin:0; }
    .sub{ margin:0; color:var(--muted); font-size:14px; }

    .section{ background:var(--card); border:1px solid var(--border); border-radius:var(--radius); padding:14px; margin-top:12px; }
    .section h2{ margin:6px 8px 12px; font-size:clamp(18px,3vw,22px); font-weight:800; letter-spacing:-.01em; }

    /* Search matches JF inputs */
    .field{ display:flex; flex-direction:column; gap:6px; max-width:640px; margin:0 auto; }
    .label{ font-size:14px; color:#333; font-weight:600; }
    .input{ height:48px; padding:0 14px; border:1px solid var(--border); border-radius:var(--radius-sm); font-size:16px; outline:none; background:#fff; box-sizing:border-box; transition: box-shadow .15s ease, border-color .15s ease; }
    .input:focus{ border-color:#2196f3; box-shadow:0 0 0 4px var(--ring); }
    .status{ max-width:640px; margin:6px auto 0; font-size:13px; color:var(--muted); min-height:18px; text-align:left; }

    .results{ max-width:640px; margin:10px auto 0; }
    .item{ display:grid; grid-template-columns:56px 1fr; align-items:center; gap:12px; padding:10px; border:1px solid var(--border); border-radius:var(--radius-sm); background:#fafafa; transition: background .15s, transform .06s, border-color .15s; cursor:pointer; margin-bottom:10px; }
    .item:hover{ background:#f5f5f5; }
    .item:active{ transform:scale(.996); }
    .item.selected{ border-color:#2196f3; box-shadow:0 0 0 4px var(--ring); background:#fff; }
    .cover{ width:56px; height:56px; border-radius:8px; object-fit:cover; background:#e9eef0; color:#7a8a8d; display:grid; place-items:center; font-size:12px; }
    .info{ min-width:0; }
    .ttl{ margin:0 0 2px; font-weight:700; font-size:15px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .art{ margin:0; color:#555; font-size:13px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }

    #selected{ max-width:var(--maxw); margin:10px auto 0; text-align:left; font-size:14px; }
    #selected .pill{ display:inline-flex; align-items:center; gap:6px; background:#eef9fa; border:1px solid #d8f0f1; border-radius:999px; padding:6px 10px; }
    #selected .dot{ width:8px; height:8px; border-radius:999px; background:var(--accent); }

    iframe{ width:100%; border:0; display:block; }
    .spacer{ height:12px; }

    /* Full-page Thank You overlay */
    #thanksOverlay{ position:fixed; inset:0; display:none; opacity:0; background:rgba(255,255,255,.98); align-items:center; justify-content:center; z-index:9999; padding:24px; transition:opacity .2s; }
    #thanksOverlay.show{ display:flex; opacity:1; }
    #thanksCard{ background:#fff; border:1px solid var(--border); border-radius:14px; padding:28px 22px; width:min(720px,100%); text-align:center; }
    #thanksLogo{ margin-bottom:10px; } #thanksLogo img{ max-width:200px; height:auto; }
    .check{ width:56px; height:56px; border-radius:50%; margin:10px auto 14px; display:grid; place-items:center; background:#e6f7f8; color:var(--accent); font-size:30px; }
    #thanksCard h1{ margin:6px 0 6px; font-size:24px; } #thanksCard p{ margin:0 0 16px; color:#444; }
    .btns{ display:flex; gap:10px; justify-content:center; flex-wrap:wrap; }
    .btn{ appearance:none; text-decoration:none; cursor:pointer; background:#2196f3; color:#fff; border:0; padding:10px 16px; border-radius:999px; font-weight:700; }
    .btn.secondary{ background:#111; }
  </style>
</head>
<body>
  <div class="wrap" id="app">
    <div class="header">
      <img class="logo" src="assets/client-logo.png" alt="Client Logo" onerror="this.style.display='none'">
      <div>
        <h1 class="title">Song Requests</h1>
        <p class="sub">Powered by David Charles Events</p>
      </div>
    </div>

    <!-- JOTFORM FIRST (smaller default height; will auto-resize) -->
    <div class="section" aria-label="Request Form">
      <h2>Request Form</h2>
      <iframe id="jotFrame" title="Song Request Form" style="height:700px" src=""></iframe>
    </div>

    <div id="selected"></div>

    <!-- SONG SEARCH BELOW -->
    <div class="section" aria-label="Search">
      <h2>Find Your Song</h2>
      <div class="field">
        <label for="search" class="label">Song or Artist</label>
        <input id="search" class="input" type="text" placeholder="Start typing… (e.g., ‘Uptown Funk’ or ‘Bruno Mars’)" inputmode="search" autocomplete="off" />
      </div>
      <div id="status" class="status"></div>
      <div id="results" class="results"></div>
    </div>
  </div>

  <!-- Full-page Thank You overlay -->
  <div id="thanksOverlay" role="dialog" aria-labelledby="thanksTitle" aria-modal="true">
    <div id="thanksCard">
      <div id="thanksLogo"><img src="assets/client-logo.png" alt="David Charles Events" onerror="this.style.display='none'"></div>
      <div class="check">✓</div>
      <h1 id="thanksTitle">Thank you!</h1>
      <p>Your request has been received.</p>
      <div class="btns">
        <button class="btn" id="againBtn">Submit another request</button>
        <a class="btn secondary" href="https://www.davidcharlesevents.com/">Back to DCE</a>
      </div>
    </div>
  </div>

  <script>
    /* -------- Config -------- */
    const JOT_ID   = '252746100648052';
    const JOT_BASE = `https://form.jotform.com/${JOT_ID}`;

    /* Load fresh form (prevents cached Thank-You) */
    (function initForm(){ setFormSrc({}); })();

    function setFormSrc(prefill){
      const params = new URLSearchParams(prefill || {});
      params.set('ts', Date.now().toString()); // cache-buster
      document.getElementById('jotFrame').src = `${JOT_BASE}?${params.toString()}`;
    }

    /* ===== Live Search ===== */
    const $ = (s)=>document.querySelector(s);
    const searchInput = $('#search'), statusEl = $('#status'), resultsEl = $('#results'), selectedEl = $('#selected');
    let debounce=null,lastTerm='',lastTag=null;

    const setStatus=(m='',err=false)=>{ statusEl.textContent=m; statusEl.style.color=err?'#b00020':'var(--muted)'; };
    const clearResults=()=>{ resultsEl.innerHTML=''; };

    function jsonp(url, cbParam='callback'){
      return new Promise((resolve, reject) => {
        const cb='cb_'+Math.random().toString(36).slice(2);
        const sep=url.includes('?')?'&':'?';
        const src=`${url}${sep}${cbParam}=${cb}`;
        if (lastTag && lastTag.parentNode) lastTag.parentNode.removeChild(lastTag);
        const s=document.createElement('script'); lastTag=s;
        const timer=setTimeout(()=>{cleanup();reject(new Error('timeout'));},9000);
        function cleanup(){ clearTimeout(timer); try{delete window[cb];}catch{} if(s.parentNode)s.parentNode.removeChild(s); }
        window[cb]=(data)=>{ cleanup(); resolve(data); };
        s.onerror=()=>{ cleanup(); reject(new Error('jsonp error')); };
        s.src=src; document.body.appendChild(s);
      });
    }
    async function searchITunes(term){
      const data=await jsonp(`https://itunes.apple.com/search?term=${encodeURIComponent(term)}&entity=musicTrack&limit=8`,'callback');
      return (data?.results||[]).map(t=>({ title:t.trackName, artist:t.artistName, cover:t.artworkUrl60, link:t.trackViewUrl }));
    }
    async function searchDeezer(term){
      const data=await jsonp(`https://api.deezer.com/search?q=${encodeURIComponent(term)}&limit=8&output=jsonp`,'callback');
      return (data?.data||[]).map(d=>({ title:d.title, artist:d?.artist?.name||'', cover:d?.album?.cover_medium||d?.album?.cover||'', link:d.link||'' }));
    }
    async function searchMB(term){
      const r=await fetch(`https://musicbrainz.org/ws/2/recording/?query=${encodeURIComponent(term)}&fmt=json&limit=8`,{headers:{'User-Agent':'DCE-SongRequest/1.0 (https://www.davidcharlesevents.com)'}, cache:'no-store'});
      if(!r.ok)throw new Error('mb http '+r.status);
      const data=await r.json();
      return (data.recordings||[]).map(rec=>{ const ac=rec['artist-credit']; const artist=ac&&ac[0]&&ac[0].name?ac[0].name:''; return { title:rec.title, artist, cover:'', link:`https://musicbrainz.org/recording/${rec.id}` }; });
    }
    function render(list){
      clearResults();
      list.forEach(({title,artist,cover,link})=>{
        const item=document.createElement('div');
        item.className='item'; item.setAttribute('role','button'); item.setAttribute('tabindex','0');
        const img = cover ? `<img class="cover" src="${cover}" alt="Album cover">` : `<div class="cover" aria-hidden="true">♪</div>`;
        item.innerHTML = `${img}<div class="info"><p class="ttl">${title||'Unknown Title'}</p><p class="art">${artist||'Unknown Artist'}</p></div>`;
        const select=()=>selectTrack({title,artist,link},item);
        item.onclick=select; item.onkeyup=(e)=>{ if(e.key==='Enter'||e.key===' ') select(); };
        resultsEl.appendChild(item);
      });
    }
    async function doSearch(term){
      if(!term){ setStatus(''); clearResults(); return; }
      setStatus('Searching…');
      try{ const a=await searchITunes(term); if(a.length){ setStatus(''); render(a); return; } }catch(e){}
      try{ const b=await searchDeezer(term); if(b.length){ setStatus(''); render(b); return; } }catch(e){}
      try{ const c=await searchMB(term); setStatus(c.length?'':'No results'); render(c); }catch(e){ setStatus('Search failed.',true); clearResults(); }
    }
    function selectTrack({title,artist,link}, itemEl){
      document.querySelectorAll('.item').forEach(x=>x.classList.remove('selected'));
      if(itemEl) itemEl.classList.add('selected');
      selectedEl.innerHTML = `<div class="pill"><span class="dot"></span><strong>${title||'Unknown Title'}</strong> — ${artist||'Unknown Artist'}</div>`;
      setFormSrc({ song_title:title||'', artist:artist||'', link:link||'' });
      // scroll back to form (since it's on top)
      document.getElementById('app').scrollIntoView({behavior:'smooth', block:'start'});
    }
    searchInput.addEventListener('input', ()=>{
      const t=searchInput.value.trim(); if(t===lastTerm) return; lastTerm=t;
      clearTimeout(debounce); debounce=setTimeout(()=>doSearch(t),260);
    });
    searchInput.addEventListener('keydown',(e)=>{ if(e.key==='Enter'){ e.preventDefault(); doSearch(searchInput.value.trim()); } });

    /* ===== Auto-resize Jotform iframe + Thank-You overlay ===== */
    const jotFrame = document.getElementById('jotFrame');
    const JF_ORIGINS = [
      'https://form.jotform.com','https://www.jotform.com',
      'https://submit.jotform.com','https://eu.jotform.com','https://www.jotformeu.com'
    ];

    function isSubmissionCompleteMessage(data){
      try{
        if(!data) return false;
        if(typeof data==='string'){
          const s=data.toLowerCase();
          return s.includes('thankyou')||s.includes('thank you')||(s.includes('submission')&&(s.includes('complete')||s.includes('success')));
        }
        if(typeof data==='object'){
          const values=['type','event','name','message','status','action','customEvent'].map(k=>(data[k]||'').toString().toLowerCase()).join(' | ');
          return values.includes('thankyou')||values.includes('thank you')||values.includes('submission-complete')||values.includes('form-submit-successful')||values.includes('submit-success')||values.includes('cards:submit:success')||values.includes('redirected to thank you');
        }
      }catch(_){}
      return false;
    }

    function showThanksOverlay(){
      const ov=document.getElementById('thanksOverlay');
      if(ov.classList.contains('show')) return;
      ov.classList.add('show');
      document.documentElement.style.overflow='hidden';
      document.body.style.overflow='hidden';
    }

    window.addEventListener('message',(e)=>{
      if(!JF_ORIGINS.includes(e.origin)) return;
      const d=e.data;

      // 1) Auto-resize when Jotform sends its height
      if(d && typeof d==='object'){
        const t=(d.type||d.event||'').toString().toLowerCase();
        const h=Number(d.height||d.newHeight||d.h||0);
        if(t.includes('height') && h){
          // clamp to a sane range
          const height = Math.max(500, Math.min(h, 2000));
          jotFrame.style.height = height + 'px';
        }
      }

      // 2) Full-page Thank You trigger
      if(isSubmissionCompleteMessage(d)){
        showThanksOverlay();
      }
    });

    // “Submit another request”
    document.getElementById('againBtn')?.addEventListener('click',()=>{
      document.getElementById('thanksOverlay').classList.remove('show');
      document.documentElement.style.overflow=''; document.body.style.overflow='';
      selectedEl.innerHTML=''; setFormSrc({}); searchInput.value=''; clearResults(); window.scrollTo({top:0, behavior:'smooth'}); searchInput.focus({preventScroll:true});
    });
  </script>
</body>
</html>

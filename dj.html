<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<title>REQUESTS • David Charles Events</title>
<style>
  :root{
    --bg:#212121;
    --section:#363636;
    --subsection:#424242;
    --border:#2b2b2b;
    --ink:#f2f2f2;
    --muted:#bdbdbd;
    --accent:#1dcec9;   /* Mark as Played */
    --amber:#f7b731;    /* Mark as Unplayed */
    --names:#7aa2ff;    /* Show/Hide Names */
    --danger:#ef4444;   /* Remove */
    --ok:#34d399;       /* Put Back */
    --radius:12px;
    --maxw:1100px;
  }

  @font-face{
    font-family:"Adventor";
    src:url("texgyreadventor-regular.otf") format("opentype");
    font-weight:400; font-style:normal; font-display:swap;
  }

  *{ box-sizing:border-box; }
  html,body{
    margin:0; background:var(--bg); color:var(--ink);
    font-family:"Adventor", system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
  }
  .wrap{ max-width:var(--maxw); margin:0 auto; padding:16px 14px 56px; }
  .page-title{ text-align:center; margin:8px 0 18px; letter-spacing:.06em; font-weight:800; font-size:clamp(22px,5.5vw,36px); }

  /* Panels */
  .panel{ background:var(--section); border:1px solid var(--border); border-radius:var(--radius); padding:14px; margin-bottom:14px; }
  label{ display:block; font-size:14px; color:var(--muted); margin:0 0 6px; }
  select{
    height:46px; border-radius:12px; border:1px solid #3a3a3a; background:#2a2a2a; color:#fff;
    font-size:15px; padding:0 12px; width:100%;
  }
  .inline-info{ margin-top:8px; color:#e7e7e7; font-size:14px; }

  /* Tabs (bottom panel header) */
  .tabs{ display:flex; gap:8px; margin-bottom:10px; }
  .tab-btn{
    background:#2f2f2f; border:1px solid #3a3a3a; color:#fff;
    height:40px; padding:0 16px; border-radius:999px; font-size:14px; cursor:pointer;
    transition:filter .15s ease, transform .06s ease;
  }
  .tab-btn:hover{ filter:brightness(1.05); }
  .tab-btn:active{ transform:translateY(1px); }
  .tab-btn.active{ background:var(--subsection); }

  .hidden{ display:none !important; }

  /* Collapsibles */
  .collapsible{ background:var(--subsection); border:1px solid var(--border); border-radius:12px; padding:10px; margin-top:10px; }
  .collapsible-header{ display:flex; align-items:center; justify-content:space-between; cursor:pointer; user-select:none; }
  .twist{ width:18px; height:18px; display:inline-grid; place-items:center; margin-left:8px; }
  .collapsible-body{ display:none; margin-top:10px; }
  .collapsible.open .collapsible-body{ display:block; }

  .h2{ margin:6px 0 10px; font-size:18px; font-weight:800; letter-spacing:.03em; display:flex; align-items:center; justify-content:space-between; }
  .count-pill{ font-size:13px; color:#dcdcdc; opacity:.9; margin-left:8px; }

  .list{ display:grid; gap:10px; }
  .card{
    background:var(--section); border:1px solid var(--border); border-radius:12px; padding:10px;
    display:grid; grid-template-columns:64px 1fr 210px; gap:12px; align-items:center;
  }
  @media (max-width:760px){
    .card{ grid-template-columns:64px 1fr; }
    .card .actions{ grid-column:1 / -1; }
  }
  .thumb{ width:64px; height:64px; border-radius:10px; background:#1f1f1f; object-fit:cover; display:block; }
  .meta{ min-width:0; }
  .title{ margin:0 0 2px; font-weight:800; font-size:16px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
  .sub{ margin:0; color:#e6e6e6; font-size:13px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }

  .actions{ display:grid; gap:8px; } /* spacing between buttons */
  .btn{
    display:inline-flex; align-items:center; justify-content:center; padding:0 14px;
    height:38px; font-size:14px; border-radius:10px; border:1px solid transparent;
    box-shadow:0 2px 0 rgba(0,0,0,.35), 0 10px 18px rgba(0,0,0,.15); width:100%;
    transition:filter .15s ease, transform .06s ease, background .15s ease, box-shadow .06s ease;
    cursor:pointer;
  }
  .btn:hover{ filter:brightness(1.05); }
  .btn:active{ transform:translateY(1px); box-shadow:inset 0 2px 0 rgba(0,0,0,.25); }

  .btn.played   { background:var(--accent); border-color:var(--accent); color:#000; }
  .btn.unplayed { background:var(--amber);  border-color:var(--amber);  color:#000; }
  .btn.names    { background:var(--names);  border-color:var(--names);  color:#fff; }
  .btn.remove   { background:var(--danger); border-color:var(--danger); color:#fff; }
  .btn.putback  { background:var(--ok);     border-color:var(--ok);     color:#000; }

  .names-box{ margin-top:6px; background:var(--subsection); border:1px solid var(--border); border-radius:10px; padding:8px 10px; display:none; }
  .names-box.open{ display:block; }
  .names-box .hdr{ color:#cfcfcf; font-size:13px; margin:0 0 4px; }
  .names-box ul{ margin:0; padding-left:18px; }
  .names-box li{ margin:3px 0; color:#fafafa; font-size:13px; }

  .footer-line{ margin-top:10px; color:var(--muted); font-size:12px; }
</style>
</head>
<body>
  <div class="wrap">
    <div class="page-title">REQUESTS</div>

    <!-- Top: Event select + inline info -->
    <div class="panel">
      <label for="eventSel">Select Your Event</label>
      <select id="eventSel"></select>
      <div id="inlineInfo" class="inline-info"></div>
    </div>

    <!-- Bottom: Tabs + content -->
    <div class="panel">
      <div class="tabs">
        <button id="tabRequests" class="tab-btn active" type="button">Requests</button>
        <button id="tabSpam" class="tab-btn" type="button">Spam</button>
      </div>

      <!-- Requests tab -->
      <div id="tabRequestsPane">
        <div class="collapsible open" id="reqWrap">
          <div class="collapsible-header" data-target="reqBody">
            <div>Requests <span id="reqCount" class="count-pill">(0)</span></div>
            <div class="twist">▾</div>
          </div>
          <div id="reqBody" class="collapsible-body">
            <div id="reqList" class="list"></div>
          </div>
        </div>

        <div class="collapsible" id="playedWrap">
          <div class="collapsible-header" data-target="playedBody">
            <div>Played Songs <span id="playedCount" class="count-pill">(0)</span></div>
            <div class="twist">▸</div>
          </div>
          <div id="playedBody" class="collapsible-body">
            <div id="playedList" class="list"></div>
          </div>
        </div>

        <div class="collapsible" id="removedWrap">
          <div class="collapsible-header" data-target="removedBody">
            <div>Removed Songs <span id="removedCount" class="count-pill">(0)</span></div>
            <div class="twist">▸</div>
          </div>
          <div id="removedBody" class="collapsible-body">
            <div id="removedList" class="list"></div>
          </div>
        </div>

        <div class="footer-line" id="statusLine"></div>
      </div>

      <!-- Spam tab -->
      <div id="tabSpamPane" class="hidden">
        <div class="h2">Spammed Requests <span id="spamCountTop" class="count-pill">(0)</span></div>
        <div id="spamList" class="list"></div>
      </div>
    </div>
  </div>

<script>
/* ===== Config ===== */
const ENDPOINT_URL = 'https://script.google.com/macros/s/AKfycbxkSPUc2VWQYkhJ_af7CShegZLAMmVgUsTp2nMeVwkkhdFbdQT8wk2s6xBAAynjtLDT/exec';
const POLL_MS = 5000;

/* ===== Elements ===== */
const $ = s => document.querySelector(s);
const eventSel = $('#eventSel');
const inlineInfo = $('#inlineInfo');

const tabRequestsBtn = $('#tabRequests');
const tabSpamBtn = $('#tabSpam');
const tabRequestsPane = $('#tabRequestsPane');
const tabSpamPane = $('#tabSpamPane');

const reqList = $('#reqList');
const playedList = $('#playedList');
const removedList = $('#removedList');
const spamList = $('#spamList');

const reqCountEl = $('#reqCount');
const playedCountEl = $('#playedCount');
const removedCountEl = $('#removedCount');
const spamCountTop = $('#spamCountTop');
const statusLine = $('#statusLine');

/* ===== State ===== */
let currentCode = '';
let pollTimer = null;
let rowsCache = [];
const artCache = new Map();
const removedKeySet = new Set();

/* ===== Helpers ===== */
function showInline(msg){ inlineInfo.textContent = msg || ''; }
function keySong(song, artist){ return `${(song||'').toLowerCase()}|${(artist||'').toLowerCase()}`; }
function escapeHTML(s){ return String(s||'').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
function checksum(rows){ let s=0; for(const r of rows){ s+= (r.id||'').length + (r.played?7:3);} return s+':'+rows.length; }

/* JSONP */
function jsonp(url, params = {}) {
  const qs = new URLSearchParams(params);
  const cb = 'cb_' + Math.random().toString(36).slice(2);
  qs.set('callback', cb);
  qs.set('t', Date.now());
  return new Promise((resolve, reject) => {
    const s = document.createElement('script');
    s.src = url + (url.includes('?') ? '&' : '?') + qs.toString();
    const kill = setTimeout(() => { cleanup(); reject(new Error('timeout')); }, 9000);
    function cleanup(){ clearTimeout(kill); try{ delete window[cb]; }catch{} s.remove(); }
    window[cb] = (data) => { cleanup(); resolve(data); };
    s.onerror = () => { cleanup(); reject(new Error('jsonp error')); };
    document.body.appendChild(s);
  });
}

/* Artwork */
async function getArtwork(song, artist){
  const k = keySong(song, artist);
  if (artCache.has(k)) return artCache.get(k);
  try{
    const data = await jsonp('https://itunes.apple.com/search', { term:`${song} ${artist}`.trim(), entity:'musicTrack', limit:1 });
    const url = data?.results?.[0]?.artworkUrl100 || data?.results?.[0]?.artworkUrl60 || '';
    artCache.set(k, url||''); return url||'';
  }catch(_){ artCache.set(k,''); return ''; }
}

/* ===== Event loading (working version) ===== */
async function loadActiveEvents(){
  showInline('Loading your events…');
  try{
    const res = await jsonp(ENDPOINT_URL, { mode:'listActive' });
    const list = Array.isArray(res?.events) ? res.events : [];
    eventSel.innerHTML = '';

    if (!list.length){
      const opt=document.createElement('option');
      opt.value=''; opt.textContent='No active events';
      eventSel.appendChild(opt);
      currentCode=''; showInline('No active events found.');
      return;
    }

    for (const ev of list){
      const opt = document.createElement('option');
      opt.value = ev.code;
      opt.textContent = `${formatHeaderDate(ev.date)} - ${ev.name}`;
      eventSel.appendChild(opt);
    }

    const urlp = new URLSearchParams(location.search);
    const pre = (urlp.get('event')||'').trim();
    if (pre && [...eventSel.options].some(o=>o.value===pre)) eventSel.value = pre;

    currentCode = eventSel.value || '';
    showInline(''); // clear
  }catch(e){
    showInline('Could not load events.');
  }
}

/* ===== Polling & fetch ===== */
function startPolling(){ stopPolling(); pollTimer = setInterval(fetchRows, POLL_MS); }
function stopPolling(){ if (pollTimer) clearInterval(pollTimer); pollTimer = null; }

async function fetchRows(force=false){
  if (!currentCode) return;
  showInline('Loading your requests…');
  try{
    const res = await jsonp(ENDPOINT_URL, { mode:'read', event: currentCode });
    const rows = Array.isArray(res?.rows) ? res.rows : [];
    const changed = force || rows.length !== rowsCache.length || checksum(rows) !== checksum(rowsCache);
    rowsCache = rows;
    if (changed) renderAll(rows);
    statusLine.textContent = rows.length ? '' : 'No requests yet.';
  }catch(e){
    statusLine.textContent = 'Connection error.';
  }finally{
    showInline('');
  }
}

/* ===== Grouping ===== */
function splitBuckets(rows){
  const bySong = new Map();
  const spamMap = new Map();
  const playedRows = [];

  for (const r of rows){
    const song = r.song_title || r.song || '';
    const artist = r.artist || '';
    const k = keySong(song, artist);

    if (!bySong.has(k)) bySong.set(k, { song, artist, ids:[], names:new Set(), anyPlayed:false, anyUnplayed:false });
    const node = bySong.get(k);
    node.ids.push(r.id);
    if (r.name) node.names.add(r.name);
    if (r.played) { node.anyPlayed = true; playedRows.push(r); } else { node.anyUnplayed = true; }

    const kp = `${k}|${(r.name||'').toLowerCase()}`;
    spamMap.set(kp, (spamMap.get(kp)||0)+1);
  }

  const requests = [];
  for (const [k,node] of bySong.entries()){
    if (node.anyUnplayed){
      requests.push({
        key:k, song:node.song, artist:node.artist,
        ids: rows.filter(x=>keySong(x.song_title||x.song,x.artist)===k && !x.played).map(x=>x.id),
        people: [...node.names]
      });
    }
  }

  const playedGroups = new Map();
  for (const pr of playedRows){
    const k = keySong(pr.song_title||pr.song, pr.artist);
    if (!playedGroups.has(k)) playedGroups.set(k, { key:k, song:pr.song_title||pr.song, artist:pr.artist, ids:[], people:new Set() });
    const g = playedGroups.get(k);
    g.ids.push(pr.id); if (pr.name) g.people.add(pr.name);
  }

  const spam = [];
  for (const [kp,count] of spamMap.entries()){
    if (count>1){
      const [songLower, artistLower, nameLower] = kp.split('|');
      const anyRow = rows.find(x => keySong(x.song_title||x.song,x.artist)===`${songLower}|${artistLower}` && String(x.name||'').toLowerCase()===nameLower);
      if (anyRow){
        spam.push({ song:anyRow.song_title||anyRow.song, artist:anyRow.artist, name:anyRow.name, count });
      }
    }
  }

  return { requests, playedGroups:[...playedGroups.values()], spam };
}

/* ===== Card builders ===== */
function namesBoxHTML(names){
  const items = names.map(n=>`<li>${escapeHTML(n)}</li>`).join('');
  return `<div class="names-box"><p class="hdr">Requesters</p><ul>${items}</ul></div>`;
}

async function setThumb(imgEl, song, artist){
  const src = await getArtwork(song, artist);
  if (src){ imgEl.src = src; imgEl.alt = `${song} cover`; }
}

function buildRequestCard(obj){
  const guestsCount = obj.people.length || 0;

  const card = document.createElement('div');
  card.className = 'card';
  card.dataset.key = obj.key;
  card.dataset.ids = JSON.stringify(obj.ids);

  card.innerHTML = `
    <img class="thumb" alt="" />
    <div class="meta">
      <p class="title">${escapeHTML(obj.song||'Unknown Title')}</p>
      <p class="sub">${escapeHTML(obj.artist||'Unknown Artist')}</p>
      <p class="sub">Requested by ${guestsCount} guest${guestsCount===1?'':'s'}</p>
      ${namesBoxHTML(obj.people)}
    </div>
    <div class="actions">
      <button class="btn played"   type="button">Mark as Played</button>
      <button class="btn names"    type="button">Show Names</button>
      <button class="btn remove"   type="button">Remove</button>
    </div>
  `;

  setThumb(card.querySelector('.thumb'), obj.song, obj.artist);

  const namesBtn = card.querySelector('.btn.names');
  const box = card.querySelector('.names-box');
  namesBtn.addEventListener('click', ()=>{
    box.classList.toggle('open');
    namesBtn.textContent = box.classList.contains('open') ? 'Hide Names' : 'Show Names';
  });

  const playBtn = card.querySelector('.btn.played');
  playBtn.addEventListener('click', async ()=>{
    reqList.removeChild(card);
    addPlayedCardFromRequestCard(card);
    updateCounts();
    const ids = JSON.parse(card.dataset.ids||'[]');
    try{
      await Promise.all(ids.map(id => jsonp(ENDPOINT_URL, { mode:'setPlayed', id, played:'true' })));
      fetchRows(true);
    }catch(e){
      playedList.removeChild(card);
      reqList.appendChild(card);
      updateCounts();
    }
  });

  const rmBtn = card.querySelector('.btn.remove');
  rmBtn.addEventListener('click', ()=>{
    removedKeySet.add(card.dataset.key);
    reqList.removeChild(card);
    addRemovedCardFromRequestCard(card);
    updateCounts();
  });

  return card;
}

function addPlayedCardFromRequestCard(requestCard){
  const card = requestCard;
  card.querySelector('.actions').innerHTML = `
    <button class="btn unplayed" type="button">Mark as Unplayed</button>
  `;
  const unBtn = card.querySelector('.btn.unplayed');
  unBtn.addEventListener('click', async ()=>{
    playedList.removeChild(card);
    addRequestCardFromPlayedCard(card);
    updateCounts();
    const ids = JSON.parse(card.dataset.ids||'[]');
    try{
      await Promise.all(ids.map(id => jsonp(ENDPOINT_URL, { mode:'setPlayed', id, played:'false' })));
      fetchRows(true);
    }catch(e){
      reqList.removeChild(card);
      playedList.appendChild(card);
      updateCounts();
    }
  });
  playedList.appendChild(card);
}

function addRequestCardFromPlayedCard(playedCard){
  const card = playedCard;
  const actions = document.createElement('div');
  actions.className = 'actions';
  actions.innerHTML = `
    <button class="btn played" type="button">Mark as Played</button>
    <button class="btn names"  type="button">Show Names</button>
    <button class="btn remove" type="button">Remove</button>
  `;
  card.querySelector('.actions')?.replaceWith(actions);

  const namesBtn = actions.querySelector('.btn.names');
  const box = card.querySelector('.names-box');
  namesBtn.addEventListener('click', ()=>{
    box.classList.toggle('open');
    namesBtn.textContent = box.classList.contains('open') ? 'Hide Names' : 'Show Names';
  });

  const playBtn = actions.querySelector('.btn.played');
  playBtn.addEventListener('click', async ()=>{
    reqList.removeChild(card);
    addPlayedCardFromRequestCard(card);
    updateCounts();
    const ids = JSON.parse(card.dataset.ids||'[]');
    try{
      await Promise.all(ids.map(id => jsonp(ENDPOINT_URL, { mode:'setPlayed', id, played:'true' })));
      fetchRows(true);
    }catch(e){
      playedList.removeChild(card);
      reqList.appendChild(card);
      updateCounts();
    }
  });

  const rmBtn = actions.querySelector('.btn.remove');
  rmBtn.addEventListener('click', ()=>{
    removedKeySet.add(card.dataset.key);
    reqList.removeChild(card);
    addRemovedCardFromRequestCard(card);
    updateCounts();
  });

  reqList.appendChild(card);
}

function addRemovedCardFromRequestCard(requestCard){
  const card = requestCard;
  const actions = document.createElement('div');
  actions.className = 'actions';
  actions.innerHTML = `
    <button class="btn names"  type="button">Show Names</button>
    <button class="btn putback" type="button">Put Back</button>
  `;
  card.querySelector('.actions')?.replaceWith(actions);

  const namesBtn = actions.querySelector('.btn.names');
  const box = card.querySelector('.names-box');
  namesBtn.addEventListener('click', ()=>{
    box.classList.toggle('open');
    namesBtn.textContent = box.classList.contains('open') ? 'Hide Names' : 'Show Names';
  });

  const putBack = actions.querySelector('.btn.putback');
  putBack.addEventListener('click', ()=>{
    removedKeySet.delete(card.dataset.key);
    removedList.removeChild(card);
    addRequestCardFromRemovedCard(card);
    updateCounts();
  });

  removedList.appendChild(card);
}

function addRequestCardFromRemovedCard(removedCard){
  const card = removedCard;
  const actions = document.createElement('div');
  actions.className = 'actions';
  actions.innerHTML = `
    <button class="btn played" type="button">Mark as Played</button>
    <button class="btn names"  type="button">Show Names</button>
    <button class="btn remove" type="button">Remove</button>
  `;
  card.querySelector('.actions')?.replaceWith(actions);

  const namesBtn = actions.querySelector('.btn.names');
  const box = card.querySelector('.names-box');
  namesBtn.addEventListener('click', ()=>{
    box.classList.toggle('open');
    namesBtn.textContent = box.classList.contains('open') ? 'Hide Names' : 'Show Names';
  });

  const playBtn = actions.querySelector('.btn.played');
  playBtn.addEventListener('click', async ()=>{
    reqList.removeChild(card);
    addPlayedCardFromRequestCard(card);
    updateCounts();
    const ids = JSON.parse(card.dataset.ids||'[]');
    try{
      await Promise.all(ids.map(id => jsonp(ENDPOINT_URL, { mode:'setPlayed', id, played:'true' })));
      fetchRows(true);
    }catch(e){
      playedList.removeChild(card);
      reqList.appendChild(card);
      updateCounts();
    }
  });

  const rmBtn = actions.querySelector('.btn.remove');
  rmBtn.addEventListener('click', ()=>{
    removedKeySet.add(card.dataset.key);
    reqList.removeChild(card);
    addRemovedCardFromRequestCard(card);
    updateCounts();
  });

  reqList.appendChild(card);
}

/* ===== Render ===== */
function renderAll(rows){
  const { requests, playedGroups, spam } = splitBuckets(rows);

  reqList.innerHTML = '';
  for (const r of requests){
    if (removedKeySet.has(r.key)) continue;
    reqList.appendChild(buildRequestCard(r));
  }

  playedList.innerHTML = '';
  for (const g of playedGroups){
    const card = buildRequestCard({ key:g.key, song:g.song, artist:g.artist, ids:g.ids, people:[...g.people] });
    addPlayedCardFromRequestCard(card);
  }

  spamList.innerHTML = '';
  for (const s of spam){
    const card = document.createElement('div');
    card.className = 'card';
    card.innerHTML = `
      <img class="thumb" alt="" />
      <div class="meta">
        <p class="title">${escapeHTML(s.song||'Unknown Title')}</p>
        <p class="sub">${escapeHTML(s.artist||'Unknown Artist')}</p>
        <p class="sub">Requested by ${escapeHTML(s.name||'Guest')} (x${s.count})</p>
      </div>
      <div class="actions"></div>
    `;
    setThumb(card.querySelector('.thumb'), s.song, s.artist);
    spamList.appendChild(card);
  }

  updateCounts();
}

function updateCounts(){
  reqCountEl.textContent     = `(${reqList.children.length})`;
  playedCountEl.textContent  = `(${playedList.children.length})`;
  removedCountEl.textContent = `(${removedList.children.length})`;
  spamCountTop.textContent   = `(${spamList.children.length})`;
}

/* ===== Collapsibles & Tabs ===== */
function initCollapsibles(){
  document.querySelectorAll('.collapsible-header').forEach(h=>{
    h.addEventListener('click', ()=>{
      const parent = h.parentElement;
      parent.classList.toggle('open');
      const twist = h.querySelector('.twist');
      if (twist) twist.textContent = parent.classList.contains('open') ? '▾' : '▸';
    });
  });
}

function setTab(which){
  if (which==='spam'){
    tabSpamBtn.classList.add('active'); tabRequestsBtn.classList.remove('active');
    tabSpamPane.classList.remove('hidden'); tabRequestsPane.classList.add('hidden');
  }else{
    tabRequestsBtn.classList.add('active'); tabSpamBtn.classList.remove('active');
    tabRequestsPane.classList.remove('hidden'); tabSpamPane.classList.add('hidden');
  }
}
tabRequestsBtn.addEventListener('click', ()=> setTab('requests'));
tabSpamBtn.addEventListener('click', ()=> setTab('spam'));

/* ===== Init ===== */
eventSel.addEventListener('change', ()=>{
  currentCode = eventSel.value || '';
  removedKeySet.clear();
  fetchRows(true);
  startPolling();
});

(async function boot(){
  await loadActiveEvents();          // working loader
  initCollapsibles();
  if (eventSel.value){ currentCode = eventSel.value; await fetchRows(true); startPolling(); }
})();
</script>
</body>
</html>

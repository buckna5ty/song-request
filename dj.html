<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<title>REQUESTS • David Charles Events</title>
<style>
  :root{
    --bg:#212121;
    --section:#363636;
    --subsection:#424242;
    --border:#2b2b2b;
    --ink:#f2f2f2;
    --muted:#bdbdbd;

    --accent:#1dcec9;   /* Mark as Played */
    --amber:#f7b731;    /* Mark as Unplayed */
    --danger:#b22222;   /* Remove */
    --put:#d81b60;      /* Put Back */

    --radius:12px;
    --maxw:1100px;
  }

  @font-face{
    font-family:"Adventor";
    src:url("texgyreadventor-regular.otf") format("opentype");
    font-weight:400; font-style:normal; font-display:swap;
  }

  *{ box-sizing:border-box; }
  html,body{
    margin:0; background:var(--bg); color:var(--ink);
    font-family:"Adventor", system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
  }
  .wrap{ max-width:var(--maxw); margin:0 auto; padding:16px 14px 56px; }
  .page-title{
    text-align:center; margin:8px 0 18px;
    letter-spacing:.06em; font-weight:800;
    font-size:clamp(22px,5.5vw,36px);
  }

  .panel{
    background:var(--section);
    border:1px solid var(--border);
    border-radius:var(--radius);
    padding:14px;
    margin-bottom:14px;
  }
  label{ display:block; font-size:14px; color:var(--muted); margin:0 0 6px; }
  select{
    height:46px; border-radius:12px; border:1px solid #3a3a3a;
    background:#2a2a2a; color:#fff; font-size:15px; padding:0 12px; width:100%;
  }
  .inline-info{ margin-top:8px; font-size:14px; min-height:22px; font-weight:500; }
  .inline-info.good{ color:#34d399; }
  .inline-info.bad{ color:#ef4444; }

  /* Folder tabs */
  .tabs-bar{
    display:flex; align-items:flex-end; gap:0; border-bottom:1px solid var(--border); padding:0 6px; margin-bottom:10px;
  }
  .tab-btn{
    height:36px; padding:0 14px; font-size:13px; color:#fff;
    background:#2f2f2f; border:1px solid var(--border); border-bottom:none;
    border-top-left-radius:10px; border-top-right-radius:10px;
    margin:0 6px; transform:translateY(1px); cursor:pointer;
  }
  .tab-btn.active{ background:var(--subsection); transform:translateY(0); }
  .hidden{ display:none!important; }

  /* Collapsibles */
  .collapsible{ background:var(--subsection); border:1px solid var(--border); border-radius:12px; padding:10px; margin-top:10px; }
  .collapsible-header{ display:flex; align-items:center; justify-content:space-between; cursor:pointer; user-select:none; }
  .twist{ width:18px; height:18px; display:grid; place-items:center; margin-left:8px; }
  .collapsible-body{ display:none; margin-top:10px; }
  .collapsible.open .collapsible-body{ display:block; }
  .count-pill{ font-size:13px; color:#dcdcdc; opacity:.9; margin-left:8px; }

  .list{ display:grid; gap:10px; } /* no extra padding => no top gap */

  .card{
    background:var(--section);
    border:1px solid var(--border);
    border-radius:12px;
    padding:10px;
    display:grid;
    grid-template-columns:64px 1fr 190px;
    gap:12px; align-items:center;
  }
  /* only NEW nodes animate in */
  .card.appear{ opacity:0; transform:translateY(6px); }
  .card.appear.card-ready{ transition:opacity .18s ease, transform .18s ease; opacity:1; transform:none; }
  /* during reorders we disable transitions to avoid flicker */
  .no-anim *{ transition:none!important; }

  @media (max-width:760px){ .card{ grid-template-columns:64px 1fr; } .card .actions{ grid-column:1/-1; } }

  .thumb{ width:64px;height:64px;border-radius:10px;background:#1f1f1f;object-fit:cover;display:block; }
  .meta{ min-width:0; }
  .title{ margin:0 0 2px; font-weight:800; font-size:16px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; color:#fff; }
  .sub{ margin:0; color:#e6e6e6; font-size:13px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }

  /* inline “Requested by …  ▸ Names” */
  .reqline{ display:flex; align-items:center; gap:10px; margin-top:2px; }
  .caret-link{
    font-size:12px; color:#dcdcdc; cursor:pointer; user-select:none; opacity:.9;
  }
  .caret-link:hover{ opacity:1; text-decoration:underline; }
  .caret-link .car{ display:inline-block; width:12px; }
  .names-box{ margin-top:6px; background:var(--subsection); border:1px solid var(--border); border-radius:10px; padding:8px 10px; display:none; }
  .names-box.open{ display:block; }
  .names-box .hdr{ color:#cfcfcf; font-size:13px; margin:0 0 4px; }
  .names-box ul{ margin:0; padding-left:18px; }
  .names-box li{ margin:3px 0; color:#fafafa; font-size:13px; }

  .actions{ display:grid; gap:6px; }
  .btn{
    display:inline-flex; align-items:center; justify-content:center;
    padding:0 10px; height:30px; font-size:12px; line-height:1;
    border-radius:8px; border:1px solid transparent; cursor:pointer;
    box-shadow:0 2px 0 rgba(0,0,0,.35), 0 8px 14px rgba(0,0,0,.15);
    width:82%; margin:0 auto;
  }
  .btn:hover{ filter:brightness(1.05); }
  .btn.played{   background:var(--accent); border-color:var(--accent); color:#000; }
  .btn.unplayed{ background:var(--amber);  border-color:var(--amber);  color:#000; }
  .btn.remove{   background:var(--danger); border-color:var(--danger); color:#fff; }
  .btn.putback{  background:var(--put);    border-color:var(--put);    color:#fff; }

  .footer-line{ margin-top:10px; color:#fff; font-size:12px; }
</style>
</head>
<body>
  <div class="wrap">
    <div class="page-title">REQUESTS</div>

    <div class="panel">
      <label for="eventSel">Select Your Event</label>
      <select id="eventSel"></select>
      <div id="inlineInfo" class="inline-info" aria-live="polite"></div>
    </div>

    <div class="panel">
      <div class="tabs-bar">
        <button id="tabRequests" class="tab-btn active" type="button">Requests</button>
        <button id="tabSpam" class="tab-btn" type="button">Spam</button>
      </div>

      <div id="tabRequestsPane">
        <div class="collapsible open" id="reqWrap">
          <div class="collapsible-header" data-target="reqBody">
            <div>Requests <span id="reqCount" class="count-pill">(0)</span></div>
            <div class="twist">▾</div>
          </div>
          <div id="reqBody" class="collapsible-body">
            <div id="reqList" class="list"></div>
          </div>
        </div>

        <div class="collapsible" id="playedWrap">
          <div class="collapsible-header" data-target="playedBody">
            <div>Played Songs <span id="playedCount" class="count-pill">(0)</span></div>
            <div class="twist">▸</div>
          </div>
          <div id="playedBody" class="collapsible-body">
            <div id="playedList" class="list"></div>
          </div>
        </div>

        <div class="collapsible" id="removedWrap">
          <div class="collapsible-header" data-target="removedBody">
            <div>Removed Songs <span id="removedCount" class="count-pill">(0)</span></div>
            <div class="twist">▸</div>
          </div>
          <div id="removedBody" class="collapsible-body">
            <div id="removedList" class="list"></div>
          </div>
        </div>

        <div class="footer-line" id="statusLine"></div>
      </div>

      <div id="tabSpamPane" class="hidden">
        <div style="margin:6px 0 10px; font-size:18px; font-weight:800;">
          Spammed Requests <span id="spamCountTop" class="count-pill">(0)</span>
        </div>
        <div id="spamList" class="list"></div>
      </div>
    </div>
  </div>

<script>
/* ===== Config ===== */
const ENDPOINT_URL = 'https://script.google.com/macros/s/AKfycbxkSPUc2VWQYkhJ_af7CShegZLAMmVgUsTp2nMeVwkkhdFbdQT8wk2s6xBAAynjtLDT/exec';
const POLL_MS = 5000;

/* ===== Elements ===== */
const $ = s => document.querySelector(s);
const eventSel=$('#eventSel'), inlineInfo=$('#inlineInfo');
const tabRequestsBtn=$('#tabRequests'), tabSpamBtn=$('#tabSpam');
const tabRequestsPane=$('#tabRequestsPane'), tabSpamPane=$('#tabSpamPane');

const reqList=$('#reqList'), playedList=$('#playedList'), removedList=$('#removedList'), spamList=$('#spamList');
const reqCountEl=$('#reqCount'), playedCountEl=$('#playedCount'), removedCountEl=$('#removedCount'), spamCountTop=$('#spamCountTop');
const statusLine=$('#statusLine');

/* ===== State ===== */
let currentCode=''; let pollTimer=null; let rowsCache=[];
const removedKeySet=new Set();        // local “Removed” groups
const artCache=new Map();

/* ===== Utils ===== */
function pad2(n){return String(n).padStart(2,'0');}
function dow3(n){return ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'][n]||'';}
function formatHeaderDate(s){ const d=new Date(s); if(isNaN(d))return''; return `${dow3(d.getDay())} ${pad2(d.getMonth()+1)}.${pad2(d.getDate())}.${String(d.getFullYear()).slice(-2)}`;}
function showInline(msg){ inlineInfo.textContent=msg||''; inlineInfo.classList.remove('good','bad'); if(!msg)return; const m=msg.toLowerCase(); if(m.startsWith('loading')) inlineInfo.classList.add('good'); else if(m.includes('could not load')) inlineInfo.classList.add('bad'); }
function keySong(song,artist){ return `${(song||'').toLowerCase()}|${(artist||'').toLowerCase()}`;}
function escapeHTML(s){ return String(s||'').replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

/* JSONP */
function jsonp(url,params={}){ const qs=new URLSearchParams(params); const cb='cb_'+Math.random().toString(36).slice(2); qs.set('callback',cb); qs.set('t',Date.now());
  return new Promise((res,rej)=>{ const s=document.createElement('script'); s.src=url+(url.includes('?')?'&':'?')+qs.toString();
    const kill=setTimeout(()=>{cleanup(); rej(new Error('timeout'));},9000);
    function cleanup(){clearTimeout(kill); try{delete window[cb];}catch{} s.remove();}
    window[cb]=(d)=>{cleanup(); res(d);}; s.onerror=()=>{cleanup(); rej(new Error('jsonp'));}; document.body.appendChild(s);
  });
}

/* Artwork */
async function getArtwork(song,artist){
  const k=keySong(song,artist); if(artCache.has(k)) return artCache.get(k);
  try{ const data=await jsonp('https://itunes.apple.com/search',{term:`${song} ${artist}`.trim(),entity:'musicTrack',limit:1});
    const url=data?.results?.[0]?.artworkUrl100||data?.results?.[0]?.artworkUrl60||''; artCache.set(k,url||''); return url||'';
  }catch{ artCache.set(k,''); return ''; }
}

/* Events */
async function loadActiveEvents(){
  showInline('Loading your events...');
  try{
    const r=await jsonp(ENDPOINT_URL,{mode:'listActive'}); const list=Array.isArray(r?.events)?r.events:[];
    list.sort((a,b)=>new Date(a.date||0)-new Date(b.date||0));
    eventSel.innerHTML='';
    if(!list.length){ const opt=document.createElement('option'); opt.value=''; opt.textContent='No active events'; eventSel.appendChild(opt); currentCode=''; showInline('Could not load events.'); return; }
    for(const ev of list){ const opt=document.createElement('option'); opt.value=ev.code; const d=formatHeaderDate(ev.date); opt.textContent=d?`${d} - ${ev.name}`:(ev.name||ev.code); eventSel.appendChild(opt); }
    const pre=(new URLSearchParams(location.search).get('event')||'').trim(); if(pre&&[...eventSel.options].some(o=>o.value===pre)) eventSel.value=pre;
    currentCode=eventSel.value||''; showInline('');
  }catch{ showInline('Could not load events.'); }
}

/* Polling */
function startPolling(){ stopPolling(); pollTimer=setInterval(fetchRows, POLL_MS); }
function stopPolling(){ if(pollTimer) clearInterval(pollTimer); pollTimer=null; }

async function fetchRows(){
  if(!currentCode) return;
  showInline('Loading your requests...');
  try{
    const r=await jsonp(ENDPOINT_URL,{mode:'read',event:currentCode});
    rowsCache=Array.isArray(r?.rows)?r.rows:[];
    renderAll(rowsCache);
    statusLine.textContent = rowsCache.length ? '' : 'No requests yet.';
  }catch{ statusLine.textContent='Connection error.'; } finally{ showInline(''); }
}

/* Build structures */
function splitBuckets(rows){
  const bySong=new Map();           // group by song/artist
  const playedGroups=new Map();
  const spamMap=new Map();

  for(const row of rows){
    const song=row.song_title||row.song||''; const artist=row.artist||''; const k=keySong(song,artist);
    if(!bySong.has(k)) bySong.set(k,{song,artist,ids:[],names:new Set()});
    if(!row.played) { bySong.get(k).ids.push(row.id); if(row.name) bySong.get(k).names.add(row.name); }

    if(row.played){
      if(!playedGroups.has(k)) playedGroups.set(k,{key:k,song,artist,ids:[],names:new Set()});
      const g=playedGroups.get(k); g.ids.push(row.id); if(row.name) g.names.add(row.name);
    }

    const kp=`${k}|${(row.name||'').toLowerCase()}`; spamMap.set(kp,(spamMap.get(kp)||0)+1);
  }

  const requests=[];
  for(const [k,grp] of bySong.entries()){
    if(grp.ids.length && !removedKeySet.has(k)){
      requests.push({ key:k, song:grp.song, artist:grp.artist, ids:grp.ids, people:[...grp.names] });
    }
  }

  const removed=[];
  for(const key of removedKeySet){
    const base=bySong.get(key);
    if(base){ removed.push({ key, song:base.song, artist:base.artist, ids:base.ids, people:[...base.names] }); }
  }

  const spam=[];
  for(const [kp,count] of spamMap.entries()){
    if(count>1){
      const [songLower,artistLower,nameLower]=kp.split('|');
      const any=rows.find(x=> keySong(x.song_title||x.song,x.artist)===`${songLower}|${artistLower}` && String(x.name||'').toLowerCase()===nameLower );
      if(any){ spam.push({ song:any.song_title||any.song, artist:any.artist, name:any.name, count }); }
    }
  }

  return { requests, playedGroups:[...playedGroups.values()], removed, spam };
}

/* Card helpers */
function namesBoxHTML(names){ return `<div class="names-box"><p class="hdr">Requesters</p><ul>${names.map(n=>`<li>${escapeHTML(n)}`).join('')}</ul></div>`; }

function buildCardBase(obj){
  const guests=obj.people.length;
  const el=document.createElement('div');
  el.className='card appear';
  el.dataset.key=obj.key;
  el.dataset.ids=JSON.stringify(obj.ids);
  el.innerHTML=`
    <img class="thumb" alt="">
    <div class="meta">
      <p class="title">${escapeHTML(obj.song||'Unknown Title')}</p>
      <p class="sub">${escapeHTML(obj.artist||'Unknown Artist')}</p>
      <div class="reqline">
        <span class="sub req-count">Requested by ${guests} guest${guests===1?'':'s'}</span>
        <span class="caret-link"><span class="car">▸</span> <span class="txt">Names</span></span>
      </div>
      ${namesBoxHTML(obj.people)}
    </div>
    <div class="actions"></div>
  `;
  getArtwork(obj.song,obj.artist).then(src=>{ if(src){ const img=el.querySelector('.thumb'); img.src=src; img.alt=`${obj.song} cover`; }});
  // caret names
  const box=el.querySelector('.names-box'); const caret=el.querySelector('.caret-link');
  caret.addEventListener('click',()=>{
    const open=box.classList.toggle('open');
    caret.querySelector('.car').textContent=open?'▾':'▸';
    caret.querySelector('.txt').textContent=open?'Hide names':'Names';
  });
  // finalize appear
  requestAnimationFrame(()=> el.classList.add('card-ready'));
  return el;
}
function updateCardBase(node,obj){
  node.dataset.ids=JSON.stringify(obj.ids);
  node.querySelector('.title').textContent=obj.song||'Unknown Title';
  node.querySelector('.sub').textContent=obj.artist||'Unknown Artist';
  node.querySelector('.req-count').textContent=`Requested by ${obj.people.length} guest${obj.people.length===1?'':'s'}`;
  const box=node.querySelector('.names-box');
  box.innerHTML=`<p class="hdr">Requesters</p><ul>${obj.people.map(n=>`<li>${escapeHTML(n)}`).join('')}</ul>`;
}

/* Action button blocks */
function setRowsPlayed(ids, playedBool){
  let touched=false;
  rowsCache=rowsCache.map(r=> ids.includes(r.id)?(touched=true,{...r,played:!!playedBool}):r);
  if(touched) renderAll(rowsCache);
}

function attachRequestActions(card){
  const actions=card.querySelector('.actions');
  actions.innerHTML=`
    <button class="btn played" type="button">Mark as Played</button>
    <button class="btn remove" type="button">Remove</button>
  `;
  actions.querySelector('.btn.played').addEventListener('click', async ()=>{
    const ids=JSON.parse(card.dataset.ids||'[]');
    setRowsPlayed(ids,true);
    try{ await Promise.all(ids.map(id=>jsonp(ENDPOINT_URL,{mode:'setPlayed',id,played:'true'}))); }catch{}
  });
  actions.querySelector('.btn.remove').addEventListener('click', ()=>{
    removedKeySet.add(card.dataset.key);
    renderAll(rowsCache);
  });
}
function attachPlayedActions(card){
  const actions=card.querySelector('.actions');
  actions.innerHTML=`
    <button class="btn unplayed" type="button">Mark as Unplayed</button>
  `;
  actions.querySelector('.btn.unplayed').addEventListener('click', async ()=>{
    const ids=JSON.parse(card.dataset.ids||'[]');
    setRowsPlayed(ids,false);
    try{ await Promise.all(ids.map(id=>jsonp(ENDPOINT_URL,{mode:'setPlayed',id,played:'false'}))); }catch{}
  });
}
function attachRemovedActions(card){
  const actions=card.querySelector('.actions');
  actions.innerHTML=`
    <button class="btn putback" type="button">Put Back</button>
  `;
  actions.querySelector('.btn.putback').addEventListener('click', ()=>{
    removedKeySet.delete(card.dataset.key);
    renderAll(rowsCache);
  });
}

/* ===== Stable renderer (no flicker) =====
   - Keeps nodes, updates content in place
   - Reorders via insertBefore
   - Only new nodes get a small appear fade
*/
function renderList(container, items, makeNode, updateNode){
  // map existing
  const existing = new Map();
  Array.from(container.children).forEach(ch=> existing.set(ch.dataset.key, ch));

  // remove ones that should not exist
  existing.forEach((node,key)=>{ if(!items.some(it=>it.key===key)) node.remove(); });

  // disable transitions while reflowing order
  container.classList.add('no-anim');

  // desired order assembly
  let nextSibling = container.firstChild;
  for(const it of items){
    let node = existing.get(it.key);
    if(!node){
      node = makeNode(it);
      container.insertBefore(node, nextSibling || null);
    }else{
      updateNode(node,it);
      if(node !== nextSibling){
        container.insertBefore(node, nextSibling || null);
      }
    }
    nextSibling = node.nextSibling;
  }

  // re-enable animations next frame
  requestAnimationFrame(()=> container.classList.remove('no-anim'));
}

/* Build & render frame */
function renderAll(rows){
  const {requests, playedGroups, removed, spam}=splitBuckets(rows);

  const sortedReq=[...requests].sort((a,b)=> b.people.length - a.people.length || (a.song||'').localeCompare(b.song||''));
  renderList(reqList, sortedReq,
    (obj)=>{ const el=buildCardBase(obj); attachRequestActions(el); return el; },
    (node,obj)=> updateCardBase(node,obj)
  );

  const pg=[...playedGroups].sort((a,b)=>(a.song||'').localeCompare(b.song||''));
  renderList(playedList, pg.map(x=>({key:x.key,song:x.song,artist:x.artist,ids:x.ids,people:[...x.names]})),
    (obj)=>{ const el=buildCardBase(obj); attachPlayedActions(el); return el; },
    (node,obj)=> updateCardBase(node,obj)
  );

  renderList(removedList, removed,
    (obj)=>{ const el=buildCardBase(obj); attachRemovedActions(el); return el; },
    (node,obj)=> updateCardBase(node,obj)
  );

  // spam (simple rebuild—small volume)
  spamList.innerHTML='';
  for(const s of spam){
    const el=document.createElement('div'); el.className='card';
    el.innerHTML=`
      <img class="thumb" alt="">
      <div class="meta">
        <p class="title">${escapeHTML(s.song||'Unknown Title')}</p>
        <p class="sub">${escapeHTML(s.artist||'Unknown Artist')}</p>
        <p class="sub">Requested by ${escapeHTML(s.name||'Guest')} (x${s.count})</p>
      </div>
      <div class="actions"></div>
    `;
    getArtwork(s.song,s.artist).then(src=>{ if(src){ el.querySelector('.thumb').src=src; }});
    spamList.appendChild(el);
  }

  // counts
  reqCountEl.textContent    = `(${reqList.children.length})`;
  playedCountEl.textContent = `(${playedList.children.length})`;
  removedCountEl.textContent= `(${removedList.children.length})`;
  spamCountTop.textContent  = `(${spamList.children.length})`;
}

/* Collapsibles & tabs */
function initCollapsibles(){
  document.querySelectorAll('.collapsible-header').forEach(h=>{
    h.addEventListener('click',()=>{
      const p=h.parentElement; p.classList.toggle('open');
      const t=h.querySelector('.twist'); if(t) t.textContent=p.classList.contains('open')?'▾':'▸';
    });
  });
}
function setTab(which){
  if(which==='spam'){ tabSpamBtn.classList.add('active'); tabRequestsBtn.classList.remove('active'); tabSpamPane.classList.remove('hidden'); tabRequestsPane.classList.add('hidden'); }
  else{ tabRequestsBtn.classList.add('active'); tabSpamBtn.classList.remove('active'); tabRequestsPane.classList.remove('hidden'); tabSpamPane.classList.add('hidden'); }
}
tabRequestsBtn.addEventListener('click',()=>setTab('requests'));
tabSpamBtn.addEventListener('click',()=>setTab('spam'));

/* Init */
async function loadActiveEvents(){
  showInline('Loading your events...');
  try{
    const r=await jsonp(ENDPOINT_URL,{mode:'listActive'}); const list=Array.isArray(r?.events)?r.events:[];
    list.sort((a,b)=>new Date(a.date||0)-new Date(b.date||0));
    eventSel.innerHTML='';
    if(!list.length){ const opt=document.createElement('option'); opt.value=''; opt.textContent='No active events'; eventSel.appendChild(opt); currentCode=''; showInline('Could not load events.'); return; }
    for(const ev of list){ const opt=document.createElement('option'); opt.value=ev.code; const d=(function(s){ const d=new Date(s); if(isNaN(d))return''; return `${['Sun','Mon','Tue','Wed','Thu','Fri','Sat'][d.getDay()]} ${String(d.getMonth()+1).padStart(2,'0')}.${String(d.getDate()).padStart(2,'0')}.${String(d.getFullYear()).slice(-2)}`;})(ev.date);
      opt.textContent=d?`${d} - ${ev.name}`:(ev.name||ev.code); eventSel.appendChild(opt);
    }
    const pre=(new URLSearchParams(location.search).get('event')||'').trim(); if(pre&&[...eventSel.options].some(o=>o.value===pre)) eventSel.value=pre;
    currentCode=eventSel.value||''; showInline('');
  }catch{ showInline('Could not load events.'); }
}

eventSel.addEventListener('change', ()=>{ currentCode=eventSel.value||''; removedKeySet.clear(); fetchRows(); startPolling(); });

function startPolling(){ stopPolling(); pollTimer=setInterval(fetchRows, POLL_MS); }
function stopPolling(){ if(pollTimer) clearInterval(pollTimer); pollTimer=null; }

(async function boot(){
  await loadActiveEvents();
  initCollapsibles();
  setTab('requests');
  if(eventSel.value){ currentCode=eventSel.value; await fetchRows(); startPolling(); }
})();
</script>
</body>
</html>

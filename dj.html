<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>DCE • DJ View</title>
<style>
  :root{ --ink:#0f172a; --sub:#475569; --border:#e2e8f0; --bg:#f8fafc; --card:#ffffff; --radius:14px; }
  *{ box-sizing:border-box; }
  body{ margin:0; font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif; background:var(--bg); color:var(--ink); }
  .wrap{ max-width:1100px; margin:0 auto; padding:18px 14px 40px; }
  h1{ margin:0 0 14px; font-size:28px; line-height:1.1; }
  .sub{ color:var(--sub); margin:4px 0 16px; }
  .grid{ display:grid; gap:14px; grid-template-columns:1.2fr 1fr; }
  .card{ background:var(--card); border:1px solid var(--border); border-radius:var(--radius); padding:14px; }
  .row{ display:flex; gap:10px; align-items:center; margin-bottom:10px; flex-wrap:wrap; }
  .pill{ border:1px solid var(--border); border-radius:999px; padding:6px 10px; background:#fff; font-size:13px; }
  table{ width:100%; border-collapse:separate; border-spacing:0 8px; }
  th{ text-align:left; font-size:12px; color:var(--sub); font-weight:600; }
  td{ background:#fff; border:1px solid var(--border); padding:10px 12px; }
  td:first-child{ border-radius:10px 0 0 10px; }
  td:last-child{ border-radius:0 10px 10px 0; }
  .badge{ display:inline-block; min-width:26px; text-align:center; padding:2px 8px; border-radius:999px; border:1px solid var(--border); background:#fff; font-size:12px; }
  .mono{ font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; color:#334155; }
  .muted{ color:#64748b; font-size:12px; }
  .feed{ max-height:62vh; overflow:auto; padding-right:4px; }
  button{ height:40px; padding:0 14px; border:1px solid var(--border); background:#111; color:#fff; border-radius:10px; cursor:pointer; }
  button.secondary{ background:#fff; color:#111; }
</style>
</head>
<body>
<div class="wrap">
  <h1>DJ View</h1>
  <p class="sub">Live requests (de-duped per person+song). Use <span class="mono">?event=CODE</span> or it will load the current event from config.</p>

  <div class="row">
    <span class="muted">Endpoint is preconfigured. Override with <span class="mono">?ep=URL</span> if needed.</span>
    <button id="refresh">Refresh</button>
    <button id="auto" class="secondary">Auto: Off</button>
  </div>
  <div class="row"><span id="status" class="muted"></span></div>

  <div class="grid">
    <div class="card">
      <div class="row"><div class="pill" id="countPill">0 unique requests</div></div>
      <div class="feed" id="feed"></div>
    </div>

    <div class="card">
      <h3 style="margin:6px 0 10px;">Top Songs</h3>
      <table id="topSongs"><thead><tr><th>#</th><th>Song</th><th>Artist</th><th>Reqs</th></tr></thead><tbody></tbody></table>

      <h3 style="margin:16px 0 10px;">Top Artists</h3>
      <table id="topArtists"><thead><tr><th>#</th><th>Artist</th><th>Reqs</th></tr></thead><tbody></tbody></table>
    </div>
  </div>
</div>

<script>
/* ------------ Config ------------ */
const DEFAULT_ENDPOINT_URL = 'https://script.google.com/macros/s/AKfycbzRjQFNePsGmd5c-edTvgrzfLrtn21b1ZZBZKcKQ0OeIEwo1jeIpRCMAjxP6zHtJ1u9rg/exec';

/* ------------ URL params / Event ------------ */
const urlp = new URLSearchParams(location.search);
const ENDPOINT_URL = urlp.get('ep') || DEFAULT_ENDPOINT_URL;
let EVENT_CODE = (urlp.get('event') || '').trim();

/* ------------ DOM & helpers ------------ */
const $ = s=>document.querySelector(s);
const feedEl = $('#feed'), topSongsEl = $('#topSongs tbody'), topArtistsEl = $('#topArtists tbody'),
      statusEl=$('#status'), countPill=$('#countPill');
const btnRefresh = $('#refresh'), btnAuto=$('#auto');

function setStatus(m){ statusEl.textContent = m || ''; }
function jsonp(url, cbParam='callback'){
  return new Promise((resolve, reject)=>{
    const cb='cb_'+Math.random().toString(36).slice(2);
    const sep = url.includes('?') ? '&' : '?';
    const src=`${url}${sep}${cbParam}=${cb}`;
    const s=document.createElement('script');
    const kill=setTimeout(()=>{cleanup(); reject(new Error('timeout'));},9000);
    function cleanup(){ clearTimeout(kill); try{delete window[cb];}catch{} s.parentNode&&s.parentNode.removeChild(s); }
    window[cb]=(data)=>{ cleanup(); resolve(data); };
    s.onerror=()=>{ cleanup(); reject(new Error('jsonp error')); };
    s.src=src; document.body.appendChild(s);
  });
}

function dedupeByPersonSong(rows){
  const seen = new Set();
  const out = [];
  for(const r of rows){
    const key = (r.name||'').trim().toLowerCase() + '||' + (r.song_title||'').trim().toLowerCase();
    if(seen.has(key)) continue;
    seen.add(key);
    out.push(r);
  }
  return out;
}
function groupCounts(items, keyFn){
  const map = new Map();
  for(const it of items){
    const k = keyFn(it);
    map.set(k, (map.get(k)||0)+1);
  }
  return Array.from(map.entries()).sort((a,b)=>b[1]-a[1]);
}
function renderFeed(rows){
  feedEl.innerHTML='';
  for(const r of rows){
    const row = document.createElement('div');
    row.style.marginBottom='8px';
    row.innerHTML = `
      <div><strong>${r.song_title || 'Unknown'}</strong> — ${r.artist || ''}</div>
      <div class="muted">${r.name || 'anon'} • <span class="mono">${r.timestamp||''}</span></div>
    `;
    feedEl.appendChild(row);
  }
}
function renderTopSongs(rows){
  topSongsEl.innerHTML='';
  const counts = groupCounts(rows, r => (r.song_title||'').trim().toLowerCase() + ' | ' + (r.artist||'').trim().toLowerCase());
  counts.slice(0,10).forEach(([k,c],i)=>{
    const [song, artist] = k.split(' | ');
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${i+1}</td><td>${song}</td><td>${artist}</td><td><span class="badge">${c}</span></td>`;
    topSongsEl.appendChild(tr);
  });
}
function renderTopArtists(rows){
  topArtistsEl.innerHTML='';
  const counts = groupCounts(rows, r => (r.artist||'').trim().toLowerCase());
  counts.slice(0,10).forEach(([artist,c],i)=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${i+1}</td><td>${artist}</td><td><span class="badge">${c}</span></td>`;
    topArtistsEl.appendChild(tr);
  });
}

async function ensureEventCode(){
  if (EVENT_CODE) return EVENT_CODE;
  try{
    const data = await jsonp(`${ENDPOINT_URL}?mode=getevent&key=main`, 'callback');
    if(data && data.ok){ EVENT_CODE = (data.value || '').trim(); }
  }catch{}
  return EVENT_CODE;
}

async function refresh(){
  await ensureEventCode();
  const qs = new URLSearchParams({ mode:'read', limit:'500' });
  if(EVENT_CODE) qs.set('event', EVENT_CODE);
  setStatus('Loading…');
  try{
    const data = await jsonp(`${ENDPOINT_URL}?${qs.toString()}`, 'callback');
    if(!data || !data.ok){ setStatus('Server error.'); return; }
    const rows = Array.isArray(data.rows) ? data.rows : [];
    const uniq = dedupeByPersonSong(rows);
    countPill.textContent = `${uniq.length} unique requests`;
    renderFeed(uniq); renderTopSongs(uniq); renderTopArtists(uniq);
    setStatus(`Updated ${new Date().toLocaleTimeString()}`);
  }catch(e){ setStatus('Fetch failed.'); }
}
btnRefresh.addEventListener('click', refresh);

let auto=false, timer=null;
btnAuto.addEventListener('click', ()=>{
  auto=!auto;
  if(auto){ btnAuto.textContent='Auto: On'; refresh(); timer=setInterval(refresh, 10000); }
  else{ btnAuto.textContent='Auto: Off'; clearInterval(timer); timer=null; }
});

window.addEventListener('load', refresh);
</script>
</body>
</html>

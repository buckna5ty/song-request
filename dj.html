<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>DCE • DJ View</title>
<style>
  :root{ --ink:#0f172a; --sub:#475569; --border:#e2e8f0; --bg:#f8fafc; --card:#ffffff; --radius:14px; }
  *{ box-sizing:border-box; } body{ margin:0; font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif; background:var(--bg); color:var(--ink); }
  .wrap{ max-width:1100px; margin:0 auto; padding:18px 14px 40px; }
  h1{ margin:0 0 14px; font-size:28px; }
  .row{ display:flex; gap:10px; align-items:center; margin-bottom:10px; flex-wrap:wrap; }
  .card{ background:var(--card); border:1px solid var(--border); border-radius:14px; padding:14px; }
  .grid{ display:grid; gap:14px; grid-template-columns:1.25fr 1fr; }
  .pill{ border:1px solid var(--border); border-radius:999px; padding:6px 10px; background:#fff; font-size:13px; }
  .muted{ color:#64748b; font-size:12px; }
  .feed{ max-height:62vh; overflow:auto; padding-right:4px; }
  .item{ background:#fff; border:1px solid var(--border); border-radius:10px; padding:10px 12px; margin-bottom:8px; display:flex; gap:10px; align-items:center; }
  .title{ font-weight:700; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:56ch; }
  .btn{ height:36px; padding:0 12px; border:1px solid var(--border); background:#111; color:#fff; border-radius:10px; cursor:pointer; }
  .btn.secondary{ background:#fff; color:#111; }
  details{ background:#fff; border:1px solid var(--border); border-radius:10px; padding:10px 12px; }
  details > summary{ cursor:pointer; font-weight:600; }
  table{ width:100%; border-collapse:separate; border-spacing:0 8px; }
  th{ text-align:left; font-size:12px; color:#475569; font-weight:600; }
  td{ background:#fff; border:1px solid var(--border); padding:10px 12px; }
  td:first-child{ border-radius:10px 0 0 10px; } td:last-child{ border-radius:0 10px 10px 0; }
  .badge{ display:inline-block; min-width:26px; text-align:center; padding:2px 8px; border-radius:999px; border:1px solid var(--border); background:#fff; font-size:12px; }
  select{ height:36px; border:1px solid var(--border); border-radius:10px; padding:0 10px; }
</style>
</head>
<body>
<div class="wrap">
  <h1>DJ View</h1>

  <div class="row">
    <label for="eventSelect" class="muted">Active Event</label>
    <select id="eventSelect"><option value="">(loading active events…)</option></select>
    <button id="refresh" class="btn secondary">Refresh</button>
    <span id="status" class="muted" style="margin-left:auto;"></span>
  </div>

  <div class="grid">
    <div class="card">
      <div class="row">
        <div class="pill" id="countPill">0 unique requests</div>
        <div class="pill" id="dbgPill" style="margin-left:8px; display:none;"></div>
      </div>
      <div class="feed" id="feed"></div>

      <details id="playedBox" style="margin-top:10px;">
        <summary>Played songs</summary>
        <div id="playedList" class="feed" style="max-height:32vh;"></div>
      </details>

      <details id="spamBox" style="margin-top:10px;">
        <summary>Spammed requests (duplicates from same person)</summary>
        <div id="spamList" class="feed" style="max-height:32vh;"></div>
      </details>
    </div>

    <div class="card">
      <h3 style="margin:6px 0 10px;">Top Songs</h3>
      <table id="topSongs"><thead><tr><th>#</th><th>Song</th><th>Artist</th><th>Reqs</th></tr></thead><tbody></tbody></table>

      <h3 style="margin:16px 0 10px;">Top Artists</h3>
      <table id="topArtists"><thead><tr><th>#</th><th>Artist</th><th>Reqs</th></tr></thead><tbody></tbody></table>
    </div>
  </div>
</div>

<script>
/* -------- CONFIG -------- */
const ENDPOINT_URL = 'https://script.google.com/macros/s/AKfycbxZ9ylpDohWZnp1Krsn9THEPEciFv68uBB5unr0a41qNTesaOBkCWsQOeiucY4asIYH5A/exec';
/* ------------------------ */

const urlp = new URLSearchParams(location.search);
const PRESELECT_EVENT = (urlp.get('event') || '').trim();

const $=s=>document.querySelector(s);
const eventSelect=$('#eventSelect'), feedEl=$('#feed'),
      playedList=$('#playedList'), spamList=$('#spamList'),
      topSongsEl=$('#topSongs tbody'), topArtistsEl=$('#topArtists tbody'),
      statusEl=$('#status'), countPill=$('#countPill'), dbgPill=$('#dbgPill'),
      btnRefresh=$('#refresh');

function setStatus(m){ statusEl.textContent = m || ''; }
function showDbg(m){ dbgPill.style.display='inline-block'; dbgPill.textContent=m; }

/* JSONP helper */
function jsonp(url){
  return new Promise((resolve,reject)=>{
    const cb='cb_'+Math.random().toString(36).slice(2);
    const s=document.createElement('script'); s.src = url + (url.includes('?')?'&':'?') + 'callback=' + cb;
    const kill=setTimeout(()=>{cleanup(); reject(new Error('timeout'));},9000);
    function cleanup(){ clearTimeout(kill); try{delete window[cb];}catch{} s.remove(); }
    window[cb]=(data)=>{ cleanup(); resolve(data); };
    s.onerror=()=>{ cleanup(); reject(new Error('jsonp error')); };
    document.body.appendChild(s);
  });
}

/* ---- normalize event: accept full URLs or plain codes ---- */
function extractCode(v){
  const s = (v==null?'':String(v)).trim();
  if (!s) return '';
  try {
    const u = new URL(s);
    const ev = (u.searchParams.get('event') || '').trim();
    if (ev) return ev.toLowerCase();
  } catch(_) {}
  return s.toLowerCase();
}

/* Utilities */
function dedupe(rows){
  const seen=new Set(), uniq=[], spam=[];
  for(const r of rows){
    const key=(r.name||'').trim().toLowerCase()+'||'+(r.song_title||'').trim().toLowerCase();
    if(seen.has(key)){ spam.push(r); continue; }
    seen.add(key); uniq.push(r);
  }
  return {uniq, spam};
}
function groupCounts(items, keyFn){
  const map=new Map(); for(const it of items){ const k=keyFn(it); map.set(k,(map.get(k)||0)+1); }
  return Array.from(map.entries()).sort((a,b)=>b[1]-a[1]);
}
function elItem(r, controls=true){
  const div=document.createElement('div'); div.className='item';
  div.innerHTML=`<div class="title">${r.song_title||'Unknown'} — ${r.artist||''}</div>
                 <div class="muted" style="margin-left:auto;">${r.name||'anon'}</div>`;
  const btn=document.createElement('button'); btn.className='btn secondary';
  btn.textContent = controls ? 'Mark as played' : 'Mark as unplayed';
  btn.addEventListener('click', ()=> setPlayed(r.id, controls ? 1 : 0));
  div.appendChild(btn);
  return div;
}
function renderLists(all){
  const notPlayed = all.filter(r=>!r.played);
  const played    = all.filter(r=> r.played);
  const {uniq, spam} = dedupe(notPlayed);

  feedEl.innerHTML=''; uniq.forEach(r=> feedEl.appendChild(elItem(r, true)));
  countPill.textContent = `${uniq.length} unique requests`;

  playedList.innerHTML=''; played.forEach(r=> playedList.appendChild(elItem(r, false)));

  spamList.innerHTML=''; spam.forEach(r=>{
    const d=document.createElement('div'); d.className='item';
    d.innerHTML = `<div class="title">${r.song_title||'Unknown'} — ${r.artist||''}</div>
                   <div class="muted" style="margin-left:auto;">${r.name||'anon'} (duplicate)</div>`;
    spamList.appendChild(d);
  });

  topSongsEl.innerHTML=''; topArtistsEl.innerHTML='';
  groupCounts(uniq, r=>(r.song_title||'').trim().toLowerCase()+' | '+(r.artist||'').trim().toLowerCase())
    .slice(0,10).forEach(([k,c],i)=>{ const [song,artist]=k.split(' | '); const tr=document.createElement('tr'); tr.innerHTML=`<td>${i+1}</td><td>${song}</td><td>${artist}</td><td><span class="badge">${c}</span></td>`; topSongsEl.appendChild(tr); });
  groupCounts(uniq, r=>(r.artist||'').trim().toLowerCase())
    .slice(0,10).forEach(([artist,c],i)=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td>${i+1}</td><td>${artist}</td><td><span class="badge">${c}</span></td>`; topArtistsEl.appendChild(tr); });
}

/* ----- Active events ----- */
async function loadActiveEvents(){
  const prev = eventSelect.value;
  try{
    const data = await jsonp(`${ENDPOINT_URL}?mode=events_list&active=1`);
    const list = (data && data.ok && Array.isArray(data.events)) ? data.events : [];
    eventSelect.innerHTML = '';
    if(!list.length){ eventSelect.innerHTML = `<option value="">(no active events)</option>`; }
    else{
      list.forEach(ev=>{
        const o=document.createElement('option');
        o.value=ev.code;
        o.textContent=ev.name?`${ev.name} (${ev.code})`:ev.code;
        eventSelect.appendChild(o);
      });
    }
    // ensure URL param shows up even if not marked active
    if (PRESELECT_EVENT && !Array.from(eventSelect.options).some(o=>o.value===PRESELECT_EVENT)) {
      const extra=document.createElement('option');
      extra.value = PRESELECT_EVENT;
      extra.textContent = `${PRESELECT_EVENT} (from URL)`;
      eventSelect.appendChild(extra);
    }
    if (PRESELECT_EVENT && Array.from(eventSelect.options).some(o=>o.value===PRESELECT_EVENT)) {
      eventSelect.value = PRESELECT_EVENT;
    } else if (prev && Array.from(eventSelect.options).some(o=>o.value===prev)) {
      eventSelect.value = prev;
    } else if (!eventSelect.value && eventSelect.options.length) {
      eventSelect.selectedIndex = 0;
    }
  }catch{
    if (!eventSelect.options.length) eventSelect.innerHTML=`<option value="">(failed to load)</option>`;
  }
}

/* ----- Robust reader + client filter ----- */
async function fetchRequestsFor(code){
  const codeNorm = code.trim().toLowerCase();

  // Try several server-side filters first…
  const attempts = [
    `${ENDPOINT_URL}?mode=read&event=${encodeURIComponent(code)}&limit=2000`,
    `${ENDPOINT_URL}?mode=read&code=${encodeURIComponent(code)}&limit=2000`,
    `${ENDPOINT_URL}?mode=list&event=${encodeURIComponent(code)}&limit=2000`,
    `${ENDPOINT_URL}?mode=read_by_event&event=${encodeURIComponent(code)}&limit=2000`
  ];
  for (const u of attempts){
    try{
      const d = await jsonp(u);
      if (d && d.ok && Array.isArray(d.rows) && d.rows.length){
        // still normalize, just in case
        const rows = d.rows.filter(r => extractCode(r.event) === codeNorm);
        showDbg(`server-filter ok • ${rows.length} rows`);
        return rows;
      }
    }catch(_e){}
  }

  // Fallback: pull all and filter on client
  try{
    const d = await jsonp(`${ENDPOINT_URL}?mode=read&limit=5000`);
    if (d && d.ok && Array.isArray(d.rows)){
      const rows = d.rows;
      const filtered = rows.filter(r => extractCode(r.event) === codeNorm);
      showDbg(`client-filter (${rows.length}→${filtered.length})`);
      return filtered;
    }
  }catch(_e){}
  showDbg('no rows');
  return [];
}

/* ----- Refresh + played toggle ----- */
async function refresh(){
  const code = (eventSelect.value||'').trim();
  if(!code){ setStatus('Select an active event.'); return; }
  try{
    setStatus(`Reading event: ${code} …`);
    const rows = await fetchRequestsFor(code);
    renderLists(rows);
    setStatus(`Event: ${code} — updated ${new Date().toLocaleTimeString()}`);
  }catch{ setStatus('Fetch failed.'); }
}
async function setPlayed(id, played){
  if(!id) return;
  try{
    const res = await jsonp(`${ENDPOINT_URL}?mode=set_played&id=${encodeURIComponent(id)}&played=${played?1:0}`);
    if(res && res.ok){ refresh(); }
    else{ setStatus('Failed to update played state.'); }
  }catch{ setStatus('Network error while updating played.'); }
}

/* ----- Timers ----- */
let reqTimer=null, evTimer=null;
function startTimers(){
  if (reqTimer) clearInterval(reqTimer);
  if (evTimer)  clearInterval(evTimer);
  reqTimer = setInterval(refresh, 10000);
  evTimer  = setInterval(async ()=>{ await loadActiveEvents(); }, 30000);
}

btnRefresh.addEventListener('click', refresh);
eventSelect.addEventListener('change', ()=>{ refresh(); });

window.addEventListener('load', async ()=>{
  await loadActiveEvents();
  if(eventSelect.value) await refresh();
  startTimers();
});
</script>
</body>
</html>

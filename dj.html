<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<title>DCE • REQUESTS</title>
<style>
  :root{
    --bg:#1b1b1b;
    --panel:#2f2f2f;
    --panel-2:#3a3a3a;
    --border:#2b2b2b;
    --ink:#eaeaea;
    --muted:#cfcfcf;
    --accent:#1dcec9;   /* Mark as Played */
    --danger:#b22222;   /* Remove */
    --amber:#f7b731;    /* Mark as Unplayed (hidden in Requests) */
    --put:#d81b60;      /* Put Back */

    --radius:12px;
    --radius-sm:10px;
    --maxw:1100px;
  }

  @font-face{
    font-family:"Adventor";
    src:url("texgyreadventor-regular.otf") format("opentype");
    font-weight:400; font-style:normal; font-display:swap;
  }

  *{ box-sizing:border-box; }
  html,body{
    margin:0; background:var(--bg); color:var(--ink);
    font-family:"Adventor", system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
  }

  .wrap{ max-width:var(--maxw); margin:0 auto; padding:18px 14px 60px; }
  .logo{ text-align:center; margin:10px 0 6px; }
  .logo img{ max-width:min(240px,60vw); height:auto; }
  .title{
    text-align:center; margin:0 0 18px; letter-spacing:.06em; font-weight:800;
    font-size:clamp(22px,5.5vw,36px);
  }

  /* Top selector panel */
  .panel{
    background:#2d2d2d; border:1px solid var(--border); border-radius:var(--radius); padding:14px;
    margin-bottom:14px;
  }
  label{ display:block; font-size:14px; color:#c7c7c7; margin:0 0 6px; }
  select{
    width:100%; height:54px; border-radius:14px; border:1px solid #3a3a3a;
    background:#232323; color:#f3f3f3; font-size:15px; padding:0 14px;
  }
  .inline{ display:flex; align-items:center; gap:10px; margin-top:8px; }
  .dot{ width:14px; height:14px; border-radius:50%;
        border:2px solid #8a8a8a; border-top-color:#fff; animation:spin .8s linear infinite; }
  .dot.hide{ display:none; }
  @keyframes spin{ to{ transform:rotate(360deg); } }

  /* Main requests panel */
  .panel-req{
    background:#2d2d2d; border:1px solid var(--border); border-radius:var(--radius); padding:10px 10px 6px;
  }

  /* Section header (accordion) */
  .sec{
    background:#3b3b3b; border:1px solid var(--border); border-radius:var(--radius); margin-bottom:10px;
  }
  .sec-h{
    display:flex; align-items:center; justify-content:space-between; gap:10px;
    padding:10px 12px; cursor:pointer;
  }
  .sec-t{ font-size:16px; font-weight:700; }
  .chev{ width:26px; height:26px; border-radius:8px; background:#2a2a2a; border:1px solid #424242; color:#eaeaea; display:grid; place-items:center; }
  .sec-body{ display:none; padding:10px; border-top:1px solid #3e3e3e; background:#353535; border-bottom-left-radius:12px; border-bottom-right-radius:12px; }
  .sec.open .sec-body{ display:block; }

  /* Request card row */
  .row{
    display:grid; grid-template-columns:72px 1fr 110px; gap:10px;
    align-items:center; border:1px solid #3d3d3d; background:#2a2a2a; border-radius:12px; padding:8px; margin-bottom:8px;
  }
  .cover{ width:72px; height:72px; border-radius:10px; overflow:hidden; background:#1f1f1f; display:grid; place-items:center; }
  .cover img{ width:100%; height:100%; object-fit:cover; display:block; }
  .mid .title{ margin:0; font-size:15px; font-weight:800; color:#fff; }
  .mid .artist{ margin:2px 0 0; color:#e6e6e6; font-size:13px; }
  .reqline{ display:flex; align-items:center; gap:8px; color:#ddd; font-size:13px; margin-top:4px; }
  .reqline .caret{ width:14px; height:14px; display:inline-grid; place-items:center; background:#2a2a2a; border:1px solid #444; border-radius:4px; font-size:11px; }
  .names{ display:none; margin-top:6px; background:#3a3a3a; border:1px solid #424242; border-radius:10px; padding:8px; color:#f7f7f7; font-size:13px; }
  .names.show{ display:block; }
  .names .hdr{ margin:0 0 4px; color:#d7d7d7; font-size:12px; }
  .names ul{ margin:0; padding-left:16px; }

  .actions{ display:grid; gap:6px; align-self:start; }
  .btn{
    display:inline-flex; align-items:center; justify-content:center; gap:6px;
    height:34px; padding:0 12px; border-radius:10px; border:1px solid transparent; cursor:pointer;
    box-shadow:0 2px 0 rgba(0,0,0,.35), 0 8px 14px rgba(0,0,0,.15);
    font-size:12px; line-height:1; font-weight:700;
  }
  .btn.play { background:var(--accent); border-color:var(--accent); color:#001d1c; }
  .btn.remove{ background:var(--danger); border-color:var(--danger); color:#fff; }
  .btn.unplay{ background:var(--amber); border-color:var(--amber); color:#000; }
  .btn.put{ background:var(--put); border-color:var(--put); color:#fff; }
  .btn[disabled]{ opacity:.7; cursor:not-allowed; }

  .hint{ color:#fff; font-size:12px; padding:10px 12px 14px; }
</style>
</head>
<body>
  <div class="wrap">
    <div class="logo">
      <img src="assets/dce-logo.png" alt="David Charles Events" onerror="this.style.display='none'">
    </div>
    <div class="title">REQUESTS</div>

    <!-- Event selector -->
    <div class="panel">
      <label for="eventSel">Select Your Event</label>
      <select id="eventSel"></select>
      <div class="inline">
        <div id="spin" class="dot hide" aria-hidden="true"></div>
      </div>
    </div>

    <!-- Requests / Played / Removed accordions -->
    <div class="panel-req">

      <section id="sec-requests" class="sec open">
        <div class="sec-h">
          <div class="sec-t">Requests <span id="countReq" style="opacity:.7;font-weight:400;"></span></div>
          <div class="chev">▾</div>
        </div>
        <div class="sec-body">
          <div id="requests"></div>
        </div>
      </section>

      <section id="sec-played" class="sec">
        <div class="sec-h">
          <div class="sec-t">Played Songs <span id="countPlayed" style="opacity:.7;font-weight:400;"></span></div>
          <div class="chev">▸</div>
        </div>
        <div class="sec-body">
          <div id="played"></div>
        </div>
      </section>

      <section id="sec-removed" class="sec">
        <div class="sec-h">
          <div class="sec-t">Removed Songs <span id="countRemoved" style="opacity:.7;font-weight:400;"></span></div>
          <div class="chev">▸</div>
        </div>
        <div class="sec-body">
          <div id="removed"></div>
        </div>
      </section>

      <div class="hint">Click a song to see requesters. Use buttons to mark Played / Unplayed or Remove / Put Back.</div>
    </div>
  </div>

<script>
/* ===== Config ===== */
const ENDPOINT_URL = 'https://script.google.com/macros/s/AKfycbxaN-0GQmvwy3G9GKD4hqZ1D6mjrIbBNDZZW-uGbuHIpiVTQ0BtOkmlQzSqjU6yjkmJ-g/exec';
const SPOTIFY_HELPER_URL = ''; // reserved for later linking
const POLL_MS = 5000;

/* ===== Elements ===== */
const eventSel = document.getElementById('eventSel');
const spin = document.getElementById('spin');
const requestsEl = document.getElementById('requests');
const playedEl = document.getElementById('played');
const removedEl = document.getElementById('removed');
const countReq = document.getElementById('countReq');
const countPlayed = document.getElementById('countPlayed');
const countRemoved = document.getElementById('countRemoved');

/* ===== State ===== */
let currentCode = '';
let pollTimer = null;
let initialLoaded = false;

let EVENT_PROVIDER = 'apple';
let EVENT_MARKET = 'US';
let EXPLICIT_ALLOWED = true;

/* ===== Helpers ===== */
function pad2(n){return String(n).padStart(2,'0');}
function dow3(n){return ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'][n]||'';}
function formatHeaderDate(s){ const d=new Date(s); if(isNaN(d))return''; return `${dow3(d.getDay())} ${pad2(d.getMonth()+1)}.${pad2(d.getDate())}.${String(d.getFullYear()).slice(-2)}`;}
function keySong(song,artist){ return `${(song||'').toLowerCase()}|${(artist||'').toLowerCase()}`;}
function jsonp(url,params={}){ const qs=new URLSearchParams(params); const cb='cb_'+Math.random().toString(36).slice(2); qs.set('callback',cb); qs.set('t',Date.now());
  return new Promise((res,rej)=>{ const s=document.createElement('script'); s.src=url+(url.includes('?')?'&':'?')+qs.toString();
    const kill=setTimeout(()=>{cleanup(); rej(new Error('timeout'));},9000);
    function cleanup(){clearTimeout(kill); try{delete window[cb];}catch{} s.remove();}
    window[cb]=(d)=>{cleanup(); res(d);}; s.onerror=()=>{cleanup(); rej(new Error('jsonp'));}; document.body.appendChild(s);
  });
}
function showSpin(on){ spin.classList.toggle('hide', !on); }
function toggleSec(sec){
  const isOpen = sec.classList.contains('open');
  sec.classList.toggle('open', !isOpen);
  sec.querySelector('.chev').textContent = isOpen ? '▸' : '▾';
}

/* ===== Event config ===== */
async function loadEventConfig(code){
  EVENT_PROVIDER='apple'; EVENT_MARKET='US'; EXPLICIT_ALLOWED=true;
  try{
    const r=await jsonp(ENDPOINT_URL,{mode:'getEventConfig', event:code});
    if(r && r.ok && r.config){
      EVENT_PROVIDER = (r.config.provider||'apple').toLowerCase();
      EVENT_MARKET = (r.config.market||'US').toUpperCase();
      EXPLICIT_ALLOWED = !!r.config.explicitAllowed;
    }
  }catch{}
}

/* ===== Active events ===== */
async function loadActiveEvents(){
  showSpin(true);
  try{
    const r=await jsonp(ENDPOINT_URL,{mode:'listActive'});
    const list=Array.isArray(r?.events)?r.events:[];
    list.sort((a,b)=>new Date(a.date||0)-new Date(b.date||0));
    eventSel.innerHTML='';
    if(!list.length){
      const opt=document.createElement('option'); opt.value=''; opt.textContent='No active events';
      eventSel.appendChild(opt); showSpin(false); return;
    }
    for(const ev of list){
      const opt=document.createElement('option'); opt.value=ev.code;
      const d=formatHeaderDate(ev.date);
      opt.textContent=d?`${d} - ${ev.name}`:(ev.name||ev.code);
      eventSel.appendChild(opt);
    }
    const pre=(new URLSearchParams(location.search).get('event')||'').trim();
    if(pre && Array.from(eventSel.options).some(o=>o.value===pre)) eventSel.value=pre;
    currentCode=eventSel.value||'';
  }catch{}
  showSpin(false);
}

/* ===== Fetch rows ===== */
async function fetchRows({background=false} = {}){
  if(!currentCode) return;
  if (!background) showSpin(true);
  try{
    const r=await jsonp(ENDPOINT_URL,{mode:'read', event:currentCode});
    const raw=Array.isArray(r?.rows)?r.rows:[];
    renderBuckets(raw);
    initialLoaded = true;
  }catch{} finally{
    if (!background) showSpin(false);
  }
}
function startPolling(){ stopPolling(); pollTimer=setInterval(()=>fetchRows({background:true}), POLL_MS); }
function stopPolling(){ if(pollTimer) clearInterval(pollTimer); pollTimer=null; }

/* ===== Split into buckets ===== */
function splitBuckets(rows){
  const requestsMap=new Map(), playedMap=new Map(), removedMap=new Map();

  for(const row of rows){
    const song=row.song_title||row.song||''; const artist=row.artist||''; const k=keySong(song,artist);
    // "removed" not tracked in sheet right now (future), keep empty bucket for parity
    if(row.played){
      let g=playedMap.get(k); if(!g){ g={song,artist,ids:[],names:new Set()}; playedMap.set(k,g); }
      g.ids.push(row.id); if(row.name) g.names.add(row.name);
    }else{
      let g=requestsMap.get(k); if(!g){ g={song,artist,ids:[],names:new Set()}; requestsMap.set(k,g); }
      g.ids.push(row.id); if(row.name) g.names.add(row.name);
    }
  }

  const toArr = m => Array.from(m.values()).map(g=>({song:g.song,artist:g.artist,ids:g.ids,names:Array.from(g.names),count:g.ids.length}));
  return {
    requests: toArr(requestsMap).sort((a,b)=> a.song.localeCompare(b.song)),
    played:   toArr(playedMap).sort((a,b)=> a.song.localeCompare(b.song)),
    removed:  toArr(removedMap)
  };
}

/* ===== Row UI ===== */
function nameBlock(list){
  const box=document.createElement('div'); box.className='names';
  const h=document.createElement('p'); h.className='hdr'; h.textContent='Requested by:'; box.appendChild(h);
  const ul=document.createElement('ul');
  for(const n of list){ const li=document.createElement('li'); li.textContent=n; ul.appendChild(li); }
  box.appendChild(ul);
  return box;
}

function rowCard(item, mode){
  const el=document.createElement('div'); el.className='row';
  const cover=document.createElement('div'); cover.className='cover'; cover.textContent='♪'; el.appendChild(cover);

  const mid=document.createElement('div'); mid.className='mid';
  const t=document.createElement('p'); t.className='title'; t.textContent=item.song||''; mid.appendChild(t);
  const a=document.createElement('p'); a.className='artist'; a.textContent=item.artist||''; mid.appendChild(a);
  const req=document.createElement('div'); req.className='reqline';
  const caret=document.createElement('span'); caret.className='caret'; caret.textContent='▸';
  const txt=document.createElement('span'); txt.textContent = `${item.count} request${item.count>1?'s':''}`;
  req.append(caret, txt);
  const names=nameBlock(item.names);
  req.addEventListener('click', ()=>{ const on=names.classList.toggle('show'); caret.textContent = on ? '▾' : '▸'; });
  mid.append(req, names);
  el.appendChild(mid);

  const actions=document.createElement('div'); actions.className='actions';
  if (mode==='requests'){
    const playedBtn=document.createElement('button'); playedBtn.className='btn play'; playedBtn.textContent='Mark as Played';
    const removeBtn=document.createElement('button'); removeBtn.className='btn remove'; removeBtn.textContent='Remove';
    playedBtn.onclick=()=> togglePlayed(item.ids, true, playedBtn, removeBtn);
    removeBtn.onclick=()=> togglePlayed(item.ids, true, removeBtn, playedBtn); // until we add a "removed" column, treat Remove as Played or you can change behavior later
    actions.append(playedBtn, removeBtn);
  }else if (mode==='played'){
    const unBtn=document.createElement('button'); unBtn.className='btn unplay'; unBtn.textContent='Mark Unplayed';
    unBtn.onclick=()=> togglePlayed(item.ids, false, unBtn, unBtn);
    actions.append(unBtn);
  }else if (mode==='removed'){
    const putBtn=document.createElement('button'); putBtn.className='btn put'; putBtn.textContent='Put Back';
    putBtn.onclick=()=> togglePlayed(item.ids, false, putBtn, putBtn);
    actions.append(putBtn);
  }
  el.appendChild(actions);

  return el;
}

/* ===== Render buckets ===== */
function renderBuckets(rows){
  const {requests, played, removed} = splitBuckets(rows);
  requestsEl.innerHTML=''; playedEl.innerHTML=''; removedEl.innerHTML='';
  for(const it of requests){ requestsEl.appendChild(rowCard(it, 'requests')); }
  for(const it of played){   playedEl.appendChild(rowCard(it, 'played')); }
  for(const it of removed){  removedEl.appendChild(rowCard(it, 'removed')); }
  countReq.textContent = `(${requests.length})`;
  countPlayed.textContent = `(${played.length})`;
  countRemoved.textContent = `(${removed.length})`;
}

/* ===== Played toggle ===== */
async function togglePlayed(ids, val, btnA, btnB){
  btnA.disabled=true; if(btnB) btnB.disabled=true;
  try{
    for(const id of ids){
      await jsonp(ENDPOINT_URL, {mode:'setPlayed', id, played: val?'true':'false'});
    }
    await fetchRows({background:false});
  }finally{
    btnA.disabled=false; if(btnB) btnB.disabled=false;
  }
}

/* ===== Events init ===== */
document.getElementById('sec-requests').querySelector('.sec-h').addEventListener('click', e=> toggleSec(document.getElementById('sec-requests')));
document.getElementById('sec-played').querySelector('.sec-h').addEventListener('click', e=> toggleSec(document.getElementById('sec-played')));
document.getElementById('sec-removed').querySelector('.sec-h').addEventListener('click', e=> toggleSec(document.getElementById('sec-removed')));

eventSel.addEventListener('change', async ()=>{
  currentCode = eventSel.value||'';
  if (!currentCode) return;
  showSpin(true);
  await loadEventConfig(currentCode);
  await fetchRows({background:false});
  showSpin(false);
  startPolling();
});

/* ===== Bootstrap ===== */
(async ()=>{
  await loadActiveEvents();
  if (eventSel.value){
    currentCode = eventSel.value;
    await loadEventConfig(currentCode);
    await fetchRows({background:false});
    startPolling();
  }
})();
</script>
</body>
</html>
